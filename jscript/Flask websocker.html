<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修Flask websocker' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Flask websocker</center></div><div class='banquan'>原文出处:本文由博客园博主Python小白森提供。<br/>
原文连接:https://www.cnblogs.com/py-web/p/12016495.html</div><br>
    <p><span style="color:#5b9bd5"><strong>群聊版
</strong></span></p><p>安装
</p><p style="background: white"><pre><code><code><span style="color:black; font-family:Consolas; font-size:9pt">pip install gevent-websocket  
</span></code></pre></p><p style="background: white">
 </p><p>视图
</p><ol><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt"># -*- coding: utf-8 -*-  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">import json  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">from flask import Flask, request, render_template  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">from geventwebsocket.handler import WebSocketHandler  # </span><span style="font-family:宋体">导入</span><span style="font-family:Consolas">websocker</span><span style="font-family:宋体">的方法</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">from gevent.pywsgi import WSGIServer  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:red; font-family:Consolas; font-size:9pt">app<span style="color:black"> = <span style="color:blue">Flask<span style="color:black">(__name__)  <span style="color:#5c5c5c">
								</span></span></span></span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:red; font-size:9pt"><span style="font-family:Consolas">user_socker_list<span style="color:black"> = []  # </span></span><span style="font-family:宋体">保存所有的</span><span style="color:black"><span style="font-family:Consolas">websocker</span><span style="font-family:宋体">对象</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">@app.route('/ws')  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">def ws():  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    # print(request.headers)  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:red">user_socker<span style="color:black"> = <span style="color:blue">request<span style="color:black">.environ.get('wsgi.websocket')  # type  WebSocket  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    """  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">    readyState: 3  </span><span style="font-family:宋体">连接正常，然后断开</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">    readyState: 1  </span><span style="font-family:宋体">表示正常连接</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    """  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    if user_socker:  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        user_socker_list.append(user_socker)  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        while 1:  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">            <span style="color:red">msg<span style="color:black"> = <span style="color:blue">user_socker<span style="color:black">.receive()  # </span></span></span></span></span><span style="font-family:宋体">接收消息</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">            print(msg)  # </span><span style="font-family:宋体">接受完信息后断开，所有加循环变成长连接</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">            for u_socker in user_socker_list:  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">                if <span style="color:red">u_socker<span style="color:black"> == user_socker:  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">                    continue  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">                try:  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">                    u_socker.send(msg)  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">                except:  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">                    continue  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    return render_template('ws.html')  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">if <span style="color:red">__name__<span style="color:black"> == '__main__':  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    # app.run(<span style="color:red">host<span style="color:black">=<span style="color:blue">'0.0.0.'<span style="color:black">, <span style="color:red">debug<span style="color:black">=<span style="color:blue">True<span style="color:black">)  <span style="color:#5c5c5c">
													</span></span></span></span></span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:red">http_serv<span style="color:black"> = <span style="color:blue">WSGIServer<span style="color:black">(('0.0.0.0', 5000), app, <span style="color:red">handler_class<span style="color:black">=<span style="color:blue">WebSocketHandler<span style="color:black">)  <span style="color:#5c5c5c">
													</span></span></span></span></span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    http_serv.serve_forever()  <span style="color:#5c5c5c">
					</span></span></div></li></ol><p>
 </p><p>前端
</p><ol><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">&lt;!DOCTYPE html<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;html</strong><span style="color:black"> <span style="color:red">lang<span style="color:black">=<span style="color:blue">"en"<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
											</span></span></span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;head&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>&lt;meta</strong><span style="color:black"> <span style="color:red">charset<span style="color:black">=<span style="color:blue">"UTF-8"<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
												</span></span></span></span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>&lt;title&gt;</strong><span style="color:black">ws<span style="color:#006699"><strong>&lt;/title&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;/head&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;body&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-size:9pt"><span style="font-family:Consolas"><strong>&lt;input</strong><span style="color:black"> <span style="color:red">type<span style="color:black">=<span style="color:blue">"text"<span style="color:black"> <span style="color:red">id<span style="color:black">=<span style="color:blue">"msg"<span style="color:#006699"><strong>&gt;</strong><span style="color:black"> <span style="color:#006699"><strong>&lt;button</strong><span style="color:black"> <span style="color:red">onclick<span style="color:black">=<span style="color:blue">"snd_msm()"<span style="color:#006699"><strong>&gt;</strong></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="color:black"><span style="font-family:宋体">发送</span><span style="color:#006699; font-family:Consolas"><strong>&lt;/button&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
								</span></span></span></span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;div</strong><span style="color:black"> <span style="color:red">id<span style="color:black">=<span style="color:blue">"chat_list"<span style="color:black"> <span style="color:red">style<span style="color:black">=<span style="color:blue">"width: 500px; height: 500px;"<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
															</span></span></span></span></span></span></span></span></span></span></span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;/div&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;/body&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;script</strong><span style="color:black"> <span style="color:red">type<span style="color:black">=<span style="color:blue">"application/javascript"<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
											</span></span></span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">    var <span style="color:red">ws<span style="color:black"> = <span style="color:blue">new<span style="color:black"> WebSocket('ws://192.168.32.71:5000/ws');  {# </span></span></span></span></span><span style="font-family:宋体">设置</span><span style="font-family:Consolas">websocker</span><span style="font-family:宋体">连接</span><span style="font-family:Consolas"> #}  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:red">ws.onmessage<span style="color:black"> = <span style="color:blue">function<span style="color:black"> (data) {  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">        console.log(data.data);  {# </span><span style="font-family:宋体">数据在</span><span style="font-family:Consolas">data</span><span style="font-family:宋体">。</span><span style="font-family:Consolas">data</span><span style="font-family:宋体">里面</span><span style="font-family:Consolas"> #}  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        var <span style="color:red">ptag<span style="color:black"> = <span style="color:blue">document<span style="color:black">.createElement('p');  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        <span style="color:red">ptag.innerText<span style="color:black"> = <span style="color:blue">data<span style="color:black">.data;  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        document.getElementById('chat_list').appendChild(ptag)  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">    }; {# </span><span style="font-family:宋体">打印收到的数据</span><span style="font-family:Consolas"> #}  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white">      
 </div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    function snd_msm() {  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        var <span style="color:red">msg<span style="color:black"> = <span style="color:blue">document<span style="color:black">.getElementById('msg').value;  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        ws.send(msg)  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    }  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;/script&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;/html&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li></ol><p>
 </p><p><span style="color:#5b9bd5"><strong>一对一单机版
</strong></span></p><p>视图
</p><ol><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt"># -*- coding: utf-8 -*-  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">import json  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">from flask import Flask, request, render_template  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">from geventwebsocket.handler import WebSocketHandler  # </span><span style="font-family:宋体">导入</span><span style="font-family:Consolas">websocker</span><span style="font-family:宋体">的方法</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">from gevent.pywsgi import WSGIServer  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:red; font-family:Consolas; font-size:9pt">app<span style="color:black"> = <span style="color:blue">Flask<span style="color:black">(__name__)  <span style="color:#5c5c5c">
								</span></span></span></span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:red; font-size:9pt"><span style="font-family:Consolas">user_socker_dict<span style="color:black"> = {}  # </span></span><span style="font-family:宋体">这里仿照</span><span style="color:black"><span style="font-family:Consolas">flask</span><span style="font-family:宋体">上下文的方式</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">"""  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:宋体">借用</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">flask </span><span style="font-family:宋体">上下文</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">{  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">"</span><span style="font-family:宋体">线程</span><span style="font-family:Consolas">id": </span><span style="font-family:宋体">偏函数</span><span style="font-family:Consolas">,  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">"</span><span style="font-family:宋体">线程</span><span style="font-family:Consolas">id": </span><span style="font-family:宋体">偏函数</span><span style="font-family:Consolas">,  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">}  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">"""  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">@app.route('/ws2/<span style="color:#006699"><strong>&lt;usename&gt;</strong><span style="color:black">')  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">def ws2(usename):  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    # print(request.headers)  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:red">user_socker<span style="color:black"> = <span style="color:blue">request<span style="color:black">.environ.get('wsgi.websocket')  # type  WebSocket  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    """  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">    readyState: 3  </span><span style="font-family:宋体">连接正常，然后断开</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">    readyState: 1  </span><span style="font-family:宋体">表示正常连接</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    """  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    print(user_socker)  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    if user_socker:  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        user_socker_dict[usename] = user_socker  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        print(user_socker_dict)  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        while 1:  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">            <span style="color:red">msg<span style="color:black"> = <span style="color:blue">user_socker<span style="color:black">.receive()  # </span></span></span></span></span><span style="font-family:宋体">接收人，消息，发送人</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">            <span style="color:red">msg_dict<span style="color:black"> = <span style="color:blue">json<span style="color:black">.loads(msg)  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">            msg_dict['from_user'] = usename  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">            <span style="color:red">to_user<span style="color:black"> = <span style="color:blue">msg_dict<span style="color:black">.get('to_user')  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">            <span style="color:red">u_socker<span style="color:black"> = <span style="color:blue">user_socker_dict<span style="color:black">.get(to_user)  # type  WebSocket  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">            u_socker.send(json.dumps(msg_dict))  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    return render_template('ws2.html')  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">if <span style="color:red">__name__<span style="color:black"> == '__main__':  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    # app.run(<span style="color:red">host<span style="color:black">=<span style="color:blue">'0.0.0.'<span style="color:black">, <span style="color:red">debug<span style="color:black">=<span style="color:blue">True<span style="color:black">)  <span style="color:#5c5c5c">
													</span></span></span></span></span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:red">http_serv<span style="color:black"> = <span style="color:blue">WSGIServer<span style="color:black">(('0.0.0.0', 5000), app, <span style="color:red">handler_class<span style="color:black">=<span style="color:blue">WebSocketHandler<span style="color:black">)  <span style="color:#5c5c5c">
													</span></span></span></span></span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    http_serv.serve_forever()  <span style="color:#5c5c5c">
					</span></span></div></li></ol><p>
 </p><p>前端
</p><ol><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">&lt;!DOCTYPE html<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;html</strong><span style="color:black"> <span style="color:red">lang<span style="color:black">=<span style="color:blue">"en"<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
											</span></span></span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;head&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>&lt;meta</strong><span style="color:black"> <span style="color:red">charset<span style="color:black">=<span style="color:blue">"UTF-8"<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
												</span></span></span></span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>&lt;title&gt;</strong><span style="color:black">ws<span style="color:#006699"><strong>&lt;/title&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;/head&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;body&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-size:9pt"><span style="font-family:Consolas"><strong>&lt;input</strong><span style="color:black"> <span style="color:red">type<span style="color:black">=<span style="color:blue">"text"<span style="color:black"> <span style="color:red">id<span style="color:black">=<span style="color:blue">"username"<span style="color:#006699"><strong>&gt;</strong><span style="color:black"> <span style="color:#006699"><strong>&lt;button</strong><span style="color:black"> <span style="color:red">onclick<span style="color:black">=<span style="color:blue">"login()"<span style="color:#006699"><strong>&gt;</strong></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="color:black"><span style="font-family:宋体">登陆聊天室</span><span style="color:#006699; font-family:Consolas"><strong>&lt;/button&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
								</span></span></span></span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:宋体">给</span><span style="color:#006699"><span style="font-family:Consolas"><strong>&lt;input</strong><span style="color:black"> <span style="color:red">type<span style="color:black">=<span style="color:blue">"text"<span style="color:black"> <span style="color:red">id<span style="color:black">=<span style="color:blue">"to_user"<span style="color:#006699"><strong>&gt;</strong></span></span></span></span></span></span></span></span></span></span><span style="color:black"><span style="font-family:宋体">发送</span><span style="font-family:Consolas">:<span style="color:#006699"><strong>&lt;input</strong><span style="color:black"> <span style="color:red">type<span style="color:black">=<span style="color:blue">"text"<span style="color:black"> <span style="color:red">id<span style="color:black">=<span style="color:blue">"msg"<span style="color:#006699"><strong>&gt;</strong><span style="color:black"> <span style="color:#006699"><strong>&lt;button</strong><span style="color:black"> <span style="color:red">onclick<span style="color:black">=<span style="color:blue">"snd_msm()"<span style="color:#006699"><strong>&gt;</strong></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="color:black"><span style="font-family:宋体">发送</span><span style="color:#006699; font-family:Consolas"><strong>&lt;/button&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
										</span></span></span></span></span></span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;div</strong><span style="color:black"> <span style="color:red">id<span style="color:black">=<span style="color:blue">"chat_list"<span style="color:black"> <span style="color:red">style<span style="color:black">=<span style="color:blue">"width: 500px; height: 500px;"<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
															</span></span></span></span></span></span></span></span></span></span></span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;/div&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;/body&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;script</strong><span style="color:black"> <span style="color:red">type<span style="color:black">=<span style="color:blue">"application/javascript"<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
											</span></span></span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">    var <span style="color:red">ws<span style="color:black"> = <span style="color:blue">null<span style="color:black">;  {# </span></span></span></span></span><span style="font-family:宋体">为什么设置</span><span style="font-family:Consolas">null, </span><span style="font-family:宋体">被其他函数执行</span><span style="font-family:Consolas"> #}  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    function login() {  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        var <span style="color:red">username<span style="color:black"> = <span style="color:blue">document<span style="color:black">.getElementById('username').value;  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">        <span style="color:red">ws<span style="color:black"> = <span style="color:blue">new<span style="color:black"> WebSocket('ws://192.168.32.71:5000/ws2/' + username);  {# </span></span></span></span></span><span style="font-family:宋体">设置</span><span style="font-family:Consolas">websocker</span><span style="font-family:宋体">连接</span><span style="font-family:Consolas"> #}  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        <span style="color:red">ws.onmessage<span style="color:black"> = <span style="color:blue">function<span style="color:black"> (data) {  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">            var <span style="color:red">recv_msg<span style="color:black"> = <span style="color:blue">JSON<span style="color:black">.parse(data.data);  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">            var <span style="color:red">ptag<span style="color:black"> = <span style="color:blue">document<span style="color:black">.createElement('p');  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">            <span style="color:red">ptag.innerText<span style="color:black"> = <span style="color:blue">recv_msg<span style="color:black">.from_user + ":" + recv_msg.msg;  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">            document.getElementById('chat_list').appendChild(ptag)  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">        }; {# </span><span style="font-family:宋体">打印收到的数据</span><span style="font-family:Consolas"> #}  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    }  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    function snd_msm() {  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        var <span style="color:red">to_user<span style="color:black"> = <span style="color:blue">document<span style="color:black">.getElementById('to_user').value;  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        var <span style="color:red">msg<span style="color:black"> = <span style="color:blue">document<span style="color:black">.getElementById('msg').value;  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        <span style="color:red">send_msg<span style="color:black"> = {  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">            "to_user" : to_user,  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">            "msg": msg  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        };  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        ws.send(JSON.stringify(send_msg));  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    }  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;/script&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;/html&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li></ol><p>
 </p><p><span style="color:#5b9bd5"><strong>Websocker
</strong></span></p><p>视图
</p><ol><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">import time  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">from django.shortcuts import render  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">from dwebsocket.decorators import accept_websocket  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">@accept_websocket  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">def test(request):  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    if request.is_websocket():  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        print('websocket connection....')  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">        <span style="color:red">msg<span style="color:black"> = <span style="color:blue">request<span style="color:black">.websocket.wait()  # </span></span></span></span></span><span style="font-family:宋体">接收前端发来的消息</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        print(msg, type(msg), json.loads(msg))  # b'["1","2","3"]' <span style="color:#006699"><strong>&lt;class</strong><span style="color:black"> 'bytes'<span style="color:#006699"><strong>&gt;</strong><span style="color:black"> ['1', '2', '3']  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        while 1:  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">            if msg:  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">                # </span><span style="font-family:宋体">你要返回的结果</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">                for i in range(10):  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">                    request.websocket.send(str(i).encode())  # </span><span style="font-family:宋体">向客户端发送数据</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">                request.websocket.close()  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">    else:  # </span><span style="font-family:宋体">如果是普通的请求返回页面</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        return render(request, 'test.html')  <span style="color:#5c5c5c">
					</span></span></div></li></ol><p>前端
</p><ol><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">&lt;!DOCTYPE html<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;html</strong><span style="color:black"> <span style="color:red">lang<span style="color:black">=<span style="color:blue">"en"<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
											</span></span></span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;head&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>&lt;meta</strong><span style="color:black"> <span style="color:red">charset<span style="color:black">=<span style="color:blue">"UTF-8"<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
												</span></span></span></span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>&lt;meta</strong><span style="color:black"> <span style="color:red">http-equiv<span style="color:black">=<span style="color:blue">"x-ua-compatible"<span style="color:black"> <span style="color:red">content<span style="color:black">=<span style="color:blue">"IE=edge"<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
																</span></span></span></span></span></span></span></span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>&lt;meta</strong><span style="color:black"> <span style="color:red">name<span style="color:black">=<span style="color:blue">"viewport"<span style="color:black"> <span style="color:red">content<span style="color:black">=<span style="color:blue">"width=device-width, initial-scale=1"<span style="color:#006699"><strong>&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
																</span></span></span></span></span></span></span></span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>&lt;title&gt;</strong><span style="color:black">test<span style="color:#006699"><strong>&lt;/title&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;/head&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;body&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;div&gt;&lt;/div&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;/body&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;input</strong><span style="color:black"> <span style="color:red">type<span style="color:black">=<span style="color:blue">"text"<span style="color:black"> <span style="color:red">id<span style="color:black">=<span style="color:blue">"message"<span style="color:black"> <span style="color:red">value<span style="color:black">=<span style="color:blue">"Hello, World!"<span style="color:#006699"><strong>/&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
																			</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-size:9pt"><span style="font-family:Consolas"><strong>&lt;button</strong><span style="color:black"> <span style="color:red">type<span style="color:black">=<span style="color:blue">"button"<span style="color:black"> <span style="color:red">id<span style="color:black">=<span style="color:blue">"send_message"<span style="color:#006699"><strong>&gt;</strong></span></span></span></span></span></span></span></span></span></span><span style="color:black"><span style="font-family:宋体">发送</span><span style="font-family:Consolas"> message<span style="color:#006699"><strong>&lt;/button&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white">  
 </div></li><li><div style="background: #f8f8f8"><span style="color:#008200; font-size:9pt"><span style="font-family:Consolas">&lt;!-- </span><span style="font-family:宋体">首先引入</span><span style="font-family:Consolas"> jQuery --&gt;<span style="color:black">  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;script</strong><span style="color:black"> <span style="color:red">src<span style="color:black">=<span style="color:blue">"https://cdn.bootcss.com/jquery/3.4.1/jquery.js"<span style="color:#006699"><strong>&gt;&lt;/script&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
											</span></span></span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;script&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">    // </span><span style="font-family:宋体">判断浏览器是否支持</span><span style="font-family:Consolas">WebSocket</span><span style="font-family:宋体">，目前应该所有的浏览器都支持了</span><span style="font-family:Consolas">.....  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    if ('WebSocket' in window) {  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">        console.log('</span><span style="font-family:宋体">你的浏览器支持</span><span style="font-family:Consolas"> WebSocket')  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    }  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    $('#send_message').click(function () {  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">        // </span><span style="font-family:宋体">创建一个</span><span style="font-family:Consolas">WebSocket</span><span style="font-family:宋体">对象：</span><span style="font-family:Consolas">sk</span><span style="font-family:宋体">，并且建立与服务端的连接（服务端程序要跑着哦）</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        var <span style="color:red">sk<span style="color:black"> = <span style="color:blue">new<span style="color:black"> WebSocket('ws://' + window.location.host + '/asset/test/');  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">        // </span><span style="font-family:宋体">向服务端发送消息</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        <span style="color:red">sk.onopen<span style="color:black"> = <span style="color:blue">function<span style="color:black"> () {  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">            console.log('websocket connection successful...');  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">            var <span style="color:red">datas<span style="color:black"> = $('#message').val();  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">            sk.send(JSON.stringify(datas));  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        };  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">        // </span><span style="font-family:宋体">接收服务端的消息，主要的业务逻辑也在这里完成</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        <span style="color:red">sk.onmessage<span style="color:black"> = <span style="color:blue">function<span style="color:black"> (msg) {  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">            // </span><span style="font-family:宋体">业务逻辑</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">            <span style="color:red">html<span style="color:black"> = <span style="color:blue">"&lt;p&gt;"<span style="color:black"> + msg.data + "<span style="color:#006699"><strong>&lt;/p&gt;</strong><span style="color:black">";  <span style="color:#5c5c5c">
											</span></span></span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">            $("div").append(html);  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">            console.log('from service message: ', msg.data);  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">            // </span><span style="font-family:宋体">由于服务端主动断开连接，这里也断开</span><span style="font-family:Consolas">WebSocket</span><span style="font-family:宋体">连接</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">            if (<span style="color:red">sk.readyState<span style="color:black"> == WebSocket.CLOSED) sk.close();  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        };  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">        // </span><span style="font-family:宋体">完事就关闭</span><span style="font-family:Consolas">WebSocket</span><span style="font-family:宋体">连接</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        <span style="color:red">sk.onclose<span style="color:black"> = <span style="color:blue">function<span style="color:black"> (msg) {  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">            console.log('websocket connection close...');  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">            sk.close()  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        };  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">        // </span><span style="font-family:宋体">当</span><span style="font-family:Consolas">WebSocket</span><span style="font-family:宋体">连接创建成功后，我们就可以向服务端发送数据了</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        if (<span style="color:red">sk.readyState<span style="color:black"> == WebSocket.OPEN) sk.onopen();  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    });  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8">  
 </div></li><li><div style="background: white"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;/script&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>&lt;/html&gt;</strong><span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li></ol>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>