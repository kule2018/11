<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='ç”µè„‘,ç”µè„‘è®²è§£,ç”µè„‘æŠ€æœ¯,ç¼–ç¨‹,ç”µè„‘æ•…éšœç»´ä¿®React ç»ƒä¹ é¡¹ç›®ï¼Œä»¿ç®€ä¹¦åšå®¢å†™ä½œå¹³å°' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>é¦–é¡µ</a></li>
</div><div onclick='hidden1()' >åˆ†äº«</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>React ç»ƒä¹ é¡¹ç›®ï¼Œä»¿ç®€ä¹¦åšå®¢å†™ä½œå¹³å°</center></div><div class='banquan'>åŸæ–‡å‡ºå¤„:æœ¬æ–‡ç”±åšå®¢å›­åšä¸»freedomé›²æä¾›ã€‚<br/>
åŸæ–‡è¿æ¥:https://www.cnblogs.com/cmk1018/p/11347506.html</div><br>
    <h1 id="introduction">Introduction</h1>
<p>æŠ€æœ¯æ ˆï¼šreact + redux + react-router + express + Nginx</p>
<p>ç»ƒä¹ ç‚¹ï¼š</p>
<ul>
<li>redux è¿æ¥</li>
<li>react-router è·¯ç”±è·³è½¬</li>
<li>scss æ ·å¼ä¹¦å†™</li>
<li>å®¹å™¨ç»„ä»¶ä¸å±•ç¤ºç»„ä»¶çš„è®¾è®¡</li>
<li>express è„šæ‰‹æ¶é¡¹ç›®ç»“æ„è®¾è®¡</li>
<li>ç”¨æˆ·ä¿¡æ¯æŒä¹…åŒ–ï¼ˆcookie + redisï¼‰</li>
<li>å¸¸è§å®‰å…¨é—®é¢˜å¤„ç†ï¼ˆxss sql æ³¨å…¥ cookie è·¨åŸŸï¼‰</li>
<li>Promise å°è£…æ•°æ®åº“æ“ä½œ</li>
<li>PM2 è¿›ç¨‹å®ˆæŠ¤</li>
</ul>
<p>çº¿ä¸Šä½“éªŒåœ°å€ï¼š<a href="http:www.cmk1018.cn:8085">ç‚¹æˆ‘è·³è½¬</a><br />
<a href="https://github.com/ChenMingK/blog-proj" target="_blank">github åœ°å€</a> æ¬¢è¿ starğŸŒŸ</p>
<h1 id="show">Show</h1>
<p><img src="./images/React ç»ƒä¹ é¡¹ç›®ï¼Œä»¿ç®€ä¹¦åšå®¢å†™ä½œå¹³å°0.png"/></p>
<h1 id="design">Design</h1>
<p><img src="./images/React ç»ƒä¹ é¡¹ç›®ï¼Œä»¿ç®€ä¹¦åšå®¢å†™ä½œå¹³å°1.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>
<h1 id="å‰ç«¯">å‰ç«¯</h1>
<h2 id="é¡¹ç›®ç»“æ„">é¡¹ç›®ç»“æ„</h2>
<pre><code><code>|-- src
â€ƒ |-- api â€ƒâ€ƒ              // æ‰€æœ‰APIè¯·æ±‚(axios)
  |-- assets â€ƒâ€ƒ           // å­—ä½“å›¾æ ‡ã€å…¨å±€/æ··åˆæ ·å¼
â€ƒ |-- components â€ƒ        // å±•ç¤ºç»„ä»¶ / ä½œä¸ºæŸä¸ªé¡µé¢çš„å±€éƒ¨çš„ç»„ä»¶
    |-- common            // å¯å¤ç”¨çš„ç»„ä»¶
    |-- home              // home é¡µé¢æ‰€ç”¨åˆ°çš„ç»„ä»¶ï¼Œå³ home é¡µé¢ç”±è¿™äº›ç»„ä»¶æ„æˆ
    |-- edit              // edit é¡µé¢æ‰€ç”¨åˆ°çš„ç»„ä»¶
â€ƒ |-- pages â€ƒâ€ƒ            // å®¹å™¨ç»„ä»¶ / è¯¥ç»„ä»¶æ•´ä½“ä½œä¸ºä¸€ä¸ªé¡µé¢å±•ç¤ºï¼Œä¸ redux è¿æ¥å¹¶å°† store ä¸­çš„æ•°æ®ä¼ é€’ç»™å…¶å­ç»„ä»¶
    |-- login             // ç™»å½•é¡µ
    |-- home              // é¦–é¡µ
      |-- Home.jsx        // react ç»„ä»¶
      |-- Home.scss       // è¯¥ç»„ä»¶çš„æ ·å¼æ–‡ä»¶ 
      ......
â€ƒ |-- store â€ƒâ€ƒ            // redux
    |-- home              // home é¡µå¯¹åº”çš„ store
      |-- action-type.js  // action ç±»å‹
      |-- actions.js      // action æ„é€ å™¨
      |-- index.js        // ç”¨äºæ•´ä½“å¯¼å‡º
      |-- reducer.js      // è¯¥ module çš„ reducer
    |-- module2           // è¿™ä¸ªæ–‡ä»¶å¤¹åªæ˜¯ä¸ºäº†è¯´æ˜å¦‚æœæœ‰ redux æœ‰æ–°çš„ module éœ€è¦å¼•å…¥å°±å’Œ home æ–‡ä»¶å¤¹ä¸‹æ ¼å¼ä¸€æ ·
    |-- store.js          // åˆå¹¶ reducerï¼Œåˆ›å»º storeï¼ˆå…¨å±€å”¯ä¸€ï¼‰å¹¶å¯¼å‡ºï¼Œå¦‚æœéœ€è¦åº”ç”¨ä¸­é—´ä»¶ï¼Œåœ¨è¿™é‡Œæ·»åŠ 
|-- App.js                // æ ¹ç»„ä»¶ / å®šåˆ¶è·¯ç”±
|-- index.js              // é¡¹ç›®å…¥å£ / webpack æ‰“åŒ…å…¥å£æ–‡ä»¶</code></pre>
<h2 id="react-router-dom-è·¯ç”±è·³è½¬çš„å‡ ç§æ–¹å¼">react-router-dom è·¯ç”±è·³è½¬çš„å‡ ç§æ–¹å¼</h2>
<p>1.å¼•å…¥&lt;Link&gt; ç»„ä»¶å¹¶ä½¿ç”¨ï¼Œä½†æ˜¯å…¶æœ‰é»˜è®¤çš„æ ·å¼ï¼ˆæ¯”å¦‚ä¸‹åˆ’çº¿ï¼‰ï¼Œè¿˜è¦ä¿®æ”¹å…¶é»˜è®¤æ ·å¼</p>
<pre class="jsx"><code>import &lt;Link&gt; from &#39;react-router-dom&#39;
...
&lt;Link to=&quot;/login&quot; className=&quot;login-btn&quot;&gt;
  &lt;span className=&quot;login-text&quot;&gt;ç™»å½•&lt;/span&gt;
&lt;/Link&gt;</code></pre>
<p>2.å¯¼å…¥ withRouter ä½¿ç”¨ js æ–¹å¼è·³è½¬</p>
<pre class="jsx"><code>import { withRouter } from &#39;react-router-dom&#39;

// éœ€è¦å¯¹è¯¥ç»„ä»¶åšå¦‚ä¸‹å¤„ç†ï¼ˆè¿™æ˜¯ä¸ redux è¿æ¥çš„åŒæ—¶åˆä½¿ç”¨ withRouter çš„æƒ…å†µï¼‰
export default withRouter(connect(mapStateToProps, mapDispatchToProps)(Header))

// js æ–¹æ³•å®ç°è·¯ç”±è·³è½¬
this.props.history.push(&#39;/&#39;)

// ç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡æŸç§æ–¹å¼(context?)æŠŠ history ç»™ä¼ é€’åˆ°è¿™ä¸ªç»„ä»¶äº†</code></pre>
<h2 id="å›åˆ°é¡¶éƒ¨çš„è¿‡æ¸¡æ•ˆæœ">å›åˆ°é¡¶éƒ¨çš„è¿‡æ¸¡æ•ˆæœ</h2>
<p>1.åˆ©ç”¨ <code>window.scrollTo(xpos, ypos)</code> æ–¹æ³•åŠ ä¸Š <code>transition: all linear .2s</code> æ¥å®ç° - è¯¥æ–¹æ¡ˆæ— æ•ˆ</p>
<p>2.åˆ©ç”¨å…ƒç´ çš„ scrollTop å±æ€§ï¼Œç‚¹å‡»å›åˆ°é¡¶éƒ¨æŒ‰é’®æ—¶è®¾ç½®å…ƒç´ çš„ scrollTop: 0 å†æ·»åŠ  transition å±æ€§æ¥å®ç° - æ— æ³•å¯¹ scrollTop å±æ€§å®ç°è¿‡æ¸¡</p>
<p>3.è¯¥å…ƒç´ çš„ css ä¸­æ·»åŠ  <code>scroll-behavior: smooth;</code> ç‚¹å‡»å›åˆ°é¡¶éƒ¨æŒ‰é’®æ—¶è®¾ç½®å…ƒç´ çš„ scrollTop: 0 - OK</p>
<h2 id="åˆ©ç”¨-hr-ç”»åˆ†å‰²çº¿">åˆ©ç”¨ &lt;hr&gt; ç”»åˆ†å‰²çº¿</h2>
<p><img src="./images/React ç»ƒä¹ é¡¹ç›®ï¼Œä»¿ç®€ä¹¦åšå®¢å†™ä½œå¹³å°2.png" alt="" /></p>
<pre class="scss"><code>hr {
  border-color: #eaeaea;
  border: 0; // é»˜è®¤æ¨ªçº¿
  border-top: 1px solid #eee; // ç”»æ¡ç°è‰²æ¨ªçº¿
  margin-left: 65px; // è¿™æ˜¯å—çº§å…ƒç´ ï¼Œå¯ä»¥ç”¨ margin æ¥æ§åˆ¶æ¨ªçº¿é•¿åº¦
  margin-right: 15px;
}</code></pre>
<h2 id="åˆ©ç”¨-transformscalex-å®ç°ä¸‹åˆ’çº¿ä¼¸ç¼©æ•ˆæœ">åˆ©ç”¨ transform:scaleX() å®ç°ä¸‹åˆ’çº¿ä¼¸ç¼©æ•ˆæœ</h2>
<p><img src="./images/React ç»ƒä¹ é¡¹ç›®ï¼Œä»¿ç®€ä¹¦åšå®¢å†™ä½œå¹³å°3.png" /></p>
<pre class="scss"><code>.menu-item {
  @include center;
  width: 100px;
  color: #969696;
  font-weight: 700;
  font-size: 16px;
  position: relative;
  .icon {
    margin-right: 5px;
  }
  // åˆ©ç”¨ä¼ªå…ƒç´ ç»™è¿™ä¸ª item åŠ  &quot;ä¸‹åˆ’çº¿&quot;
  &amp;:after {
    content: &#39;&#39;;
    position: absolute;
    width: 100%;
    border-bottom: 2px solid #646464;
    top: 100%;
    transform: scaleX(0);
    transition: all linear .2s;
  }
  // hover æ—¶æ”¹å˜ scaleX
  &amp;:hover {
    color: #646464;
    cursor: pointer;
    &amp;:after { // å’‹é€‰çš„?
      transform: scaleX(1);
    }
  }
}</code></pre>
<h2 id="åˆ©ç”¨-dom-æ“ä½œæ‰‹åŠ¨æ·»åŠ çš„äº‹ä»¶å¤„ç†ç¨‹åºè¦æ‰‹åŠ¨ç§»é™¤">åˆ©ç”¨ DOM æ“ä½œæ‰‹åŠ¨æ·»åŠ çš„äº‹ä»¶å¤„ç†ç¨‹åºè¦æ‰‹åŠ¨ç§»é™¤</h2>
<pre class="js"><code>// å‡è®¾åœ¨åŠ è½½ç»„ä»¶æ—¶è¿™æ ·æ·»åŠ äº‹ä»¶å¤„ç†ç¨‹åº
componentDidMount() {
  let app = document.getElementsByClassName(&#39;App&#39;)[0]
  app.addEventListener(&#39;scroll&#39;, this.handleScroll, false)
}

// å°±éœ€è¦è¿™ä¹ˆç§»é™¤ï¼Œå¦åˆ™ä¼šæŠ¥å†…å­˜æ³„æ¼ï¼Œå¦å¤–æ³¨æ„è¿™é‡Œçš„ this.handleScroll å¿…é¡»æ˜¯ä¸ä¸Šé¢çš„ addEventListener ç›¸åŒçš„å¼•ç”¨
componentWillUnmount() {
  let app = document.getElementsByClassName(&#39;App&#39;)[0]
  app.removeEventListener(&#39;scroll&#39;, this.handleScroll, false)
}</code></pre>
<h2 id="é˜²æ­¢æ— æ„ä¹‰çš„æ¸²æŸ“">é˜²æ­¢æ— æ„ä¹‰çš„æ¸²æŸ“</h2>
<pre class="js"><code>shouldComponentUpdate(nextProps, nextState) {
  // ArticleList ç»„ä»¶æ˜¯ä»çˆ¶ç»„ä»¶æ‹¿åˆ°çš„ articlelistï¼Œå‘ç°åœ¨å†…å®¹æ²¡å˜çš„æƒ…å†µä¸‹é¡µé¢å‘ä¸‹æ»šåŠ¨å°±ä¼šè§¦å‘ render å‡½æ•°
  // æŠ•æœºå–å·§......
  return nextProps.articleList.length !== this.props.articleList.length
}</code></pre>
<h2 id="è‡ªå·±å®ç°ä¸€ä¸ªå¸¦è¾¹æ¡†çš„-tooltip">è‡ªå·±å®ç°ä¸€ä¸ªå¸¦è¾¹æ¡†çš„ tooltip</h2>
<p><img src="./images/React ç»ƒä¹ é¡¹ç›®ï¼Œä»¿ç®€ä¹¦åšå®¢å†™ä½œå¹³å°4.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>
<p>å°ä¸‰è§’å°±ç”¨æˆ‘ä»¬ç†Ÿæ‚‰çš„ css ç”»ä¸‰è§’æ¥ç”»ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ç»™è¿™ä¸ª tooltip å¤–å±‚åŠ ä¸€ä¸ªè¾¹æ¡†ï¼Ÿå¯ä»¥å†åˆ©ç”¨ä¸€æ¬¡ä¼ªå…ƒç´ æ¥ç”»ä¸€ä¸ªä¸‰è§’å½¢ï¼Œå…¶é¢œè‰²<br />
å°±æ˜¯è¾¹æ¡†é¢œè‰²ï¼Œåˆ©ç”¨é«˜åº¦å·®æ¥å®ç°è¿™ä¸ªè¾¹æ¡†æ•ˆæœã€‚</p>
<pre class="scss"><code>&amp;:after {
  content: &#39;&#39;; // è®°å¾—åŠ  content æ‰è¡Œ
  width: 0;
  height: 0;
  border-width: 10px;
  border-style: solid;
  border-color: #fff transparent transparent transparent;
  position: absolute;
  top: 100%;
  left: 50%;
  z-index: 101;
  margin-left: -10px;
}
// å¦‚æœæˆ‘æƒ³ç»™å°ä¸‰è§’å†åŠ ä¸ªè¾¹æ¡†?
&amp;:before {
  content: &#39;&#39;;
  width: 0;
  height: 0;
  border-width: 11px;
  border-style: solid;
  border-color: #f0f0f0 transparent transparent transparent;
  position: absolute;
  top: calc(100% + 1px); // calc å¤§æ³•å¥½
  left: 50%;
  z-index: 100;
  margin-left: -11px;
}</code></pre>
<h1 id="åç«¯">åç«¯</h1>
<h2 id="é¡¹ç›®ç»“æ„-1">é¡¹ç›®ç»“æ„</h2>
<pre><code><code>|--bin
  |-- www                 // å…¥å£æ–‡ä»¶ / å¯åŠ¨æ–‡ä»¶
|-- conf                  // é…ç½®é¡¹
  |-- db.js               // æ•°æ®åº“è¿æ¥é…ç½® / redis è¿æ¥é…ç½®
|-- controller
  |-- blog.js             // å¤„ç† blog è·¯ç”±ç›¸å…³é€»è¾‘ï¼ˆå°†é€»è¾‘æ“ä½œå°è£…ä¸ºå‡½æ•°å¹¶å¯¼å‡ºç”±ä¾›è·¯ç”±å¤„ç†éƒ¨åˆ†ä½¿ç”¨ï¼‰
  |-- user.js             // å¤„ç† user è·¯ç”±ç›¸å…³é€»è¾‘
|-- db
  |-- mysql.js            // å»ºç«‹ mysql è¿æ¥ï¼Œå°†æ‰§è¡Œ sql æ“ä½œå°è£…ä¸º Promise å¹¶å¯¼å‡º
  |-- redis.js            // å»ºç«‹ redis è¿æ¥ï¼Œå°è£… setã€get æ“ä½œå¹¶å¯¼å‡º
|-- middleware
  |-- loginCheck.js       // è‡ªå®šä¹‰çš„ä¸­é—´ä»¶
|-- model
  |-- resModel.js         // å°è£…å“åº”çš„æ ¼å¼
|-- routes                // å®šä¹‰ç›¸å…³çš„è·¯ç”±å¤„ç†
  |-- blog.js             // ä¸åšå®¢æ–‡ç« ç›¸å…³çš„è·¯ç”±å¤„ç†
  |-- user.js             // ä¸ç”¨æˆ·æ³¨å†Œ / ç™»å½•ç›¸å…³çš„è·¯ç”±å¤„ç†
|-- utils                 // å·¥å…·ç±»
  |-- cryp.js             // åŠ å¯†å‡½æ•°
|-- app.js                // è§„å®šä¸­é—´ä»¶çš„å¼•å…¥é¡ºåº / è¯·æ±‚çš„å¤„ç†é¡ºåºï¼Œæ•´åˆè·¯ç”±
|-- package.json</code></pre>
<h2 id="ä½¿ç”¨-nodemon-å’Œ-cross-env">ä½¿ç”¨ nodemon å’Œ cross-env</h2>
<p><code>npm install nodemon cross-env --save-dev</code></p>
<p>nodemon ç”¨äºçƒ­é‡å¯ï¼Œå°±æ˜¯è·Ÿ webpack çš„çƒ­æ›´æ–°å·®ä¸å¤šï¼Œä¿å­˜æ–‡ä»¶åè‡ªåŠ¨é‡å¯æœåŠ¡ã€‚</p>
<p>cross-env ç”¨äºé…ç½®ç¯å¢ƒå˜é‡ã€‚</p>
<p>packages.json åšå¦‚ä¸‹è„šæœ¬é…ç½®ï¼š</p>
<pre class="js"><code>&quot;scripts&quot;: {
    &quot;start&quot;: &quot;node ./bin/www&quot;,
    &quot;dev&quot;: &quot;cross-env NODE_ENV=dev nodemon ./bin/www&quot;,
    &quot;prd&quot;: &quot;cross-env NODE_ENV=production pm2 start ./bin/www&quot; // pm2 ä¹‹åä¼šä»‹ç»
  },</code></pre>
<p>å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è·å–ç¯å¢ƒå‚æ•°ï¼šä»è€Œæ ¹æ®ç¯å¢ƒæ¥ä¿®æ”¹æˆ‘ä»¬çš„ä¸€äº›é…ç½®ï¼ˆå¦‚ mysql redisï¼‰</p>
<pre class="js"><code>// é…ç½®æ–‡ä»¶
const env = process.env.NODE_ENV

// mysql é…ç½®, redis é…ç½®
let MYSQL_CONF
let REDIS_CONF

// å¼€å‘ç¯å¢ƒ
if (env === &#39;dev&#39;) {
  // mysql
  MYSQL_CONF = {
    ...
  }

  // redis
  REDIS_CONF = {
    port: 6379,
    host: &#39;127.0.0.1&#39;
  }
}

// çº¿ä¸Šç¯å¢ƒ
if (env === &#39;production&#39;) {
  ...
}</code></pre>
<h2 id="æ–‡ä»¶ç»“æ„æ‹†åˆ†">æ–‡ä»¶ç»“æ„æ‹†åˆ†</h2>
<ul>
<li>ä¸ºä»€ä¹ˆè¦æŠŠ www å’Œ app.js åˆ†ç¦»ï¼Ÿ</li>
</ul>
<p>www ä»…ä¸ serverï¼ˆæœåŠ¡å¯åŠ¨ï¼‰ç›¸å…³ï¼Œapp.js è´Ÿè´£ä¸€äº›å…¶ä»–çš„ä¸šåŠ¡ï¼Œå¦‚æœä¹‹åéœ€è¦ä¿®æ”¹ï¼Œé‚£ä¹ˆä¸ server ç›¸å…³å°±åªéœ€è¦è´Ÿè´£ www æ–‡ä»¶å³å¯ã€‚</p>
<ul>
<li>router å’Œ controller ä¸ºä»€ä¹ˆè¦åˆ†ç¦»ï¼Ÿ</li>
</ul>
<p>router ä¸­åªè´Ÿè´£è·¯ç”±çš„å“åº”ä¸å›å¤ï¼Œä¸è´Ÿè´£å…·ä½“æ•°æ®çš„å¤„ç†ï¼ˆæ•°æ®åº“æ“ä½œï¼‰ï¼›<br />
controller åªè´Ÿè´£æ•°æ®ï¼Œä¼ å…¥å‚æ•°æ“ä½œæ•°æ®åº“è¿”å›ç»“æœï¼Œç›¸å½“äºå°è£…å¥½çš„æ•°æ®æ“ä½œï¼Œä¸è·¯ç”±æ— å…³ï¼ˆè·¯ç”±è´Ÿè´£è°ƒç”¨ï¼‰</p>
<h2 id="mysql-å ä½æŠ€å·§">mysql å ä½æŠ€å·§</h2>
<pre class="js"><code>let sql = `SELECT * FROM blogs WHERE 1 = 1` // 1 = 1çš„æ„ä¹‰ï¼Ÿå ä½ï¼Œå¦‚æœ author å’Œ keyword éƒ½æ²¡æœ‰å€¼è¿™æ ·ä¸ä¼šæŠ¥é”™
if (author) {
  sql += `AND author=&#39;${author}&#39; `
}
if (keyword) {
  sql += `AND title LIKE &#39;%${keyword}%&#39; `
}
sql += `ORDER BY createtime DESC;`</code></pre>
<h2 id="å°†æ•°æ®åº“æ‰§è¡Œè¯­å¥å°è£…ä¸º-promise-å¯¹è±¡">å°†æ•°æ®åº“æ‰§è¡Œè¯­å¥å°è£…ä¸º Promise å¯¹è±¡</h2>
<pre class="js"><code>// ç»Ÿä¸€æ‰§è¡Œ sql çš„å‡½æ•°ï¼Œå¹¶å°è£…ä¸º Promise å¯¹è±¡
function exec (sql) {
  const promise = new Promise((resolve, reject) =&gt; {
    conn.query(sql, (err, result) =&gt; {
      if (err) {
        reject(err)
        return
      }
      resolve(result)
    })
  })
  return promise
}</code></pre>
<p>æˆ‘ä»¬åœ¨ controller å±‚å†åšä¸€å±‚å°è£…ï¼š</p>
<pre class="js"><code>const getArticleList = () =&gt; {
  const sql = `SELECT * FROM articles`
  return exec(sql)
}</code></pre>
<p>åœ¨è·¯ç”±å¤„ç†æ—¶è¿™æ ·ä½¿ç”¨ï¼š</p>
<pre class="js"><code>// Home é¡µè·å–æ–‡ç« åˆ—è¡¨
router.get(&#39;/getPartArticles&#39;, (req, res) =&gt; {
  const result = getArticleList()
  return result.then(data =&gt; {
    res.json(
      new SuccessModel(data)
    )
  })
})</code></pre>
<p>è¿™ä¹ˆåšçš„ç›®çš„ä¸»è¦æ˜¯è®©å›è°ƒçš„é¡ºåºæ›´ä¸ºæ¸…æ™°ï¼Œæœ¬æ¥ Promise å°±æ˜¯ä¸ºäº†è§£å†³å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é‡‡ç”¨ async / await çš„å†™æ³•ï¼š</p>
<pre class="js"><code>// è¿™æ˜¯ koa2 çš„å½¢å¼ï¼Œkoa2 åŸç”Ÿæ”¯æŒ async / await çš„å†™æ³•
router.post(&#39;/login&#39;, async (req, res) =&gt; {
    // åŸæ¥åšæ³•
    // query(&#39;select * from im_user&#39;, (err, rows) =&gt; {
    //     res.json({
    //         code: 0,
    //         msg: &#39;è¯·æ±‚æˆåŠŸ&#39;,
    //         data: rows
    //     })
    // })
    
    // ç°åœ¨
    const rows = await query(&#39;select * from im_user&#39;)
    res.json({
        code: 0,
        msg: &#39;è¯·æ±‚æˆåŠŸ&#39;,
        data: rows
    })  
})</code></pre>
<h2 id="ç™»å½•éªŒè¯ç”¨æˆ·ä¿¡æ¯æŒä¹…åŒ–">ç™»å½•éªŒè¯ï¼ˆç”¨æˆ·ä¿¡æ¯æŒä¹…åŒ–ï¼‰</h2>
<p>è¿™é‡Œåˆ†æä¸€ä¸‹åªä½¿ç”¨ cookie å’Œ cookie å’Œ session ç»“åˆä½¿ç”¨çš„åŒºåˆ«ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯åˆ†æä¸‹ä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„æŠ€æœ¯è¿­ä»£ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬ä½¿ç”¨æœ€åŸå§‹çš„æ–¹æ³•ï¼šç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç éªŒè¯æˆåŠŸåï¼ŒæœåŠ¡å™¨å‘å®¢æˆ·ç«¯è®¾ç½® cookieï¼Œæˆ‘ä»¬å‡è®¾è¿™ä¸ª cookie å­˜å‚¨ä¸€ä¸ª username å­—æ®µï¼ˆæ˜¾ç„¶è¿™æ˜¯ä¸€ä¸ªå¾ˆæ„šè ¢çš„è¡Œä¸ºï¼‰ï¼Œé‚£ä¹ˆåœ¨ç”¨æˆ·é¦–æ¬¡ç™»å½•ä¹‹åä»–ä¸‹æ¬¡å†ç™»å½•çš„æ—¶å€™å°±æ‹¥æœ‰äº†è¿™ä¸ª cookieï¼Œå‰ç«¯å¯ä»¥è®¾ç½®åœ¨ç”¨æˆ·ä¸€æ‰“å¼€åº”ç”¨æ—¶å°±å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ˆè‡ªåŠ¨æºå¸¦ cookieï¼‰ï¼Œåç«¯å°±é€šè¿‡æ£€æµ‹ cookie ä¸­çš„ä¿¡æ¯å°±å¯ä»¥ä½¿å¾—ç”¨æˆ·ç›´æ¥è¿›å…¥ç™»å½•çŠ¶æ€äº†ã€‚</p>
<p>æ•´ç†ä¸€ä¸‹ï¼š</p>
<ul>
<li>â‘  é¦–æ¬¡ç™»å½•æ‹¥æœ‰äº† cookie</li>
<li>â‘¡ å†æ¬¡ç™»å½•é€šè¿‡æ£€éªŒ cookie çš„å­˜åœ¨ä¸å¦æ¥ç¡®å®šç™»å½•çŠ¶æ€</li>
</ul>
<hr />
<p>åœ¨ cookie ä¸­ç›´æ¥æš´éœ²ç”¨æˆ·ä¿¡æ¯æ˜¯æ„šè ¢çš„è¡Œä¸ºï¼Œä¸‹é¢æˆ‘ä»¬æ¥å‡çº§ä¸€ä¸‹ã€‚</p>
<p>æˆ‘ä»¬åœ¨ cookie ä¸­å­˜å‚¨ä¸€ä¸ª useridï¼ŒæœåŠ¡å™¨æ ¹æ®ä¼ æ¥çš„ userid æ¥å¾—åˆ°å¯¹åº”çš„ usernameï¼Œé‚£ä¹ˆå°±éœ€è¦èŠ±è´¹ç©ºé—´æ¥å­˜å‚¨è¿™ä¸€æ˜ å°„å…³ç³»ï¼Œå‡è®¾æˆ‘ä»¬ç”¨å…¨å±€å˜é‡æ¥å­˜å‚¨ï¼ˆå³å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼‰ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ session äº†ï¼Œå³ server ç«¯å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p>é‚£ä¹ˆç°åœ¨å°±å˜æˆäº†ï¼š</p>
<ul>
<li>â‘  é¦–æ¬¡ç™»å½•æ‹¥æœ‰äº† cookieï¼Œä½†è¿™æ¬¡è®°å½•çš„æ˜¯ userid</li>
<li>â‘¡ å†æ¬¡ç™»å½•å‘é€ cookieï¼ŒæœåŠ¡å™¨åˆ†æ cookie å¹¶æ ¹æ®å­˜å‚¨çš„æ˜ å°„å…³ç³»åˆ¤æ–­ç™»å½•çŠ¶æ€</li>
</ul>
<p>çœ‹ä¸Šå»ä¸é”™ï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜ï¼šå‡è®¾æˆ‘ä»¬æ˜¯ node.js çš„ä¸€ä¸ªè¿›ç¨‹åšæœåŠ¡ï¼Œç”¨æˆ·æ•°é‡ä¸æ–­å¢åŠ ï¼Œå†…å­˜å°†ä¼šæš´å¢ï¼Œè€Œ OS æ˜¯ä¼šé™åˆ¶ä¸€ä¸ªè¿›ç¨‹æ‰€èƒ½ä½¿ç”¨çš„æœ€å¤§å†…å­˜çš„ï¼›å¦å¤–ï¼Œå‡è®¾æˆ‘ä¸ºäº†å……åˆ†åˆ©ç”¨ CPU çš„å¤šæ ¸ç‰¹æ€§æˆ‘å¼€ä¸ªå¤šè¿›ç¨‹ä¸€èµ·æ¥åšæœåŠ¡ï¼Œé‚£ä¹ˆè¿™äº›è¿›ç¨‹ä¹‹é—´çš„å†…å­˜æ— æ³•å…±äº«ï¼Œå³ç”¨æˆ·ä¿¡æ¯æ— æ³•å…±äº«ï¼Œè¿™å°±ä¸å¤ªå¦™äº†ã€‚</p>
<hr />
<p>äºæ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ redis æ¥è§£å†³è¿™ä¸€é—®é¢˜ï¼Œredis ä¸åŒäº mysqlï¼Œå…¶æ•°æ®å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼ˆè™½ç„¶æ˜‚è´µä½†è®¿é—®å­˜å¿«ï¼‰ï¼Œæˆ‘ä»¬æŠŠåŸå…ˆè¦åœ¨å„ä¸ªè¿›ç¨‹ä¸­å­˜å‚¨çš„å…¨å±€å˜é‡æ”¹ä¸ºç»Ÿä¸€å­˜å‚¨åœ¨ redis ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥åšåˆ°å¤šè¿›ç¨‹å…±äº«ä¿¡æ¯ï¼ˆå…¨éƒ¨é€šè¿‡è®¿å­˜ redis æ¥å®ç°ï¼‰</p>
<p>é‚£ä¹ˆ node.js ä¸­åº”è¯¥æ€ä¹ˆå†™å‘¢ï¼Ÿ</p>
<p>æœ¬æ¥ express-session è¿™ä¸ªä¸­é—´ä»¶å¯ä»¥ååˆ†æ–¹ä¾¿åœ°å¸®æˆ‘ä»¬å®ç°è¿™ä¸€éœ€æ±‚çš„ï¼Œåªéœ€è¦å¤§æ¦‚å¦‚ä¸‹çš„é…ç½®å°±å¯ä»¥å®ç°æˆ‘ä»¬ä¸Šè¿°æ‰€è¯´çš„éœ€æ±‚<br />
ï¼ˆå‘å®¢æˆ·ç«¯è®¾ç½® cookieï¼Œå°†ç›¸å…³ä¿¡æ¯å­˜å‚¨è¿› redisï¼‰ï¼Œå…·ä½“çš„å¯ä»¥å‚è€ƒ<br />
<a href="https://blog.csdn.net/chaoyangsun/article/details/79240888">è¿™ç¯‡æ–‡ç« </a></p>
<pre class="js"><code>const redisClient = require(&#39;./db/redis&#39;)
const sessionStore = new RedisStore({
  client: redisClient
})
app.use(session({
  secret: &#39;WJiol#23123_&#39;,
  cookie: {
    // path: &#39;/&#39;,   // é»˜è®¤é…ç½®
    // httpOnly: true,  // é»˜è®¤é…ç½®
    maxAge: 24 * 60 * 60 * 1000
  },
  store: sessionStore
}))</code></pre>
<p>ç„¶è€Œä½¿ç”¨æ—¶å´ä¸€ç›´æœ‰ bugï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªè·¯ç”±è®¾ç½® req.session.xxx çš„å€¼åï¼Œç†è®ºä¸Šåº”è¯¥å­˜å…¥äº† redis ä¸”è®¾ç½®äº†ç›¸åº”çš„ cookieï¼Œä¸‹æ¬¡æºå¸¦è¯¥ cookie çš„è¯·æ±‚<br />
åˆ°è¾¾æ—¶ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ req.session.xxx æ¥å–å€¼ï¼Œbug å°±æ˜¯å–ä¸åˆ°è¿™ä¸ªå€¼ã€‚ç½‘ä¸Šæ²¡æ‰¾åˆ°è§£å†³æ–¹æ¡ˆäºæ˜¯è‡ªå·±å¤§è‡´åœ°å®ç°äº†ä¸€ä¸‹è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<p>ç®€å•æ¥è¯´å°±æ˜¯è¿™æ ·ï¼š</p>
<ul>
<li>ç”¨æˆ·æˆåŠŸç™»å½•åï¼Œè®¾ç½®ä¸€ä¸ª cookieï¼Œæˆ‘ä»¬ç§°å…¶ä¸º useridï¼ŒåŒæ—¶å°† userid - username è¿™ä¸ªé”®å€¼å¯¹å­˜å…¥ redis</li>
<li>è¯¥ç”¨æˆ·å†æ¬¡æ‰“å¼€åº”ç”¨ï¼ˆå¦‚é¦–é¡µæˆ–å…¶ä»–é¡µé¢ï¼‰ï¼Œå‘èµ·ä¸€ä¸ªè‡ªåŠ¨ç™»å½•çš„è¯·æ±‚ï¼Œè¯¥è¯·æ±‚ä¼šæºå¸¦ cookie.useridï¼Œåç«¯æ£€æŸ¥ redis ä¸­æ˜¯å¦æœ‰ä¸è¿™ä¸ª userid ç›¸åŒçš„é”®ï¼Œå¦‚æœæœ‰åˆ™å–å‡º usernameï¼Œå¿…è¦çš„è¯å†åˆ©ç”¨ username æŸ¥è¯¢ä¸€äº›ç”¨æˆ·ä¿¡æ¯å¹¶è¿”å›ç»™å‰ç«¯ï¼›å¦‚æœæ²¡æœ‰åˆ™è¡¨ç¤ºè¯¥ç”¨æˆ·æœªç™»å½•è¿‡ã€‚</li>
</ul>
<p>ä»…è´´å‡ºéƒ¨åˆ†ä»£ç ï¼š</p>
<pre class="js"><code>// è·¯ç”±è´Ÿè´£è§£æè¯·æ±‚ä¸­çš„æ•°æ®ä»¥åŠè¿”å›å“åº”,controller æä¾›æ•°æ®åº“é€»è¾‘æ“ä½œå‡½æ•°
router.post(&#39;/login&#39;, function(req, res, next) {
  const { username, password } = req.body // ä¸­é—´ä»¶ä¼šå¸®æˆ‘ä»¬æŠŠ POST body ä¸­çš„æ•°æ®å­˜å…¥ req.body
  const result = login(username, password) // è¿”å›çš„æ˜¯ä¸€ä¸ª Promise å¯¹è±¡
  return result.then(data =&gt; {
    if (data.username) { // å¦‚æœä¸æˆåŠŸï¼Œdata ä¸ºç©ºå¯¹è±¡
      // è®¾ç½® session - ç™»å½•ä¹‹åå°±åœ¨ redis ä¸­å­˜å‚¨äº†ç”¨æˆ·ä¿¡æ¯

      // ç™»å½•æˆåŠŸåç»™ç”¨æˆ·è®¾ç½®ä¸€ä¸ª cookie å­˜å‚¨ä¸€ä¸ª userid
      // ç„¶å redis ä¸­å­˜å‚¨ cookie / username çš„é”®å€¼å¯¹
      const userid = `${Date.now()}_${Math.random()}` // éšæœºç”Ÿæˆä¸€ä¸ª userId ä¸²
      set(userid, data.username) // redis æ“ä½œ
      res.cookie(&#39;userid&#39;, `${userid}`, {expires: new Date(Date.now() + 24 * 60 * 60 * 1000), httpOnly: true}) // path é»˜è®¤ / domain é»˜è®¤ä¸º app çš„ï¼Œè®¤ä¸ºè®¾ç½® domain çš„è¯è¦æ³¨æ„ä¸€äº›ç»†èŠ‚é—®é¢˜
      res.json( // res.json æ¥æ”¶ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œè¿”å› JSON æ ¼å¼çš„æ•°æ®
        new SuccessModel()
      )
      return
    }
    res.json(
      new ErrorModel(&#39;loginfail&#39;)
    )
  })
})</code></pre>
<pre class="js"><code>router.get(&#39;/autoLogin&#39;, (req, res) =&gt; {
  const userid = req.cookies.userid
  if (userid) {
    get(userid).then(data =&gt; {
      const username = data // æˆ‘ä»¬æ‹¿åˆ°çš„æ˜¯ username, ç„¶åè¦åˆ©ç”¨ username è·å–ç”¨æˆ·ä¿¡æ¯
      const result = getUserInfoByUsername(username)
      return result.then(userinfo =&gt; {
        if (userinfo) {
          res.json(
            new SuccessModel(userinfo)
          )
        } else {
          res.json(
            new ErrorModel(&#39;è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥&#39;)
          )
        }
      })
    })
  } else {
    res.json(
      new ErrorModel(&#39;æ²¡æœ‰ cookie&#39;)
    )
  }
})</code></pre>
<h2 id="ä¸-cookie-ç›¸å…³çš„è·¨åŸŸé—®é¢˜">ä¸ cookie ç›¸å…³çš„è·¨åŸŸé—®é¢˜</h2>
<p>ç›¸ä¿¡å¤§éƒ¨åˆ†äººåœ¨åˆæ¬¡æ¥è§¦ cookie çš„è®¾ç½®åŠå‘é€é—®é¢˜æ—¶éƒ½ä¼šé‡åˆ°è¿™ç§å‘ï¼Œè¿™é‡Œè®°å½•ä¸‹</p>
<ul>
<li>ä½¿ç”¨ axios åº“æ—¶ï¼ŒAJAX è¯·æ±‚é»˜è®¤ä¸å…è®¸æºå¸¦ cookieï¼Œéœ€è¦å¦‚ä¸‹è®¾ç½®ï¼š</li>
</ul>
<pre class="js"><code>// ç”¨äºè‡ªåŠ¨ç™»å½•
export function autoLogin () {
  return axios({
    method: &#39;get&#39;,
    url: `${BASE_URL}/user/autoLogin`,
    withCredentials: true // æ³¨æ„ axios é»˜è®¤æ˜¯ä¸æºå¸¦ cookie çš„ï¼ï¼ï¼ï¼ï¼
  })
}</code></pre>
<ul>
<li>server ç«¯çš„ Access-Control-Allow-Origin ä¸èƒ½ä¸º *ï¼ŒAccess-Control-Allow-Credentials è¦ä¸º true</li>
</ul>
<pre class="js"><code>app.all(&#39;*&#39;, function(req, res, next) {
  // æ³¨æ„ cookie çš„è·¨åŸŸé™åˆ¶æ¯”è¾ƒä¸¥æ ¼ï¼Œè¿™é‡Œä¸èƒ½ä½¿ç”¨ *ï¼Œå¿…é¡»ä¸è¦å‘é€ cookie çš„ Origin ç›¸åŒï¼Œæœ¬åœ°æµ‹è¯•æ—¶å¦‚ http://localhost:3000 è€Œä¸”ä¸èƒ½æŒ‡å®šå¤šä¸ªåªèƒ½æŒ‡å®šä¸€ä¸ªï¼
  // çº¿ä¸Šåº”è¯¥æ˜¯æŒ‚è½½ html é¡µé¢çš„åŸŸåå’Œç«¯å£å·
  res.header(&quot;Access-Control-Allow-Origin&quot;, &quot;http://localhost:3000&quot;)
  res.header(&#39;Access-Control-Allow-Methods&#39;, &#39;PUT, GET, POST, DELETE, OPTIONS&#39;)
  res.header(&#39;Access-Control-Allow-Credentials&#39;, &#39;true&#39;)
  res.header(&quot;Access-Control-Allow-Headers&quot;, &quot;X-Requested-With&quot;)
  res.header(&#39;Access-Control-Allow-Headers&#39;, &#39;Content-Type, Content-Length, Authorization, Accept&#39;)
  next();
})</code></pre>
<h2 id="xss-ä¸-sql-æ³¨å…¥é˜²èŒƒæªæ–½">xss ä¸ sql æ³¨å…¥é˜²èŒƒæªæ–½</h2>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ç™»å½•çš„ sql è¯­å¥</p>
<pre class="js"><code>const sql = `SELECT username, realname FROM users WHERE username=&#39;${username}&#39; AND password=&#39;${password}&#39;`</code></pre>
<p>å‡è®¾æˆ‘ä»¬æŠŠ sql è¯­å¥æ”¹æˆè¿™æ ·ï¼Œé‚£ä¹ˆæ ¹æœ¬ä¸ç”¨è¾“å…¥å¯†ç å°±èƒ½ç™»å½•æˆåŠŸï¼ˆå³ç”¨æˆ·è¾“å…¥ç”¨æˆ·åä¸º<code>zhangsan'--</code>ï¼‰</p>
<pre class="sql"><code>SELECT username, realname FROM users WHERE username=&#39;zhangsan&#39;--&#39; AND password=&#39;123&#39;</code></pre>
<p>å¦‚æœæ˜¯è¿™æ ·å°±æ›´å±é™©äº†</p>
<pre class="sql"><code>SELECT username, realname FROM users WHERE username=&#39;zhangsan&#39;; DELETE FROM users;--&#39; AND password=&#39;123&#39;</code></pre>
<p>mysql æ¨¡å—è‡ªå¸¦çš„ escape æ–¹æ³•å¯ä»¥å¸®æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜</p>
<pre class="js"><code>username = escape(username)
password = escape(password)
const sql = `
    SELECT username, realname FROM users WHERE username=${username} AND password=${password} // æ³¨æ„ä½¿ç”¨äº† escape åä¸åŠ å¼•å·
  `</code></pre>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ escape å‡½æ•°å¤„ç†ä¸Šè¿°è¾“å…¥åçš„è¾“å‡ºï¼š</p>
<pre class="sql"><code>// before
SELECT username, realname FROM users WHERE username=&#39;zhangsan&#39;--&#39; AND password=&#39;123&#39;
// after
SELECT username, realname FROM users WHERE username=&#39;zhangsan\&#39;--&#39; AND password=&#39;123&#39;</code></pre>
<p>ç†è®ºä¸Šæ¥è¯´ï¼Œæ‰€æœ‰é€šè¿‡æ‹¼æ¥å˜é‡æ‰§è¡Œçš„ sql è¯­å¥éƒ½éœ€è¦åš sql æ³¨å…¥çš„è€ƒè™‘</p>
<p>ä¸‹é¢å†è¯´ä¸‹ xss é˜²èŒƒ</p>
<p><code>npm install xss --save</code></p>
<p>å¦‚æœç”¨æˆ·è¾“å…¥çš„æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹æ˜¯è¿™æ ·çš„å°±å±äº xss æ”»å‡»</p>
<pre class="html"><code>&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code></pre>
<p>æˆ‘ä»¬åªéœ€è¦è¿™ä¹ˆå¤„ç†:</p>
<pre class="js"><code>let title = xss(ArticleTitle)</code></pre>
<p>ç„¶åå†æŠŠå†…å®¹å­˜å…¥æ•°æ®åº“å³å¯ï¼Œè¯¥å·¥å…·ä¼šå¸®æˆ‘ä»¬è½¬ä¹‰ï¼Œå³ï¼š</p>
<pre class="js"><code>&amp; -&gt; &amp;amp;
&lt; -&gt; &amp;lt;
&gt; -&gt; &amp;gt;
&quot; -&gt; &amp;quot;
&#39; -&gt; &amp;#x27;
/ -&gt; &amp;#x2F;
...</code></pre>
<h2 id="å¯†ç åŠ å¯†">å¯†ç åŠ å¯†</h2>
<p>è€ƒè™‘å¦‚æœæ•°æ®åº“è¢«æ”»ç ´äº†ï¼Œå¦‚æœæ•°æ®åº“ä¸­æ˜æ–‡å­˜å‚¨ç”¨æˆ·çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œé‚£åæœæ˜¯æ— æ³•é¢„æ–™çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜è¦å¯¹ç”¨æˆ·çš„å¯†ç åšåŠ å¯†å¤„ç†ã€‚</p>
<p>æˆ‘ä»¬åœ¨æ³¨å†Œæ—¶ï¼Œä¸ç›´æ¥å­˜å‚¨ç”¨æˆ·è¾“å…¥çš„å¯†ç ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›åŠ å¯†æ–¹æ³•ï¼ˆå¦‚ md5ï¼‰å°†å¯†ç åŠ å¯†åå†å­˜å…¥æ•°æ®åº“ï¼Œä¸‹æ¬¡è¯¥ç”¨æˆ·ç™»å½•æ—¶ï¼Œ<br />
ä»ç„¶è¾“å…¥åŒæ ·çš„å¯†ç ï¼Œæˆ‘ä»¬å…ˆå¯¹è¯¥å¯†ç ä¸²è¿›è¡Œ md5 åŠ å¯†åå†è¿›è¡ŒæŸ¥è¯¢ã€‚è¿™æ ·å°±åšåˆ°äº†å¯†ç åŠ å¯†ã€‚</p>
<pre class="js"><code>const crypto = require(&#39;crypto&#39;) // è‡ªå¸¦åº“

// å¯†åŒ™
const SECRET_KEY = &#39;wqeW123s_#!@3&#39;

// MD5 åŠ å¯†
function md5(content) {
  let md5 = crypto.createHash(&#39;md5&#39;)
  return md5.update(content).digest(&#39;hex&#39;) // è¾“å‡ºå˜ä¸º16è¿›åˆ¶
}

// åŠ å¯†å‡½æ•°
function genPassword(password) {
  const str = `password=${password}&amp;key=${SECRET_KEY}`
  return md5(str)
}</code></pre>
<h2 id="pm2-çš„ä½¿ç”¨">PM2 çš„ä½¿ç”¨</h2>
<p>PM2 è§£å†³äº†å“ªäº›é—®é¢˜ï¼Ÿ</p>
<ul>
<li>æœåŠ¡å™¨ç¨³å®šæ€§ï¼šè¿›ç¨‹å®ˆæŠ¤ï¼Œç³»ç»Ÿå´©æºƒè‡ªåŠ¨é‡å¯ï¼Œè¿™ä¸ªå¾ˆé‡è¦ï¼</li>
<li>å……åˆ†åˆ©ç”¨æœåŠ¡å™¨ç¡¬ä»¶èµ„æºï¼Œä»¥æé«˜æ€§èƒ½ï¼šå¯ä»¥å¯åŠ¨å¤šè¿›ç¨‹æä¾›æœåŠ¡</li>
<li>çº¿ä¸Šæ—¥å¿—è®°å½•ï¼šè‡ªå¸¦æ—¥å¿—è®°å½•åŠŸèƒ½</li>
</ul>
<p><code>npm install pm2 -g</code></p>
<p>å¸¸ç”¨å‘½ä»¤ï¼š</p>
<ul>
<li>pm2 start ...: å¯åŠ¨</li>
<li>pm2 list: æŸ¥çœ‹ pm2 è¿›ç¨‹åˆ—è¡¨</li>
<li>pm2 restart &lt;App name&gt; / &lt;id&gt;: é‡å¯</li>
<li>pm2 stop &lt;App name&gt; / &lt;id&gt;: åœæ­¢</li>
<li>pm2 info &lt;App name&gt; / &lt;id&gt;</li>
<li>pm2 log &lt;App name&gt; / &lt;id&gt;</li>
<li>pm2 monit &lt;App name&gt; / &lt;id&gt;: ç›‘æ§ CPU / å†…å­˜ä¿¡æ¯</li>
</ul>
<p>å¯ä»¥è‡ªå®šä¹‰ PM2 çš„é…ç½®æ–‡ä»¶ï¼ˆåŒ…æ‹¬è®¾ç½®è¿›ç¨‹æ•°é‡ï¼Œæ—¥å¿—æ–‡ä»¶ç›®å½•ç­‰ï¼‰</p>
<pre><code><code>{
  &quot;apps&quot;: {
    &quot;name&quot;: &quot;pm2-test-server&quot;,
    &quot;script&quot;: &quot;app.js&quot;,
    &quot;watch&quot;: true, // ç›‘å¬æ–‡ä»¶å˜åŒ–è‡ªåŠ¨é‡å¯(å¼€å‘ç¯å¢ƒ / çº¿ä¸Šç¯å¢ƒ)
    &quot;ignore_watch&quot;: [ // å“ªäº›æ–‡ä»¶å˜åŒ–æ˜¯ä¸éœ€è¦ç›‘å¬çš„
      &quot;node_modules&quot;,
      &quot;logs&quot;
    ],
    &quot;instances&quot;: 4, // å¤šè¿›ç¨‹ç›¸å…³ CPU æ ¸æ•°
    &quot;error_file&quot;: &quot;logs/err.log&quot;, // é”™è¯¯æ—¥å¿—è·¯å¾„,æœªå®šä¹‰ä¼šæœ‰é»˜è®¤è·¯å¾„
    &quot;out_file&quot;: &quot;log/out.log&quot;, // console.log æ‰“å°çš„å†…å®¹
    &quot;log_date_format&quot;: &quot;YYYY-MM-DD HH:mm:ss&quot;, // æ—¥å¿—æ—¶é—´æ ¼å¼ï¼Œè‡ªåŠ¨æ·»åŠ æ—¶é—´æˆ³
  }
}</code></pre>
<p><img src="./images/React ç»ƒä¹ é¡¹ç›®ï¼Œä»¿ç®€ä¹¦åšå®¢å†™ä½œå¹³å°5.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>
<h2 id="æ—¥å¿—åˆ†ææŠ€å·§">æ—¥å¿—åˆ†ææŠ€å·§</h2>
<p>ä½¿ç”¨ crontab å‘½ä»¤ï¼ˆlinuxï¼‰æ‹†åˆ†æ—¥å¿—ï¼š</p>
<ul>
<li>æ—¥å¿—å†…å®¹ä¼šæ…¢æ…¢ç§¯ç´¯ï¼Œæ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ä¸å¥½å¤„ç†</li>
<li>æŒ‰æ—¶é—´åˆ’åˆ†æ—¥å¿—æ–‡ä»¶ï¼Œå¦‚ 2019-02-10.access.log</li>
</ul>
<p>Linux çš„ crontab å‘½ä»¤ï¼Œå³å®šæ—¶ä»»åŠ¡</p>
<ul>
<li>è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼Œæ ¼å¼ï¼š* * * * * command</li>
<li>åˆ†é’Ÿ å°æ—¶ æœˆä»½ æ—¥ æ˜ŸæœŸ command æ˜¯ shell è„šæœ¬</li>
</ul>
<p>command éœ€è¦æ‰§è¡Œä»€ä¹ˆï¼Ÿ</p>
<p>1.å°† access.log æ‹·è´å¹¶é‡å‘½åä¸º 2019-02-10.access.log</p>
<p>2.æ¸…ç©º access.log æ–‡ä»¶ï¼Œç»§ç»­ç§¯ç´¯æ—¥å¿—</p>
<p>æˆ‘ä»¬å¯ä»¥ç¼–å†™å¦‚ä¸‹è„šæœ¬ï¼š</p>
<pre><code><code>// copy.sh
cd /Users/Proj/blog-proj
cp access.log $(date + %Y-%m-%d).access.log
echo &quot;&quot; &gt; access.log</code></pre>
<pre><code><code>// æ¯å¤©å‡Œæ™¨è§¦å‘è¯¥ shell è„šæœ¬
crontab -e 1 * 0 * * * sh /Users/Proj/blog-Proj/copy.sh</code></pre>

</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>