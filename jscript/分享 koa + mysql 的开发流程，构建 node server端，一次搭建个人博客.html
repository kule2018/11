<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修分享 koa + mysql 的开发流程，构建 node server端，一次搭建个人博客' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>分享 koa + mysql 的开发流程，构建 node server端，一次搭建个人博客</center></div><div class='banquan'>原文出处:本文由博客园博主hi_shepherd提供。<br/>
原文连接:https://www.cnblogs.com/hi-shepherd/p/10635353.html</div><br>
    <h2 id="前言">前言</h2>
<p>由于一直在用 vue 写业务，为了熟悉下 react 开发模式，所以选择了 react。数据库一开始用的是 mongodb，后来换成 mysql 了，一套下来感觉 mysql 也挺好上手的。react-router、koa、mysql 都是从0开始接触开发的，期间遇到过很多问题，印象最深的是 react-router 参考官方文档配置的，楞是跑不起来，花费了好几个小时，最后才发现看的文档是v1.0, 而项目中是v4.3， 好在可参考的资料比较多，问题都迎刃而解了。</p>
<h2 id="博客介绍">博客介绍</h2>
<ul>
<li>前端项目通过 create-react-app 构建，server端通过 koa-generator 构建</li>
<li>前后端分离，博客页、后台管理都在 blog-admin 里，对含有 /admin 的路由进行登录拦截</li>
<li>前端: react + antd + react-router4 + axios</li>
<li>server端: koa2 + mysql + sequelize</li>
<li>部署：server端 运行在 3000 端口，前端 80 端口，nginx设置代理</li>
</ul>
<p><a href="http://119.23.63.123">预览地址</a></p>
<p><a href="https://github.com/gzwgq222/blog-admin">web端源码</a></p>
<p><a href="https://github.com/gzwgq222/blog-server">server端源码</a></p>
<p>喜欢或对你有帮助，欢迎 star</p>
<h3 id="功能">功能</h3>
<ul>
<li>[x] 登录</li>
<li>[x] 分页</li>
<li>[x] 查询</li>
<li>[x] 标签列表</li>
<li>[x] 分类列表</li>
<li>[x] 收藏列表</li>
<li>[x] 文章列表</li>
<li>[x] 发布文章时间轴</li>
<li>[x] 文章访问次数统计</li>
<li>[x] 回到顶部</li>
<li>[x] 博客适配移动端</li>
<li>[ ] 后台适配移动端</li>
<li>[ ] 对文章访问次数进行可视化</li>
<li>[ ] 留言评论</li>
<li>[ ] 渲染优化、打包优化</li>
</ul>
<h3 id="效果">效果</h3>
<h3 id="标签">标签</h3>
<p><img src="./images/分享 koa + mysql 的开发流程，构建 node server端，一次搭建个人博客0.png" /></p>
<h3 id="分类">分类</h3>
<p><img src="./images/分享 koa + mysql 的开发流程，构建 node server端，一次搭建个人博客1.png" /></p>
<h3 id="收藏">收藏</h3>
<p><img src="./images/分享 koa + mysql 的开发流程，构建 node server端，一次搭建个人博客2.png" /></p>
<h3 id="文章">文章</h3>
<p><img src="./images/分享 koa + mysql 的开发流程，构建 node server端，一次搭建个人博客3.png" /></p>
<h3 id="编辑">编辑</h3>
<p><img src="./images/分享 koa + mysql 的开发流程，构建 node server端，一次搭建个人博客4.png" /></p>
<h3 id="博客页">博客页</h3>
<p><img src="./images/分享 koa + mysql 的开发流程，构建 node server端，一次搭建个人博客5.png" /></p>
<h3 id="响应式">响应式</h3>
<p><img src="./images/分享 koa + mysql 的开发流程，构建 node server端，一次搭建个人博客6.png" /><br />
<img src="./images/分享 koa + mysql 的开发流程，构建 node server端，一次搭建个人博客7.png" /></p>
<h2 id="运行项目">运行项目</h2>
<p>前端</p>
<pre><code><code>git clone https://github.com/gzwgq222/blog-admin.git
cd blog-admin
npm install</code></pre>
<p><code>localhost:2019</code></p>
<p>server 端</p>
<p><code>本地安装 mysql，新建 dev 数据库</code></p>
<pre><code><code>git clone https://github.com/gzwgq222/blog-server.git
cd blog-server
npm install</code></pre>
<h2 id="server-端">server 端</h2>
<p>前端 react + antd 开发，较为平缓，在此就不再叙述。主要记录下 koa + mysql 相关事宜</p>
<blockquote>
<p>全局安装 koa-generator</p>
</blockquote>
<pre><code><code>npm install -g koa-generato</code></pre>
<blockquote>
<p>创建 node-server 项目</p>
</blockquote>
<pre><code><code>koa node-server </code></pre>
<blockquote>
<p>安装依赖</p>
</blockquote>
<pre><code><code>cd node-server 
npn install</code></pre>
<blockquote>
<p>运行</p>
</blockquote>
<pre><code><code>npm dev</code></pre>
<p>出现 Hello Koa 2! 表示运行成功<br />
<img src="./images/分享 koa + mysql 的开发流程，构建 node server端，一次搭建个人博客8.png" /><br />
先看routes文件</p>
<p>index.js</p>
<pre><code><code>const router = require(&#39;koa-router&#39;)()
router.get(&#39;/&#39;, async (ctx, next) =&gt; {
  await ctx.render(&#39;index&#39;, {
    title: &#39;Hello Koa 2!&#39;
  })
})
router.get(&#39;/string&#39;, async (ctx, next) =&gt; {
  ctx.body = &#39;koa2 string&#39;
})
router.get(&#39;/json&#39;, async (ctx, next) =&gt; {
  ctx.body = {
    title: &#39;koa2 json&#39;
  }
})
module.exports = router</code></pre>
<p>users.js</p>
<pre><code><code>const router = require(&#39;koa-router&#39;)()
router.prefix(&#39;/users&#39;)
router.get(&#39;/&#39;, function (ctx, next) {
  ctx.body = &#39;this is a users response!&#39;
})
router.get(&#39;/bar&#39;, function (ctx, next) {
  ctx.body = &#39;this is a users/bar response&#39;
})
module.exports = router</code></pre>
<p>分别访问下列路由</p>
<p><code>localhost:3000/string</code><br />
<code>localhost:3000/users</code><br />
<code>localhost:3000/bar</code></p>
<p>大概你已经猜到了，koa-router 定义路由访问时返回相应的内容，那我们只需要把相应的 data 返回去就行了，只是我们的数据得从数据库查询出来。</p>
<blockquote>
<p>本地安装 mysql</p>
</blockquote>
<blockquote>
<p>项目安裝 mysql</p>
</blockquote>
<pre><code><code>npm install mysql --save</code></pre>
<blockquote>
<p>项目安裝 sequelize</p>
</blockquote>
<p>sequelize 是 ORM node框架，对SQL查询语句的封装，让我们可以用OOP的方式操作数据库</p>
<pre><code><code>npm install --save sequelize</code></pre>
<blockquote>
<p>新建 sequelize.js，建立连接池</p>
</blockquote>
<pre><code><code>const Sequelize = require(&#39;sequelize&#39;);
const sequelize = new Sequelize(&#39;dev&#39;, &#39;root&#39;, &#39;123456&#39;, {
  host: &#39;localhost&#39;,
  dialect: &#39;mysql&#39;,
  operatorsAliases: false,
  pool: {
    max: 5,
    min: 0,
    acquire: 30000,
    idle: 10000
  }
})
sequelize
  .authenticate()
  .then(() =&gt; {
    console.log(&#39;MYSQL 连接成功......&#39;);
  })
  .catch(err =&gt; {
    console.error(&#39;链接失败:&#39;, err);
  });
// 根据模型自动创建表
sequelize.sync()
module.exports = sequelize</code></pre>
<blockquote>
<p>创建 model、controllers 文件夹 定义model：定义表结构；controller：定义对数据库的查询方法</p>
</blockquote>
<p><img src="./images/分享 koa + mysql 的开发流程，构建 node server端，一次搭建个人博客9.png" /></p>
<p>以 tag.js 为例</p>
<p>model =&gt; tag.js</p>
<pre><code><code>const sequelize = require(&#39;../sequelize &#39;)
const Sequelize = require(&#39;sequelize&#39;)
const moment = require(&#39;moment&#39;) // 日期处理库
// 定义表结构
const tag = sequelize.define(&#39;tag&#39;, { 
  id: {
    type: Sequelize.INTEGER(11), // 设置字段类型
    primaryKey: true, // 设置为主建
    autoIncrement: true // 自增
  },
  name: {
    type: Sequelize.STRING,
    unique: { // 唯一
      msg: &#39;已添加&#39;
    }
  },
  createdAt: {
    type: Sequelize.DATE,
    defaultValue: Sequelize.NOW,
    get() {
      // this.getDataValue 获取当前字段value
      return moment(this.getDataValue(&#39;createdAt&#39;)).format(&#39;YYYY-MM-DD HH:mm&#39;)
    }
  },
  updatedAt: {
    type: Sequelize.DATE,
    defaultValue: Sequelize.NOW,
    get() {
      return moment(this.getDataValue(&#39;updatedAt&#39;)).format(&#39;YYYY-MM-DD HH:mm&#39;)
    }
  }
},
{
  // sequelize会自动使用传入的模型名（define的第一个参数）的复数做为表名 设置true取消默认设置
  freezeTableName: true
})
module.exports = tag</code></pre>
<p>controller =&gt; tag.s 定义了 create、findAll、findAndCountAll、destroy 方法</p>
<pre><code><code>const Tag = require(&#39;../model/tag&#39;)
const Op = require(&#39;sequelize&#39;).Op
const listAll = async (ctx) =&gt; {
  const data = await Tag.findAll()
  ctx.body = {
    code: 1000,
    data
  }
}
const list = async (ctx) =&gt; {
  const query = ctx.query
  const where = {
    name: {
      [Op.like]: `%${query.name}%`
    }
  }
  const {rows:data, count: total } = await Tag.findAndCountAll({
    where,
    offset: (+query.pageNo - 1) * +query.pageSize,
    limit: +query.pageSize,
    order: [
      [&#39;createdAt&#39;, &#39;DESC&#39;]
    ]
  })
  ctx.body = {
    data,
    total,
    code: 1000,
    desc: &#39;success&#39;
  }
}
const create = async (ctx) =&gt; {
  const params = ctx.request.body
  if (!params.name) {
    ctx.body = {
      code: 1003,
      desc: &#39;标签不能为空&#39;
    }
    return false
  }
  try {
    await Tag.create(params)
    ctx.body = {
      code: 1000,
      data: &#39;创建成功&#39;
    }
  }
  catch(err) {
    const msg = err.errors[0]
    ctx.body = {
      code: 300,
      data: msg.value + msg.message
    }
  }
}
const destroy = async ctx =&gt; {
  await Tag.destroy({where: ctx.request.body})
  ctx.body = {
    code: 1000,
    desc: &#39;删除成功&#39;
  }
}
module.exports = {
  list,
  create,
  listAll,
  destroy
</code></pre>
<blockquote>
<p>在 routers 文件夹 index.js 中引入定义好的 tag controller ，定义路由</p>
</blockquote>
<pre><code><code>const router = require(&#39;koa-router&#39;)()
const Tag = require(&#39;../controllers/tag&#39;)
// tag
router.get(&#39;/tag/list&#39;, Tag.list)
router.get(&#39;/tag/list/all&#39;, Tag.listAll)
router.post(&#39;/tag/create&#39;, Tag.create)
router.post(&#39;/tag/destroy&#39;, Tag.destroy)
module.exports = router
/* 如每个 route 是单独的文件，可以使用 router.prefix 定义路由前缀
router.prefix(&#39;/tag&#39;)
router.get(&#39;/list&#39;, Tag.list)
router.get(&#39;/list/all&#39;, Tag.listAll)
router.post(&#39;/create&#39;, Tag.create)
router.post(&#39;/destroy&#39;, Tag.destroy)
*/</code></pre>
<p>因为 app 中 已经引入 routers 中的 index.js 调用了 app.use了，所以此处不需再引入<br />
在浏览器里输入 localhost:3000/tag/list 就可以看到返回的数据结构了，只不过 data 为空数组，因为我们还没添加进去任何数据<br />
到这里，model 定义表结构、sequelize操作数据库、koa-router 定义路由 这一套流程算是完成了，其他表结构，接口 都是一样定义的</p>
<h2 id="总结">总结</h2>
<p>之前没有写过 node server 和 react，算是从零搭建该博客，踩了一些坑，也学到了很多东西，譬如react 开发模式、react-router、sequelize 操作mysql的crud、koa、nginx的配置等等。</p>
<p>麻雀虽小，也是一次完整的前后端开发体验，脱离了浏览器的限制，像海贼王一样，打开了新世界的大门，寻找 onepiece ......</p>
<p><a href="https://github.com/gzwgq222/blog-admin">web端源码</a></p>
<p><a href="https://github.com/gzwgq222/blog-server">server端源码</a></p>
<p><a href="http://119.23.63.123">详细的 server 端说明</a></p>
<p>后续会在个人博客中添加关于此次部署文章</p>
<h2 id="links">Links</h2>
<ul>
<li><p><a href="https://react.docschina.org/">react</a></p></li>
<li><p><a href="https://reacttraining.com/react-router/web/guides/quick-start">react-router4</a></p></li>
<li><p><a href="https://ant.design/docs/react/introduce-cn">antd</a></p></li>
<li><a href="https://github.com/jpuri/react-draft-wysiwyg">react-draft-wysiwyg</a></li>
<li><a href="https://koa.bootcss.com/">koa2</a></li>
<li><p><a href="http://docs.sequelizejs.com/">sequelize</a></p></li>
</ul>
<p>初尝 react + Node，错误之处还望斧正，欢迎提 issue</p>

</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>