<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修D2Admin基本使用' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>D2Admin基本使用</center></div><div class='banquan'>原文出处:本文由博客园博主紫月蓝风提供。<br/>
原文连接:https://www.cnblogs.com/izbw/p/11077815.html</div><br>
    <div class="toc">
    <p class="toc-title">目录</p>
    <div class="toc-list">
        <ul>
        <li><a href="#d2-admin基本使用">d2-admin基本使用</a><ul>
        <li><a href="#安装">1 安装</a><ul>
        <li><a href="#全局安装-d2-admin">1.1 全局安装 d2-admin</a></li>
        <li><a href="#创建项目">1.2 创建项目</a></li>
        <li><a href="#启动项目">1.3 启动项目</a></li>
        <li><a href="#注意事项">1.4 注意事项</a></li>
        </ul></li>
        <li><a href="#修改框架-title-和-logo">2 修改框架 title 和 logo</a><ul>
        <li><a href="#修改-title">2.1 修改 title</a></li>
        <li><a href="#修改-logo">2.2 修改 logo</a></li>
        </ul></li>
        <li><a href="#图表库">3 图表库</a><ul>
        <li><a href="#常用的图表库">3.1 常用的图表库</a></li>
        <li><a href="#安装v-charts">3.2 安装v-charts</a></li>
        <li><a href="#导入项目">3.3 导入项目</a></li>
        <li><a href="#简单举例">3.4 简单举例</a></li>
        <li><a href="#注意事项-1">3.5 注意事项</a></li>
        </ul></li>
        <li><a href="#curd插件表格">4 CURD插件（表格）</a><ul>
        <li><a href="#安装-1">4.1 安装</a></li>
        <li><a href="#导入项目-1">4.2 导入项目</a></li>
        <li><a href="#图表使用">4.3 图表使用</a></li>
        <li><a href="#注意事项-2">4.4 注意事项</a></li>
        </ul></li>
        <li><a href="#定义数据api">5 定义数据API</a><ul>
        <li><a href="#第一步使用mockjs创建数据">5.1 第一步，使用mockjs创建数据</a></li>
        <li><a href="#第二步创建api接口共vue项目调用">5.2 第二步，创建API接口，共VUE项目调用</a></li>
        <li><a href="#第三步在-vuex-中创建api调用第二步中创建api接口对数据进行操作">5.3 第三步，在 VUEX 中创建API，调用第二步中创建API接口，对数据进行操作</a></li>
        <li><a href="#第四步在-view-中调用-vuex-中的模块中的方法实现具体功能">5.4 第四步，在 view 中调用 VUEX 中的模块中的方法实现具体功能。</a></li>
        </ul></li>
        <li><a href="#权限控制">6 权限控制</a><ul>
        <li><a href="#第一步在-mock-中添加用户信息以及不同的用户对应的不同的权限并保存至本地的sessionstorage中">6.1 第一步，在 mock 中添加用户信息，以及不同的用户对应的不同的权限，并保存至本地的sessionStorage中。</a></li>
        <li><a href="#第二步在-srcapi-中定义调用-mock-中-api-的接口取到用户信息">6.2 第二步，在 src/API 中定义调用 mock 中 API 的接口，取到用户信息</a></li>
        <li><a href="#第三步在-routerindex.js-中添加钩子函数">6.3 第三步，在 router/index.js 中添加钩子函数。</a></li>
        <li><a href="#第四步在-store-中根据权限处理数据">6.4 第四步，在 store 中根据权限处理数据</a></li>
        <li><a href="#第五步渲染页面后即可看到当前用户具体有哪些操作权限">6.5 第五步，渲染页面后，即可看到当前用户具体有哪些操作权限</a></li>
        </ul></li>
        </ul></li>
        </ul>
    </div>
</div>
<h1 id="d2-admin基本使用">d2-admin基本使用</h1>
<blockquote>
<p>官方演示：<a href="https://d2admin.fairyever.com/#/index" class="uri">https://d2admin.fairyever.com/#/index</a><br />
官方文档：<a href="https://doc.d2admin.fairyever.com/zh/" class="uri">https://doc.d2admin.fairyever.com/zh/</a></p>
</blockquote>
<h2 id="安装">1 安装</h2>
<h3 id="全局安装-d2-admin">1.1 全局安装 d2-admin</h3>
<pre><code><code>npm install -g @d2-admin/d2-admin-cli</code></pre>
<h3 id="创建项目">1.2 创建项目</h3>
<pre><code><code>d2 create 项目名称</code></pre>
<p>或者</p>
<pre><code><code>d2 c 项目名称</code></pre>
<p>之后选择 <strong>简化版</strong></p>
<h3 id="启动项目">1.3 启动项目</h3>
<p>进入项目文件夹</p>
<pre><code><code>npm i</code></pre>
<pre><code><code>npm run serve</code></pre>
<h3 id="注意事项">1.4 注意事项</h3>
<ul>
<li><code>d2-container</code>是 D2Admin 构建页面最重要的组件,在模板页面中记得要用该标签包裹，该标签针对不样式的页面内置不同的类型，详见<a href="https://doc.d2admin.fairyever.com/zh/sys-components/container.html#%E5%8F%82%E6%95%B0" title="官方文档">官方文档</a></li>
</ul>
<h2 id="修改框架-title-和-logo">2 修改框架 title 和 logo</h2>
<h3 id="修改-title">2.1 修改 title</h3>
<pre class="html"><code>// .env.development

# 开发环境

# 页面 title 前缀
VUE_APP_TITLE=ZAdmin</code></pre>
<p>修改完成后重启项目即生效</p>
<h3 id="修改-logo">2.2 修改 logo</h3>
<p><strong>首页LOGL：</strong><br />
替换 .\public\image\theme\d2\logo\all.png</p>
<p><strong>网页 ico 小图标：</strong><br />
替换 .\public\icon.ico</p>
<h2 id="图表库">3 图表库</h2>
<h3 id="常用的图表库">3.1 常用的图表库</h3>
<ul>
<li>百度图表库：echarts (此框架不方便)</li>
<li>饿了么图表库：v-charts （用这个）</li>
</ul>
<blockquote>
<p>v-charts 官方文档：<a href="https://v-charts.js.org/#/" class="uri">https://v-charts.js.org/#/</a></p>
</blockquote>
<h3 id="安装v-charts">3.2 安装v-charts</h3>
<pre><code><code>npm i v-charts echarts -S</code></pre>
<h3 id="导入项目">3.3 导入项目</h3>
<pre class="javascript"><code>// main.js
import Vue from &#39;vue&#39;
import VCharts from &#39;v-charts&#39;
import App from &#39;./App.vue&#39;

Vue.use(VCharts)

new Vue({
  el: &#39;#app&#39;,
  render: h =&gt; h(App)
})</code></pre>
<p><img src="./images/D2Admin基本使用0.png" /></p>
<h3 id="简单举例">3.4 简单举例</h3>
<p>以折线图为例，其他类型详见官方文档。</p>
<p>为了美观，将其包含在elementUI的Card组件中。</p>
<pre class="javascript"><code>&lt;template&gt;
  &lt;el-card&gt;
    &lt;ve-line :data=&quot;chartData&quot;&gt;&lt;/ve-line&gt;
  &lt;/el-card&gt;
&lt;/template&gt;

&lt;script&gt;
  export default {
    data: function () {
      return {
        chartData: {
          columns: [&#39;日期&#39;, &#39;访问用户&#39;, &#39;下单用户&#39;, &#39;下单率&#39;],
          rows: [
            { &#39;日期&#39;: &#39;1/1&#39;, &#39;访问用户&#39;: 1393, &#39;下单用户&#39;: 1093, &#39;下单率&#39;: 0.32 },
            { &#39;日期&#39;: &#39;1/2&#39;, &#39;访问用户&#39;: 3530, &#39;下单用户&#39;: 3230, &#39;下单率&#39;: 0.26 },
            { &#39;日期&#39;: &#39;1/3&#39;, &#39;访问用户&#39;: 2923, &#39;下单用户&#39;: 2623, &#39;下单率&#39;: 0.76 },
            { &#39;日期&#39;: &#39;1/4&#39;, &#39;访问用户&#39;: 1723, &#39;下单用户&#39;: 1423, &#39;下单率&#39;: 0.49 },
            { &#39;日期&#39;: &#39;1/5&#39;, &#39;访问用户&#39;: 3792, &#39;下单用户&#39;: 3492, &#39;下单率&#39;: 0.323 },
            { &#39;日期&#39;: &#39;1/6&#39;, &#39;访问用户&#39;: 4593, &#39;下单用户&#39;: 4293, &#39;下单率&#39;: 0.78 }
          ]
        }
      }
    }
  }
&lt;/script&gt;</code></pre>
<p><img src="./images/D2Admin基本使用1.png" /></p>
<h3 id="注意事项-1">3.5 注意事项</h3>
<ul>
<li>将多个图表分别放置在tab标签页时，切换标签页后下个图表可能会等待很久才会出现，是因为收到 elementUI 中Tabs标签页的 <code>lazy</code> 属性的影响（初始化时有个渲染的过程），如果没有开启延迟渲染，会只渲染第一个标签页内容，因此需要将 <code>lazy</code> 设置为 <code>true</code></li>
</ul>
<p><img src="./images/D2Admin基本使用2.png" /></p>
<p>从第二 tbgs 标签页起，将<code>lazy</code> 属性设置为 <code>true</code></p>
<pre class="html"><code>&lt;el-tabs v-model=&quot;activeName&quot; @tab-click=&quot;handleClick&quot;&gt;
    &lt;el-tab-pane label=&quot;用户管理&quot; name=&quot;first&quot;&gt;
        &lt;ve-line :data=&quot;chartData&quot;&gt;&lt;/ve-line&gt;      
    &lt;/el-tab-pane&gt;
    &lt;el-tab-pane :lazy=&quot;true&quot; label=&quot;配置管理&quot; name=&quot;second&quot;&gt;
        &lt;ve-histogram :data=&quot;chartDataHis&quot;&gt;&lt;/ve-histogram&gt;      
    &lt;/el-tab-pane&gt;
    &lt;el-tab-pane :lazy=&quot;true&quot; label=&quot;角色管理&quot; name=&quot;third&quot;&gt;角色管理&lt;/el-tab-pane&gt;
    &lt;el-tab-pane :lazy=&quot;true&quot; label=&quot;定时任务补偿&quot; name=&quot;fourth&quot;&gt;定时任务补偿&lt;/el-tab-pane&gt;
&lt;/el-tabs&gt;</code></pre>
<h2 id="curd插件表格">4 CURD插件（表格）</h2>
<p>D2 CURD是一个基于Vue.js 和 Element UI的表格组件，封装了常用的表格操作，使用该组件可以快速在页面上处理表格数据。<br />
详见<a href="https://doc.d2admin.fairyever.com/zh/ecosystem-d2-crud/" title="官方文档">官方文档</a></p>
<h3 id="安装-1">4.1 安装</h3>
<pre><code><code>npm i element-ui @d2-projects/d2-crud -S</code></pre>
<h3 id="导入项目-1">4.2 导入项目</h3>
<pre class="javascript"><code>import Vue from &#39;vue&#39;
import ElementUI from &#39;element-ui&#39;
import &#39;element-ui/lib/theme-chalk/index.css&#39;
import D2Crud from &#39;@d2-projects/d2-crud&#39;

Vue.use(ElementUI)
Vue.use(D2Crud)

new Vue({
  el: &#39;#app&#39;,
  render: h =&gt; h(App)
})</code></pre>
<h3 id="图表使用">4.3 图表使用</h3>
<p>此处为带有新增和分页功能的表格，但CURD2.x中分页功能的数据需要从后台获取，因此这里只简单演示了表格的样式。</p>
<p><code>columns</code>: 表格的列属性<br />
<code>data</code>: 表格的数据<br />
<code>add-title</code>: 弹出新增模态框的标题<br />
<code>pagination</code>: 开启分页功能<br />
<code>loading</code>: 加载数据时会有加载中的样式<br />
<code>slot=&quot;header&quot;</code>： 表格的头部信息，自定义样式（如：标题，按钮，输入框等）可以显示在表格的顶部（2.x新增，更好的替代了1.x中的 <code>title</code> 属性）<br />
<code>BusinessTable1List</code>: 后台数据API，获取后台数据，这里只是页面展示，采用固定的数据，未使用API接口。</p>
<pre class="html"><code>&lt;template&gt;
&lt;d2-container&gt;
  &lt;el-card&gt;
    &lt;d2-crud
      ref=&quot;d2Crud&quot;
      :columns=&quot;columns&quot;
      :data=&quot;data&quot;
      add-title=&quot;添加数据&quot;
      :add-template=&quot;addTemplate&quot;
      :form-options=&quot;formOptions&quot;
      :pagination=&quot;pagination&quot;
      :loading=&quot;loading&quot;
      @pagination-current-change=&quot;paginationCurrentChange&quot;
      @dialog-open=&quot;handleDialogOpen&quot;
      @row-add=&quot;handleRowAdd&quot;
      @dialog-cancel=&quot;handleDialogCancel&quot;&gt;
      &lt;el-button slot=&quot;header&quot; style=&quot;margin-bottom: 5px&quot; @click=&quot;addRow&quot;&gt;&lt;i class=&quot;fa fa-plus&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt; 新增&lt;/el-button&gt;
      &lt;el-button slot=&quot;header&quot; style=&quot;margin-bottom: 5px&quot; @click=&quot;addRowWithNewTemplate&quot;&gt;使用自定义模板新增&lt;/el-button&gt;
      &lt;el-input slot=&quot;header&quot; style=&quot;margin-bottom: 5px&quot; placeholder=&quot;商品名称&quot; suffix-icon=&quot;el-icon-search&quot;&gt; &lt;/el-input&gt;
      &lt;el-input slot=&quot;header&quot; style=&quot;margin-bottom: 5px&quot; placeholder=&quot;最低价格&quot; suffix-icon=&quot;el-icon-caret-bottom&quot;&gt; &lt;/el-input&gt;
      &lt;el-input slot=&quot;header&quot; style=&quot;margin-bottom: 5px&quot; placeholder=&quot;最高价格&quot; suffix-icon=&quot;el-icon-caret-top&quot;&gt; &lt;/el-input&gt;
      &lt;el-button slot=&quot;header&quot; style=&quot;margin-bottom: 5px&quot;&gt;&lt;i class=&quot;el-icon-search&quot;&gt;&lt;/i&gt; 搜索&lt;/el-button&gt;
    &lt;/d2-crud&gt;
  &lt;/el-card&gt;
&lt;/d2-container&gt;
&lt;/template&gt;

&lt;script&gt;
// import { BusinessTable1List } from &#39;@api/demo.business.table.1&#39;
export default {
  data () {
    return {
      columns: [
        {
          title: &#39;日期&#39;,
          key: &#39;date&#39;
        },
        {
          title: &#39;姓名&#39;,
          key: &#39;name&#39;
        },
        {
          title: &#39;地址&#39;,
          key: &#39;address&#39;
        }
      ],
      data: [
          {
            date: &#39;2016-05-02&#39;,
            name: &#39;王小虎&#39;,
            address: &#39;上海市普陀区金沙江路 1518 弄&#39;
          },
          {
            date: &#39;2016-05-04&#39;,
            name: &#39;王小虎&#39;,
            address: &#39;上海市普陀区金沙江路 1517 弄&#39;
          },
          {
            date: &#39;2016-05-01&#39;,
            name: &#39;王小虎&#39;,
            address: &#39;上海市普陀区金沙江路 1519 弄&#39;
          },
          {
            date: &#39;2016-05-03&#39;,
            name: &#39;王小虎&#39;,
            address: &#39;上海市普陀区金沙江路 1516 弄&#39;
          }
      ],
      addTemplate: {
        date: {
          title: &#39;日期&#39;,
          value: &#39;2016-05-05&#39;
        },
        name: {
          title: &#39;姓名&#39;,
          value: &#39;王小虎&#39;
        },
        address: {
          title: &#39;地址&#39;,
          value: &#39;上海市普陀区金沙江路 1520 弄&#39;
        }
      },
      formOptions: {
        labelWidth: &#39;80px&#39;,
        labelPosition: &#39;left&#39;,
        saveLoading: false
      },
      loading: false,
      pagination: {
        currentPage: 1,
        pageSize: 5,
        total: 100
      }
    }
  },
  mounted () {
    this.fetchData()
  },
  methods: {
    handleDialogOpen ({ mode }) {
      this.$message({
        message: &#39;打开模态框，模式为：&#39; + mode,
        type: &#39;success&#39;
      })
    },
    // 普通的新增
    addRow () {
      this.$refs.d2Crud.showDialog({
        mode: &#39;add&#39;
      })
    },
    // 传入自定义模板的新增
    addRowWithNewTemplate () {
      this.$refs.d2Crud.showDialog({
        mode: &#39;add&#39;,
        template: {
          name: {
            title: &#39;姓名&#39;,
            value: &#39;&#39;
          },
          value1: {
            title: &#39;新属性1&#39;,
            value: &#39;&#39;
          },
          value2: {
            title: &#39;新属性2&#39;,
            value: &#39;&#39;
          }
        }
      })
    },
    handleRowAdd (row, done) {
      this.formOptions.saveLoading = true
      setTimeout(() =&gt; {
        console.log(row)
        this.$message({
          message: &#39;保存成功&#39;,
          type: &#39;success&#39;
        });

        // done可以传入一个对象来修改提交的某个字段
        done({
          address: &#39;我是通过done事件传入的数据！&#39;
        })
        this.formOptions.saveLoading = false
      }, 300)
    },
    handleDialogCancel (done) {
      this.$message({
        message: &#39;取消保存&#39;,
        type: &#39;warning&#39;
      });
      done()
    },
    paginationCurrentChange (currentPage) {
      this.pagination.currentPage = currentPage
      this.fetchData()
    },
    fetchData () {
      this.loading = true
      BusinessTable1List({
        ...this.pagination
      }).then(res =&gt; {
        this.data = res.list
        this.pagination.total = res.page.total
        this.loading = false
      }).catch(err =&gt; {
        console.log(&#39;err&#39;, err)
        this.loading = false
      })
    }
  }
}
&lt;/script&gt;

&lt;style scoped&gt;
  .el-input {
    width: 200px;
    margin-right: 10px;
  }
&lt;/style&gt;</code></pre>
<p><img src="./images/D2Admin基本使用3.png" /></p>
<h3 id="注意事项-2">4.4 注意事项</h3>
<ul>
<li>课程中使用CURD组件为1.x，最新版本为2.x，变化较大，尤其表现在分页和添加功能上，如在1.x中分页是完全基于前端，而2.x版本的CURD是基于后端的，其需要后端提供数据接口，对返回的数据进行分页展现。详见<a href="https://doc.d2admin.fairyever.com/zh/ecosystem-d2-crud/" title="官方文档">官方文档</a>。关于如何从定义后台API并使用mockjs模拟生成后台数据，请看下一章</li>
</ul>
<h2 id="定义数据api">5 定义数据API</h2>
<ul>
<li>mock （模拟后端，设计API）</li>
<li>api （封装axios调用api，对接后端和vuex）</li>
<li>view （使用vuex处理数据）</li>
</ul>
<p>两个概念：</p>
<ul>
<li>模块化</li>
<li>命名空间</li>
</ul>
<p><img src="./images/D2Admin基本使用4.png" /><br />
<img src="./images/D2Admin基本使用5.png" /></p>
<h3 id="第一步使用mockjs创建数据">5.1 第一步，使用mockjs创建数据</h3>
<blockquote>
<p>注意：创建调用API的URL时，需带上前缀 <code>/api/xxx</code></p>
</blockquote>
<pre class="javascript"><code>// /mock/api/product.js
const Mock = require(&#39;mockjs&#39;)
const Qs = require(&#39;qs&#39;)
const Random = Mock.Random


const titleList = [&#39;男士上衣&#39;, &#39;T恤&#39;, &#39;衬衫&#39;, &#39;牛仔裤&#39;, &#39;皮衣&#39;, &#39;短裙&#39;, &#39;女士衬衫&#39;, &#39;长裙&#39;, &#39;羽绒服&#39;, &#39;秋裤&#39;, &#39;军大衣&#39;];

const getProductList = function (params) {
  // 获取全部商品列表或者分页商品列表
  let products = []
  for (let i = 0; i &lt; 100; i++) {
    let product = {
      id: i + 1,
      title: titleList[Math.floor(Math.random()*titleList.length)],
      price: Random.float(10, 100).toFixed(2),
      stock: Random.integer(10, 100),
      saleCount: Random.integer(0, 90),
      isSale: Random.integer(0, 1),
      createTime: Random.datetime(),
      imgUrl: Random.dataImage(&#39;60x60&#39;, &#39;ZAdmin-&#39; + (i + 1)),
      showEditButton: true,
      showRemoveButton: true
    }
    products.push(product)
  }

  let total = products.length;
  if (params.body &amp;&amp; products.length) {
    let pageInfo = JSON.parse(Qs.parse(params).body);
    let start = (pageInfo.currentPage - 1) * pageInfo.pageSize;
    let end = pageInfo.currentPage * pageInfo.pageSize;
    products = products.slice(start, end);
    console.log(`start: ${start}  end: ${end}  products: ${products}  total: ${total}`);
  }

  return { products, total }
}

// 通过post请求，使用参数的token判断是否登录，并通过参数判断获取全部评论列表或者获取分页评论列表
const getProductComments = function (params) {
  let data = JSON.parse(Qs.parse(params).body);
  console.log(&#39;api-comments-params: &#39;, data);
  if (!data.token) {
    return {
      status: 401,
      msg: &#39;token错误，需要登录&#39;,
      data: {}
    }
  }

  let comments = []
  for (let i = 0; i &lt; 120; i++) {
    let comment = {
      id: i + 1,
      name: Random.cname(),
      itemScore: Random.integer(1, 5),
      serviceScore: Random.integer(1, 5),
      content: Random.ctitle(10, 50),
      createTime: Random.datetime(),
      showEditButton: true,
      showRemoveButton: true
    }
    comments.push(comment)
  }

  let total = comments.length;

  if (data.page) {
    let pageInfo = data.page;
    let start = (pageInfo.currentPage - 1) * pageInfo.pageSize;
    let end = pageInfo.currentPage * pageInfo.pageSize;
    comments = comments.slice(start, end);
    console.log(`currentPage: ${pageInfo.currentPage} start: ${start}  end: ${end}  comments: ${comments}  total: ${total}`);
  }

  return {
    status: 0,
    msg: &#39;成功&#39;,
    data: comments,
    total: total
  }
}


// 创建API的URL，让vue通过URL获取数据
Mock.mock(&#39;/api/products&#39;, &#39;get&#39;, getProductList); // 获取所有商品
Mock.mock(&#39;/api/products&#39;, &#39;post&#39;, getProductList); // 获取分页商品数据
Mock.mock(&#39;/api/productComments&#39;, &#39;post&#39;, getProductComments)
</code></pre>
<h3 id="第二步创建api接口共vue项目调用">5.2 第二步，创建API接口，共VUE项目调用</h3>
<blockquote>
<p>注意：<br />
引用 plugin/axios 中的 <code>request</code> 方法发起请求<br />
发起请求的URL，不需要带 <code>/api/</code> 前缀</p>
</blockquote>
<pre class="javascript"><code>// /src/api/pruduct.js
import request from &#39;@/plugin/axios&#39;

export function getProducts (data) {
  return request({
    url: &#39;/products&#39;,
    method: &#39;get&#39;,
    data
  })
}

export function getPageProducts (data) {
  return request({
    url: &#39;/products&#39;,
    method: &#39;post&#39;,
    data
  })
}

export function getProductComments (data) {
  return request({
    url: &#39;/productComments&#39;,
    method: &#39;post&#39;,
    data
  })
}</code></pre>
<h3 id="第三步在-vuex-中创建api调用第二步中创建api接口对数据进行操作">5.3 第三步，在 VUEX 中创建API，调用第二步中创建API接口，对数据进行操作</h3>
<blockquote>
<p>注意：</p>
</blockquote>
<ul>
<li>在 /src/store/modules/ 下创建操作对象的模块，如 product，其包括了 modules 文件夹和 index.js 文件，index.js 文件复制 \src\store\modules\d2admin\index.js即可</li>
<li>在modules文件夹下创建 product.js 文件用于调用第二步中创建的 API 接口，并对收到的数据进行操作，文件结构与 VUE 项目中store.js相同。</li>
<li>在 product.js 文件中声明 <code>namespaced: true</code>，加了命名空间操作，将该文件直接加在了product文件夹下，被调用时，中间省去了一层 modules，为 product/product</li>
<li>调用 API 时，需要先导入提前定义好的 API</li>
<li>修改 \src\store\index.js 文件，将该模块导出，使 view 能够调用</li>
</ul>
<pre class="javascript"><code>// \src\store\modules\product\modules\product.js
import { getProducts, getPageProducts, getProductComments } from &#39;@/api/product&#39;


export default {
  namespaced: true,
  actions: {
    getProducts ({ commit }, payload) {
      commit(&#39;getProducts&#39;, payload)
    },

    getPageProducts ({ commit }, payload) {
      commit(&#39;getPageProducts&#39;, payload)
    },

    getComments ({ commit }, payload) {
      commit(&#39;getComments&#39;, payload)
    }
  },

  mutations: {
    getProducts (state, payload) {
      state.loading = true;
      getProducts(payload).then(res =&gt; {
        console.log(&#39;getProducts:  &#39;, res);
        state.loading = false;
        state.products = res.products;
      }).catch( err =&gt; {
        console.log(&#39;err&#39;, err)
        state.loading = false
      })
    },

    getComments (state, payload) {
      // 获取全部评价信息或者分页评价信息
      state.loading = true;
      console.log(payload);
      getProductComments(payload).then(res =&gt; {
        console.log(&#39;getComments:  &#39;, res);
        if (res.status == 0) {
          state.loading = false;
          state.total = res.total;
          if (payload.page) {
            state.pageComments = res.data;
          } else {
            state.comments = res.data;
          }
        }
      }).catch( err =&gt; {
        console.log(&#39;err&#39;, err)
        state.loading = false
      })
    },

    getPageProducts (state, payload) {
      console.log(&#39;page_params: &#39;, payload);
      state.loading = true;
      getPageProducts(payload).then(res =&gt; {
        console.log(&#39;res:  &#39;, res);
        state.loading = false;
        state.total = res.total;
        state.pageProducts = res.products;
      }).catch( err =&gt; {
        console.log(&#39;err&#39;, err)
        state.loading = false
      })
    }
  },

  state: {
    products: [],
    pageProducts: [],
    comments: [],
    pageComments: [],
    loading: false,
    total: 0
  },

  getters: {
    products: (state) =&gt; { return state.products },
    pageProducts: (state) =&gt; { return state.pageProducts },
    comments: (state) =&gt; { return state.comments },
    pageComments: (state) =&gt; { return state.pageComments },
    loading: (state) =&gt; { return state.loading },
    total: (state) =&gt; { return state.total }
  }
}</code></pre>
<pre class="javascript"><code>// \src\store\index.js

import Vue from &#39;vue&#39;
import Vuex from &#39;vuex&#39;

import d2admin from &#39;./modules/d2admin&#39;
import product from &#39;./modules/product&#39;

Vue.use(Vuex)

export default new Vuex.Store({
  modules: {
    d2admin,
    product
  }
})</code></pre>
<h3 id="第四步在-view-中调用-vuex-中的模块中的方法实现具体功能">5.4 第四步，在 view 中调用 VUEX 中的模块中的方法实现具体功能。</h3>
<blockquote>
<p>注意：</p>
</blockquote>
<ul>
<li>调用vuex中的方法以及从vuex中取数据时，都需加上命名空间 <code>product/product</code></li>
<li>使用mockjs 生成的图片为base64 格式，需要新建组件转换图片进行显示，view使用时需导入该组件</li>
<li>D2-admin框架自带很多工具集，其中 src/libs/util.js 中<code>cookies.get('token')</code> 可以获取当前用户的token</li>
<li>CURD2.x 分页功能放弃纯前端分页方法，采用后端传入分页好的数据（切片处理）进行分页</li>
</ul>
<p>自定义组件，用于显示图片：</p>
<pre class="html"><code>// \src\views\product\all\MyImage.vue

&lt;template&gt;
    &lt;div&gt;
        &lt;img :src=&quot;value&quot; alt=&quot;商品图片&quot;&gt;
    &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
    props: {
        value: &#39;&#39; // 必须叫value
    }
}
&lt;/script&gt;</code></pre>
<p>基于 CURD2.x 的本地增删改查 以及 分页功能实现</p>
<pre class="html"><code>&lt;template&gt;
&lt;d2-container&gt;
  &lt;template slot=&quot;header&quot;&gt;
    &lt;div class=&quot;flex-header&quot;&gt;
      &lt;div class=&quot;header-title&quot;&gt;
        商品列表
      &lt;/div&gt;
      &lt;div&gt;
        &lt;el-input v-model=&quot;searchWords&quot; placeholder=&quot;商品名称&quot; suffix-icon=&quot;el-icon-search&quot;&gt;&lt;/el-input&gt;
        &lt;el-input v-model=&quot;searchMinPrice&quot; placeholder=&quot;最低价格&quot; suffix-icon=&quot;el-icon-caret-bottom&quot;&gt; &lt;/el-input&gt;
        &lt;el-input v-model=&quot;searchMaxPrice&quot; placeholder=&quot;最高价格&quot; suffix-icon=&quot;el-icon-caret-top&quot;&gt; &lt;/el-input&gt;
        &lt;el-button @click=&quot;onSearch&quot;&gt;&lt;i class=&quot;el-icon-search&quot;&gt;&lt;/i&gt; 搜索&lt;/el-button&gt;
        &lt;el-button type=&quot;primary&quot; @click=&quot;addRow&quot;&gt;&lt;i class=&quot;fa fa-plus&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt; 添加商品&lt;/el-button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/template&gt;
  &lt;el-card&gt;
    &lt;d2-crud
      ref=&quot;d2Crud&quot;
      :columns=&quot;columns&quot;
      :data=&quot;filterProducts.length ? filterProducts : products&quot;
      add-title=&quot;添加商品&quot;
      :add-template=&quot;addTemplate&quot;
      :rowHandle=&quot;rowHandle&quot;
      edit-title=&quot;编辑商品信息&quot;
      :edit-template=&quot;editTemplate&quot;
      :form-options=&quot;formOptions&quot;
      :loading=&quot;loading&quot;
      :pagination=&quot;pagination&quot;
      @pagination-current-change=&quot;paginationCurrentChange&quot;
      @row-add=&quot;handleRowAdd&quot;
      @row-edit=&quot;handleRowEdit&quot;
      @row-remove=&quot;handleRowRemove&quot;
      @dialog-cancel=&quot;handleDialogCancel&quot;&gt;
    &lt;/d2-crud&gt;
  &lt;/el-card&gt;
  &lt;template slot=&quot;footer&quot;&gt;ZAdmin Created By &lt;a href=&quot;&quot;&gt;@ZBW&lt;/a&gt; for D2-admin&lt;/template&gt;
&lt;/d2-container&gt;
&lt;/template&gt;

&lt;script&gt;
// 导入自定义用于显示图片的组件
import MyImage from &quot;./MyImage&quot;

export default {
  data () {
    return {
      searchWords: &#39;&#39;,
      searchMinPrice: &#39;&#39;,
      searchMaxPrice: &#39;&#39;,
      filterProducts: [],
      columns: [
        {
          title: &#39;ID&#39;,
          key: &#39;id&#39;,
          width: &#39;40&#39;
        },
        {
          title: &#39;名称&#39;,
          key: &#39;title&#39;
        },
        {
          title: &#39;价格&#39;,
          key: &#39;price&#39;,
          width: &#39;80&#39;
        },
        {
          title: &#39;库存&#39;,
          key: &#39;stock&#39;,
          width: &#39;80&#39;
        },
        {
          title: &#39;销量&#39;,
          key: &#39;saleCount&#39;,
          width: &#39;80&#39;
        },
        {
          title: &#39;是否上架&#39;,
          key: &#39;isSale&#39;,
          component: {
            name: &#39;el-select&#39;,
            options: [
              {
                value: 0,
                label: &#39;否&#39;
              },
              {
                value: 1,
                label: &#39;是&#39;
              }
            ]
          }
        },
        {
          title: &#39;图片&#39;,
          key: &#39;imgUrl&#39;,
          width: &#39;120&#39;,
          component: {
            name: MyImage
          }
        },
        {
          title: &#39;创建时间&#39;,
          key: &#39;createTime&#39;
        }
      ],
      addTemplate: {
        createTime: {
          title: &#39;创建日期&#39;,
          value: &#39;2019-06-01&#39;,
          component: {
            name: &#39;el-date-picker&#39;,
            span: 12
          }
        },
        isSale: {
          title: &#39;是否上架&#39;,
          value: 0,
          component: {
            name: &#39;el-select&#39;,
            options: [
              {
                value: 0,
                label: &#39;否&#39;
              },
              {
                value: 1,
                label: &#39;是&#39;
              }
            ],
            span: 12
          }
        },
        title: {
          title: &#39;名称&#39;,
          value: &#39;&#39;,
          span: 24
        },
        price: {
          title: &#39;价格&#39;,
          value: &#39;&#39;,
          span: 24
        }
      },
      rowHandle: {
        columnHeader: &#39;操作&#39;,
        edit: {
          icon: &#39;el-icon-edit&#39;,
          text: &#39;编辑&#39;,
          size: &#39;mini&#39;,
          show (index, row) {
            if (row.showEditButton) {
              return true
            }
            return false
          },
          disabled (index, row) {
            if (row.forbidEdit) {
              return true
            }
            return false
          }
        },
        remove: {
          icon: &#39;el-icon-delete&#39;,
          size: &#39;mini&#39;,
          text: &#39;删除&#39;,
          fixed: &#39;right&#39;,
          confirm: true,
          show (index, row) {
            if (row.showRemoveButton) {
              return true
            }
            return false
          }
        }
      },
      editTemplate: {
        createTime: {
          title: &#39;创建日期&#39;,
          component: {
            name: &#39;el-date-picker&#39;,
            span: 12
          }
        },
        isSale: {
          title: &#39;是否上架&#39;,
          component: {
            name: &#39;el-select&#39;,
            options: [
              {
                value: 0,
                label: &#39;否&#39;
              },
              {
                value: 1,
                label: &#39;是&#39;
              }
            ],
            span: 12
          }
        },
        title: {
          title: &#39;名称&#39;,
          span: 24
        },
        price: {
          title: &#39;价格&#39;,
          span: 24
        },
        forbidEdit: {
          title: &#39;禁用按钮&#39;,
          value: false,
          component: {
            show: false
          }
        },
        showEditButton: {
          title: &#39;显示按钮&#39;,
          value: true,
          component: {
            show: false
          }
        }
      },
      formOptions: {
        labelWidth: &#39;80px&#39;,
        labelPosition: &#39;left&#39;,
        saveLoading: false
      },
    }
  },
  created() {
    // 调用vuex中方法时，需要加上命名空间 product/product
    this.fetchData();
    this.$store.commit(&#39;product/product/getProducts&#39;);  // 请求全部商品列表

  },
  computed: {
    all_products() {
      // 全部商品列表，用于搜索
      return this.$store.getters[&#39;product/product/products&#39;];
    },
    products() {
      // 当前分页的商品列表
      // 取 vuex 中数据时，需要加上命名空间 product/product
      return this.$store.getters[&#39;product/product/pageProducts&#39;]
    },
    loading() {
      return this.$store.getters[&#39;product/product/loading&#39;]
    },
    pagination() {
      return {
        currentPage: 1,
        pageSize: 5,
        background: true,
        total: this.$store.getters[&#39;product/product/total&#39;]
      }
    }
  },
  
  
  methods: {
    onSearch() {
      this.filterProducts = this.all_products.filter(p =&gt; {
        if (this.searchWords){
          return p.price &gt;= parseFloat(this.searchMinPrice) &amp;&amp; p.price &lt;= parseFloat(this.searchMaxPrice) &amp;&amp; p.title.includes(this.searchWords);
        } else {
          return p.price &gt;= parseFloat(this.searchMinPrice) &amp;&amp; p.price &lt;= parseFloat(this.searchMaxPrice);
        }
      })
      console.log(&#39;filterProducts: &#39;, this.filterProducts);
    },
    addRow () {
      // 点击新增后，以“添加”模式打开模态框
      this.$refs.d2Crud.showDialog({
        mode: &#39;add&#39;
      })
    },
    handleRowAdd (row, done) {
      // 点击确认添加后触发的事件，可以将数据传递到后台，保存至数据库中
      this.formOptions.saveLoading = true
      setTimeout(() =&gt; {
        // row 是表单提交的内容
        console.log(row)
        this.$message({
          message: &#39;保存成功&#39;,
          type: &#39;success&#39;
        });

        // done可以传入一个对象来修改提交的某个字段
        done({
          price: &#39;你虽然提交了 但是我能在这修改你显示在页面的内容！&#39;
        })
        this.formOptions.saveLoading = false
      }, 300)
    },
    handleRowEdit ({ index, row }, done) {
      // 点击确认修改后触发的事件，可以将数据传递到后台，保存至数据库中
      //  index 是当前编辑行的索引， row 是当前编辑行的数据， done 用于控制编辑成功，可以在 done() 之前加入自己的逻辑代码 
      this.formOptions.saveLoading = true
      setTimeout(() =&gt; {
        console.log(index)
        console.log(row)
        this.$message({
          message: &#39;编辑成功&#39;,
          type: &#39;success&#39;
        })

        // done可以传入一个对象来修改提交的某个字段
        // done()可以传入包含表单字段的对象来覆盖提交的数据，done(false) 可以取消编辑
        done({
          price: &#39;你虽然在后台修改了价格，但是我能在这控制你在前台显示的内容&#39;
        })
        this.formOptions.saveLoading = false
      }, 300)
    },
    handleRowRemove ({ index, row }, done) {
      // 与编辑类似
      setTimeout(() =&gt; {
        console.log(index)
        console.log(row)
        this.$message({
          message: &#39;删除成功&#39;,
          type: &#39;success&#39;
        })
        done()
      }, 300)
    },
    handleDialogCancel (done) {
      // 关闭模态框执行的事件，并可以自定义执行done函数
      this.$message({
        message: &#39;取消保存&#39;,
        type: &#39;warning&#39;
      });
      done()
    },
    paginationCurrentChange (currentPage) {
      // 分页页码发生改变触发的事件
      this.pagination.currentPage = currentPage
      this.fetchData()
    },
    fetchData () {
      // 点击分页按钮后，动态请求该页所需的数据
      this.$store.commit(&#39;product/product/getPageProducts&#39;, {pageSize: this.pagination.pageSize, currentPage: this.pagination.currentPage})
    }
  }
}
&lt;/script&gt;

&lt;style scoped&gt;
  .flex-header {
    display: flex;
    justify-content: space-between;
    align-items:center
  }

  .header-title {
    min-width: 4rem;
  }
  .flex-header .el-input {
    width: 200px;
    margin-right: 10px;
  }
&lt;/style&gt;</code></pre>
<p>经测试，各功能全部正常。<br />
<img src="./images/D2Admin基本使用6.png" /></p>
<h2 id="权限控制">6 权限控制</h2>
<p><strong>用户权限：</strong></p>
<ul>
<li>使用token进行验证</li>
<li>使用sessionStorage保存用户信息（包含权限列表）
<ul>
<li>登录时保存</li>
<li>退出时删除</li>
<li>结合路由meta信息进行判断</li>
</ul></li>
<li>meta：注意使用...meta，原来有bug，需要解析赋值(最新版中，该BUG已修复)</li>
</ul>
<p><strong>控制权限的几种方式：</strong></p>
<ul>
<li>控制查看表格，以及表格的操作按钮</li>
<li>无权限访问某页面或者页面部分内容</li>
</ul>
<h3 id="第一步在-mock-中添加用户信息以及不同的用户对应的不同的权限并保存至本地的sessionstorage中">6.1 第一步，在 mock 中添加用户信息，以及不同的用户对应的不同的权限，并保存至本地的sessionStorage中。</h3>
<ul>
<li>在 \src\mock\api\sys.login.js 中定义用户信息，以及不同用户角色(role)对应不同页面(路由)的权限信息</li>
<li>定义获取用户信息接口，其中包括该用户对用角色的权限信息</li>
</ul>
<pre class="javascript"><code>// src\mock\api\sys.login.js

import Mock from &#39;mockjs&#39;

const userDB = [
  { username: &#39;admin&#39;, password: &#39;admin&#39;, uuid: &#39;admin-uuid&#39;, name: &#39;管理员&#39;, role: &#39;admin&#39; },
  { username: &#39;editor&#39;, password: &#39;editor&#39;, uuid: &#39;editor-uuid&#39;, name: &#39;编辑&#39;, role: &#39;editor&#39; },
  { username: &#39;user1&#39;, password: &#39;user1&#39;, uuid: &#39;user1-uuid&#39;, name: &#39;用户1&#39;, role: &#39;user&#39; }
]

// 为不同的用户角色(role)划分不同的权限

const permissions = {
  admin: [
    {
      path: &#39;/index&#39;,
      operations: [&#39;modify&#39;, &#39;delete&#39;, &#39;add&#39;]
    },
    {
      path: &#39;/product&#39;,
      operations: [&#39;modify&#39;, &#39;delete&#39;, &#39;add&#39;]
    },
    {
      path: &#39;/order&#39;,
      operations: [&#39;modify&#39;, &#39;delete&#39;, &#39;add&#39;]
    },
    {
      path: &#39;/permission&#39;,
      operations: [&#39;modify&#39;, &#39;delete&#39;, &#39;add&#39;]
    },
    {
      path: &#39;/users&#39;,
      operations: [&#39;modify&#39;, &#39;delete&#39;, &#39;add&#39;]
    },
    {
      path: &#39;/menu&#39;,
      operations: [&#39;modify&#39;, &#39;delete&#39;, &#39;add&#39;]
    },
    {
      path: &#39;/stuff&#39;,
      operations: [&#39;modify&#39;, &#39;delete&#39;, &#39;add&#39;]
    },
    {
      path: &#39;/data-charts&#39;,
      operations: [&#39;modify&#39;, &#39;delete&#39;, &#39;add&#39;]
    },
    {
      path: &#39;/log&#39;
    }
  ],
  editor: [{
    path: &#39;/index&#39;,
    operations: [&#39;modify&#39;, &#39;add&#39;]
    },
    {
      path: &#39;/product&#39;,
      operations: [&#39;modify&#39;, &#39;add&#39;]
    },
    {
      path: &#39;/permission&#39;,
      operations: [&#39;modify&#39;]
    },
    {
      path: &#39;/order&#39;,
      operations: [&#39;modify&#39;, &#39;add&#39;]
    }
  ],
  user: [{
    path: &#39;/index&#39;,
    operations: [&#39;add&#39;]
    },
    {
      path: &#39;/product&#39;,
      operations: [&#39;add&#39;]
    },
    {
      path: &#39;/order&#39;,
      operations: [&#39;add&#39;]
    }
  ]
}

Mock.mock(&#39;/api/userInfo&#39;, &#39;post&#39;, ({ body }) =&gt; {
  const bodyObj = JSON.parse(body)
  if (!bodyObj.token) {
    return {
      status: 401,
      msg: &#39;token错误，需要登录&#39;,
      data: {}
    }
  }
  const user = userDB.find(e =&gt; e.uuid === bodyObj.uuid)
  if (user) {
    return {
      status: 0,
      msg: &#39;成功&#39;,
      data: {
        username: user.username,
        name: user.name,
        uuid: user.uuid,
        role: user.role,
        permissions: permissions[user.role]
      }
    }
  } else {
    return {
      status: 401,
      msg: &#39;用户名或密码错误&#39;,
      data: {}
    }
  }
})

// 判断是否登录
export default [
  {
    path: &#39;/api/login&#39;,
    method: &#39;post&#39;,
    handle ({ body }) {
      const user = userDB.find(e =&gt; e.username === body.username &amp;&amp; e.password === body.password)
      if (user) {
        return {
          code: 0,
          msg: &#39;登录成功&#39;,
          data: {
            ...user,
            token: &#39;8dfhassad0asdjwoeiruty&#39;
          }
        }
      } else {
        return {
          code: 401,
          msg: &#39;用户名或密码错误&#39;,
          data: {}
        }
      }
    }
  }
]
</code></pre>
<h3 id="第二步在-srcapi-中定义调用-mock-中-api-的接口取到用户信息">6.2 第二步，在 src/API 中定义调用 mock 中 API 的接口，取到用户信息</h3>
<pre class="javascript"><code>// src\api\sys.login.js

import request from &#39;@/plugin/axios&#39;

export function AccountLogin (data) {
  return request({
    url: &#39;/login&#39;,
    method: &#39;post&#39;,
    data
  })
}

export function getUserInfo (data) {
  return request({
    url: &#39;/userinfo&#39;,
    method: &#39;post&#39;,
    data
  })
}
</code></pre>
<h3 id="第三步在-routerindex.js-中添加钩子函数">6.3 第三步，在 router/index.js 中添加钩子函数。</h3>
<ul>
<li>获取跳转路由的 meta 信息，判断该路由是否需要验证。</li>
<li>若需验证，则从sessionStroage中获取用户的权限列表，如果该用户的权限列表中没有此路由信息，则跳转至401页面提示无权访问此页面，如果权限列表中有此路由信息，则将该用户对此路由的权限信息（如：增删改查）添加至路由的 meta 信息中，并跳转页面。</li>
<li>若不需要验证，直接跳转。</li>
</ul>
<pre class="javascript"><code>// \src\router\index.js

import Vue from &#39;vue&#39;
import VueRouter from &#39;vue-router&#39;

// 进度条
import NProgress from &#39;nprogress&#39;
import &#39;nprogress/nprogress.css&#39;

import store from &#39;@/store/index&#39;

import util from &#39;@/libs/util.js&#39;

// 路由数据
import routes from &#39;./routes&#39;

Vue.use(VueRouter)

// 导出路由 在 main.js 里使用
const router = new VueRouter({
  routes
})

/**
 * 路由拦截
 * 权限验证
 */
router.beforeEach((to, from, next) =&gt; {
  // 进度条
  NProgress.start()
  // 关闭搜索面板
  store.commit(&#39;d2admin/search/set&#39;, false)
  // 获取路由的meta信息，判断当前页面是否需要验证（登录验证，权限验证等等）
  // 验证当前路由所有的匹配中是否需要有登录验证的
  if (to.matched.some(r =&gt; r.meta.auth)) {
    // 这里暂时将cookie里是否存有token作为验证是否登录的条件
    // 请根据自身业务需要修改
    const token = util.cookies.get(&#39;token&#39;) // 获取cookie中的token
    if (token &amp;&amp; token !== &#39;undefined&#39;) {
      // 用户已登录，从sessionStorage中获取用户权限信息
      let userInfo = JSON.parse(sessionStorage.getItem(&#39;userInfo&#39;));
      console.log(token, userInfo);
      if (userInfo) {
        let permissions = userInfo.permissions;
        console.log(&#39;router permissions:  &#39;, permissions);
        let allow = false;
        permissions.forEach(p =&gt; {
          let item = router.match(p.path)  // 找到权限列表中匹配改条路由对应的权限信息
          if (item) {
            // 匹配到路由后，将权限信息添加在路由的meta中
            item.meta.operations = p.operations
          }

          // 完全匹配或者前缀匹配
          console.log(&#39;path:  &#39;, to.path, p.path);
          if (p.path === to.path || to.path.startsWith(p.path)) {
            allow = true;
          }
        })

        // 根据allow判断是否可以跳转到下一个页面
        if (allow) {
          next()
        } else {
          next({ name: &#39;401&#39; })
        }
      } else {
        next()
      }
    } else {
      // 没有登录的时候跳转到登录界面
      // 携带上登陆成功之后需要跳转的页面完整路径
      next({
        name: &#39;login&#39;,
        query: {
          redirect: to.fullPath
        }
      })
      // https://github.com/d2-projects/d2-admin/issues/138
      NProgress.done()
    }
  } else {
    // 不需要身份校验 直接通过
    next()
  }
})

router.afterEach(to =&gt; {
  // 进度条
  NProgress.done()
  // 多页控制 打开新的页面
  store.dispatch(&#39;d2admin/page/open&#39;, to)
  // 更改标题
  util.title(to.meta.title)
})

export default router
</code></pre>
<h3 id="第四步在-store-中根据权限处理数据">6.4 第四步，在 store 中根据权限处理数据</h3>
<ul>
<li>（用户登录的API）登录成功后把 userInfo 存至本地的 sessionStorage 中，注销登录后将用户信息从sessionStorage 中删除</li>
<li>通过取到 router 对象( <code>this.$route.meta.[operations]</code> )的 meta 中的权限信息(如：增删改查)，得出具体某个页面的操作权限信息，针对不同用户权限做出不同的操作。</li>
</ul>
<blockquote>
<p>注意：</p>
</blockquote>
<ul>
<li>$router: 表示全局的 router 对象</li>
<li>$route: 表示当前页面的路由对象</li>
</ul>
<pre class="javascript"><code>// src\store\modules\d2admin\modules\account.js

import { Message, MessageBox } from &#39;element-ui&#39;
import util from &#39;@/libs/util.js&#39;
import router from &#39;@/router&#39;
import { AccountLogin, getUserInfo } from &#39;@api/sys.login&#39;

export default {
  namespaced: true,
  actions: {
    /**
     * @description 登录
     * @param {Object} param context
     * @param {Object} param username {String} 用户账号
     * @param {Object} param password {String} 密码
     * @param {Object} param route {Object} 登录成功后定向的路由对象 任何 vue-router 支持的格式
     */
    login ({ dispatch }, {
      username = &#39;&#39;,
      password = &#39;&#39;
    } = {}) {
      return new Promise((resolve, reject) =&gt; {
        // 开始请求登录接口
        AccountLogin({
          username,
          password
        })
          .then(async res =&gt; {
            // 设置 cookie 一定要存 uuid 和 token 两个 cookie
            // 整个系统依赖这两个数据进行校验和存储
            // uuid 是用户身份唯一标识 用户注册的时候确定 并且不可改变 不可重复
            // token 代表用户当前登录状态 建议在网络请求中携带 token
            // 如有必要 token 需要定时更新，默认保存一天
            util.cookies.set(&#39;uuid&#39;, res.uuid)
            util.cookies.set(&#39;token&#39;, res.token)

            // 登录成功后，加载用户信息和权限信息
            getUserInfo({ uuid: res.uuid, token: res.token }).then(res =&gt; {
              console.log(&#39;get user info:  &#39;, res);
              if (res.status == 401) {
                return;
              } else {
                let userInfo = res.data;
                sessionStorage.setItem(&#39;userInfo&#39;, JSON.stringify(userInfo));
              }
            })

            // 设置 vuex 用户信息
            await dispatch(&#39;d2admin/user/set&#39;, {
              name: res.name
            }, { root: true })
            // 用户登录后从持久化数据加载一系列的设置
            await dispatch(&#39;load&#39;)
            // 结束
            resolve()
          })
          .catch(err =&gt; {
            console.log(&#39;err: &#39;, err)
            reject(err)
          })
      })
    },
    /**
     * @description 注销用户并返回登录页面
     * @param {Object} param context
     * @param {Object} param confirm {Boolean} 是否需要确认
     */
    logout ({ commit, dispatch }, { confirm = false } = {}) {
      /**
       * @description 注销
       */
      async function logout () {
        // 删除cookie
        util.cookies.remove(&#39;token&#39;)
        util.cookies.remove(&#39;uuid&#39;)

        // 退出后将sessionStorage中的用户信息删除
        sessionStorage.removeItem(&#39;userInfo&#39;)

        // 清空 vuex 用户信息
        await dispatch(&#39;d2admin/user/set&#39;, {}, { root: true })
        // 跳转路由
        router.push({
          name: &#39;login&#39;
        })
      }
      // 判断是否需要确认
      if (confirm) {
        commit(&#39;d2admin/gray/set&#39;, true, { root: true })
        MessageBox.confirm(&#39;注销当前账户吗?  打开的标签页和用户设置将会被保存。&#39;, &#39;确认操作&#39;, {
          confirmButtonText: &#39;确定注销&#39;,
          cancelButtonText: &#39;放弃&#39;,
          type: &#39;warning&#39;
        })
          .then(() =&gt; {
            commit(&#39;d2admin/gray/set&#39;, false, { root: true })
            logout()
          })
          .catch(() =&gt; {
            commit(&#39;d2admin/gray/set&#39;, false, { root: true })
            Message({
              message: &#39;放弃注销用户&#39;
            })
          })
      } else {
        logout()
      }
    },
    /**
     * @description 用户登录后从持久化数据加载一系列的设置
     * @param {Object} state vuex state
     */
    load ({ dispatch }) {
      return new Promise(async resolve =&gt; {
        // DB -&gt; store 加载用户名
        await dispatch(&#39;d2admin/user/load&#39;, null, { root: true })
        // DB -&gt; store 加载主题
        await dispatch(&#39;d2admin/theme/load&#39;, null, { root: true })
        // DB -&gt; store 加载页面过渡效果设置
        await dispatch(&#39;d2admin/transition/load&#39;, null, { root: true })
        // DB -&gt; store 持久化数据加载上次退出时的多页列表
        await dispatch(&#39;d2admin/page/openedLoad&#39;, null, { root: true })
        // DB -&gt; store 持久化数据加载侧边栏折叠状态
        await dispatch(&#39;d2admin/menu/asideCollapseLoad&#39;, null, { root: true })
        // DB -&gt; store 持久化数据加载全局尺寸
        await dispatch(&#39;d2admin/size/load&#39;, null, { root: true })
        // end
        resolve()
      })
    }
  }
}
</code></pre>
<h3 id="第五步渲染页面后即可看到当前用户具体有哪些操作权限">6.5 第五步，渲染页面后，即可看到当前用户具体有哪些操作权限</h3>
<ul>
<li>针对表格操作，可以根据 meta 信息中存储的操作权限来判断当前用户所具有的权限，最后对其权限之外的按钮等进行隐藏或者disable。</li>
</ul>
<pre class="html"><code>// src\views\permission\index.vue
&lt;template&gt;
  &lt;d2-container&gt;
    &lt;template slot=&quot;header&quot;&gt;页面权限验证&lt;/template&gt;
    &lt;el-card&gt;
    &lt;d2-crud
      ref=&quot;d2Crud&quot;
      :columns=&quot;columns&quot;
      :data=&quot;data&quot;
      add-title=&quot;我的新增&quot;
      edit-title=&quot;我的修改&quot;
      :add-template=&quot;addTemplate&quot;
      :edit-template=&quot;editTemplate&quot;
      :rowHandle=&quot;rowHandle&quot;
      :form-options=&quot;formOptions&quot;
      @row-add=&quot;handleRowAdd&quot;
      @row-edit=&quot;handleRowEdit&quot;
      @row-remove=&quot;handleRowRemove&quot;
      @dialog-cancel=&quot;handleDialogCancel&quot;&gt;
    &lt;el-button slot=&quot;header&quot; type=&quot;primary&quot; style=&quot;margin-bottom: 5px;&quot; @click=&quot;addRow&quot;&gt;新增&lt;/el-button&gt;
    &lt;/d2-crud&gt;
    &lt;/el-card&gt;
    &lt;template slot=&quot;footer&quot;&gt;ZAdmin Created By &lt;a href=&quot;&quot;&gt;@ZBW&lt;/a&gt; for D2-admin&lt;/template&gt;
  &lt;/d2-container&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  data () {
    return {
      columns: [
        {
          title: &#39;ID&#39;,
          key: &#39;id&#39;,
          width: 50
        },
        {
          title: &#39;日期&#39;,
          key: &#39;date&#39;,
          width: 150
        },
        {
          title: &#39;姓名&#39;,
          key: &#39;name&#39;
        },
        {
          title: &#39;地址&#39;,
          key: &#39;address&#39;
        },
        {
          title: &#39;会员&#39;,
          key: &#39;role&#39;,
          width: 100
        }
      ],
      data: [
        {
          id: 1,
          date: &#39;2016-05-02&#39;,
          name: &#39;王小虎&#39;,
          address: &#39;上海市普陀区金沙江路 1518 弄&#39;,
          role: &#39;普通会员&#39;,
          showEditButton: this.$route.meta.operations.includes(&#39;modify&#39;),
          showRemoveButton: this.$route.meta.operations.includes(&#39;delete&#39;)
        },
        {
          id: 2,
          date: &#39;2016-05-04&#39;,
          name: &#39;王小虎&#39;,
          address: &#39;上海市普陀区金沙江路 1517 弄&#39;,
          role: &#39;普通会员&#39;,
          showEditButton: this.$route.meta.operations.includes(&#39;modify&#39;),
          showRemoveButton: this.$route.meta.operations.includes(&#39;delete&#39;)
        },
        {
          id: 3,
          date: &#39;2016-05-01&#39;,
          name: &#39;王小虎&#39;,
          address: &#39;上海市普陀区金沙江路 1519 弄&#39;,
          role: &#39;普通会员&#39;,
          showEditButton: this.$route.meta.operations.includes(&#39;modify&#39;),
          showRemoveButton: this.$route.meta.operations.includes(&#39;delete&#39;)
        },
        {
          id: 4,
          date: &#39;2016-05-03&#39;,
          name: &#39;王小虎&#39;,
          address: &#39;上海市普陀区金沙江路 1516 弄&#39;,
          role: &#39;普通会员&#39;,
          showEditButton: this.$route.meta.operations.includes(&#39;modify&#39;),
          showRemoveButton: this.$route.meta.operations.includes(&#39;delete&#39;)
        },
        {
          id: 5,
          date: &#39;2016-05-02&#39;,
          name: &#39;王小虎&#39;,
          address: &#39;上海市普陀区金沙江路 1518 弄&#39;,
          role: &#39;普通会员&#39;,
          showEditButton: this.$route.meta.operations.includes(&#39;modify&#39;),
          showRemoveButton: this.$route.meta.operations.includes(&#39;delete&#39;)
        }
      ],
      rowHandle: {
        columnHeader: &#39;编辑表格&#39;,
        edit: {
          icon: &#39;el-icon-edit&#39;,
          text: &#39;编辑&#39;,
          size: &#39;small&#39;,
          show (index, row) {
            if (row.showEditButton) {
              return true
            }
            return false
          },
          disabled (index, row) {
            if (row.forbidEdit) {
              return true
            }
            return false
          }
        },
        remove: {
          icon: &#39;el-icon-delete&#39;,
          size: &#39;small&#39;,
          fixed: &#39;right&#39;,
          confirm: true,
          show (index, row) {
            if (row.showRemoveButton) {
              return true
            }
            return false
          },
          disabled (index, row) {
            if (row.forbidRemove) {
              return true
            }
            return false
          }
        }
      },
      addTemplate: {
        date: {
          title: &#39;日期&#39;,
          value: &#39;2018-11-11&#39;,
          component: {
            name: &#39;el-date-picker&#39;,
            span: 12
          }
        },
        role: {
          title: &#39;会员&#39;,
          value: &#39;普通会员&#39;,
          component: {
            name: &#39;el-select&#39;,
            options: [
              {
                value: &#39;普通会员&#39;,
                label: &#39;普通会员&#39;
              },
              {
                value: &#39;金卡会员&#39;,
                label: &#39;金卡会员&#39;
              }
            ],
            span: 12
          }
        },
        name: {
          title: &#39;姓名&#39;,
          value: &#39;&#39;
        },
        address: {
          title: &#39;地址&#39;,
          value: &#39;&#39;
        }
      },
      editTemplate: {
        date: {
          title: &#39;日期&#39;,
          value: &#39;2018-11-11&#39;,
          component: {
            name: &#39;el-date-picker&#39;,
            span: 12
          }
        },
        role: {
          title: &#39;会员&#39;,
          value: &#39;普通会员&#39;,
          component: {
            name: &#39;el-select&#39;,
            options: [
              {
                value: &#39;普通会员&#39;,
                label: &#39;普通会员&#39;
              },
              {
                value: &#39;金卡会员&#39;,
                label: &#39;金卡会员&#39;
              }
            ],
            span: 12
          }
        },
        name: {
          title: &#39;姓名&#39;,
          value: &#39;&#39;
        },
        address: {
          title: &#39;地址&#39;,
          value: &#39;&#39;
        },
        forbidEdit: {
          title: &#39;禁用按钮&#39;,
          value: false,
          component: {
            show: false
          }
        },
        showEditButton: {
          title: &#39;显示按钮&#39;,
          value: true,
          component: {
            show: false
          }
        }
      },
      formOptions: {
        labelWidth: &#39;80px&#39;,
        labelPosition: &#39;left&#39;,
        saveLoading: false
      }
    }
  },
  methods: {
    addRow () {
      this.$refs.d2Crud.showDialog({
        mode: &#39;add&#39;
      })
    },
    handleRowAdd (row, done) {
      this.formOptions.saveLoading = true
      setTimeout(() =&gt; {
        console.log(row)
        this.$message({
          message: &#39;添加成功&#39;,
          type: &#39;success&#39;
        });
        done({
          showEditButton: this.$route.meta.operations.includes(&#39;modify&#39;),
          showRemoveButton: this.$route.meta.operations.includes(&#39;delete&#39;)
        })
        this.formOptions.saveLoading = false
      }, 300);
    },
    handleRowEdit ({index, row}, done) {
      this.formOptions.saveLoading = true
      setTimeout(() =&gt; {
        console.log(index)
        console.log(row)
        this.$message({
          message: &#39;编辑成功&#39;,
          type: &#39;success&#39;
        })
        done()
        this.formOptions.saveLoading = false
      }, 300)
    },
    handleDialogCancel (done) {
      this.$message({
        message: &#39;操作已取消&#39;,
        type: &#39;warning&#39;
      });
      done()
    },
    handleRowRemove ({index, row}, done) {
      setTimeout(() =&gt; {
        console.log(index)
        console.log(row)
        this.$message({
          message: &#39;删除成功&#39;,
          type: &#39;success&#39;
        })
        done()
      }, 300)
    }
  }
}
&lt;/script&gt;

&lt;style scoped&gt;

&lt;/style&gt;
</code></pre>
<p><strong>admin：</strong><br />
<img src="./images/D2Admin基本使用7.png" /></p>
<p><strong>editer：</strong><br />
<img src="./images/D2Admin基本使用8.png" /></p>
<p><strong>user：</strong><br />
<img src="./images/D2Admin基本使用9.png" /></p>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>