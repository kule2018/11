<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='ç”µè„‘,ç”µè„‘è®²è§£,ç”µè„‘æŠ€æœ¯,ç¼–ç¨‹,ç”µè„‘æ•…éšœç»´ä¿®Nodeé…åˆWebSocketåšå¤šæ–‡ä»¶ä¸‹è½½ä»¥åŠè¿›åº¦å›ä¼ ' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>é¦–é¡µ</a></li>
</div><div onclick='hidden1()' >åˆ†äº«</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Nodeé…åˆWebSocketåšå¤šæ–‡ä»¶ä¸‹è½½ä»¥åŠè¿›åº¦å›ä¼ </center></div><div class='banquan'>åŸæ–‡å‡ºå¤„:æœ¬æ–‡ç”±åšå®¢å›­åšä¸»ç³Šç³Šç³Šç³Šç³Šäº†æä¾›ã€‚<br/>
åŸæ–‡è¿æ¥:https://www.cnblogs.com/rynxiao/p/11811353.html</div><br>
    <h2 id="èµ·å› ">èµ·å› </h2>
<p>ä¸ºä»€ä¹ˆåšè¿™ä¸ªä¸œè¥¿ï¼Œæ˜¯çªç„¶é—´å¬ä¸€åç«¯åŒäº‹è¯´èµ·<a href="https://github.com/iawia002/annie">Annie</a>è¿™ä¸ªä¸œè¥¿ï¼Œå‘ç°è¿™ä¸ªä¸œè¥¿ä¸‹è½½è§†é¢‘æŒºæ–¹ä¾¿çš„ï¼Œä¼šè‡ªåŠ¨çˆ¬å–ç½‘é¡µä¸­çš„è§†é¢‘ï¼Œç„¶åæ•´ç†æˆåˆ—è¡¨ã€‚å‘ç°ç”¨å‘½ä»¤æ‰§è¡Œä¹‹åæ˜¯ä¸‹é¢çš„æ ·å­ï¼š</p>
<p><img src="./images/Nodeé…åˆWebSocketåšå¤šæ–‡ä»¶ä¸‹è½½ä»¥åŠè¿›åº¦å›ä¼ 0.png" alt="list" /></p>
<p>å¿ƒé‡Œç¢ç£¨äº†ä¸‹ï¼Œæ•´ä¸€ä¸ªç•Œé¢ç©ä¸€ä¸‹å§ã€‚ç„¶åå°±åšæˆä¸‹é¢è¿™ä¸ªæ ·å­äº†ã€‚</p>
<h3 id="åˆ—è¡¨">åˆ—è¡¨</h3>
<p><img src="./images/Nodeé…åˆWebSocketåšå¤šæ–‡ä»¶ä¸‹è½½ä»¥åŠè¿›åº¦å›ä¼ 1.png" alt="videolist" /></p>
<h3 id="ä¸‹è½½åˆ—è¡¨">ä¸‹è½½åˆ—è¡¨</h3>
<p><img src="./images/Nodeé…åˆWebSocketåšå¤šæ–‡ä»¶ä¸‹è½½ä»¥åŠè¿›åº¦å›ä¼ 2.png" alt="downloadlist" /></p>
<p>æœ¬æ–‡åœ°å€ä»“åº“ï¼š<a href="https://github.com/Rynxiao/yh-tools" class="uri">https://github.com/Rynxiao/yh-tools</a>ï¼Œå¦‚æœå–œæ¬¢ï¼Œæ¬¢è¿star.</p>
<h2 id="æ¶‰åŠæŠ€æœ¯">æ¶‰åŠæŠ€æœ¯</h2>
<ul>
<li>Express åç«¯æœåŠ¡</li>
<li>Webpack æ¨¡å—åŒ–ç¼–è¯‘å·¥å…·</li>
<li>Nginx ä¸»è¦åšæ–‡ä»¶gzipå‹ç¼©<strong>ï¼ˆå‘ç°Expressæ·»åŠ gzipæœ‰ç‚¹é—®é¢˜ï¼Œæ‰å¼ƒå‘nginxï¼‰</strong></li>
<li>Ant-design å‰ç«¯UIåº“</li>
<li>React + React Router</li>
<li>WebSocket è¿›åº¦å›ä¼ æœåŠ¡</li>
</ul>
<p>å…¶ä¸­è¿˜æœ‰ç‚¹å°æ’æ›²ï¼Œæœ€å¼€å§‹æ˜¯ä½¿ç”¨<code>docker</code>èµ·äº†ä¸€ä¸ª<code>nginx</code>æœåŠ¡ï¼Œä½†æ˜¯å‘ç°å†…éƒ¨è½¬å‘ä¸€ç›´æœ‰é—®é¢˜ï¼ŒåŒæ—¶è·å–å®¿ä¸»ä¸»æœºIPä¹Ÿå‡ºç°äº†ç‚¹é—®é¢˜ï¼Œç„¶åæŠ˜ç£¨äº†å¥½ä¹…æ”¾å¼ƒäº†ã€‚ï¼ˆ<code>docker</code>ç ”ç©¶ä¸æ·±ï¼Œæ•¬è¯·è°…è§£^_^ï¼‰</p>
<h2 id="ä¸‹è½½éƒ¨åˆ†ç»†èŠ‚">ä¸‹è½½éƒ¨åˆ†ç»†èŠ‚</h2>
<p><img src="./images/Nodeé…åˆWebSocketåšå¤šæ–‡ä»¶ä¸‹è½½ä»¥åŠè¿›åº¦å›ä¼ 3.png" alt="flow" /></p>
<p>é¦–å…ˆæµè§ˆå™¨ä¼šè¿æ¥<code>WebSocket</code>æœåŠ¡å™¨ï¼ŒåŒæ—¶åœ¨<code>WebSocket</code>æœåŠ¡å™¨ä¸Šå­˜åœ¨ä¸€ä¸ªæ‰€æœ‰å®¢æˆ·ç«¯çš„Mapï¼Œæµè§ˆå™¨ç«¯ç”Ÿæˆä¸€ä¸ª<code>uuid</code>ä½œä¸ºæµè§ˆå™¨å®¢æˆ·ç«¯<code>id</code>ï¼Œç„¶åå°†è¿™ä¸ªé“¾æ¥ä½œä¸ºå€¼å­˜è¿›Mapä¸­ã€‚</p>
<p>å®¢æˆ·ç«¯ï¼š</p>
<pre><code><code>// list.jsx
await WebSocketClient.connect((event) =&gt; {
  const data = JSON.parse(event.data);
  if (data.event === &#39;close&#39;) {
    this.updateCloseStatusOfProgressBar(list, data);
  } else {
    this.generateProgressBarList(list, data);
  }
});

// src/utils/websocket.client.js
async connect(onmessage, onerror) {
  const socket = this.getSocket();
  return new Promise((resolve) =&gt; {
    // ...
  });
}

getSocket() {
  if (!this.socket) {
    this.socket = new WebSocket(
      `ws://localhost:${CONFIG.PORT}?from=client&amp;id=${clientId}`,
      &#39;echo-protocol&#39;,
    );
  }
  return this.socket;
}</code></pre>
<p>æœåŠ¡ç«¯ï¼š</p>
<pre><code><code>// public/javascript/websocket/websocket.server.js
connectToServer(httpServer) {
  initWsServer(httpServer);
  wsServer.on(&#39;request&#39;, (request) =&gt; {
    // uri: ws://localhost:8888?from=client&amp;id=xxxx-xxxx-xxxx-xxxx
    logger.info(&#39;[ws server] request&#39;);
    const connection = request.accept(&#39;echo-protocol&#39;, request.origin);
    const queryStrings = querystring.parse(request.resource.replace(/(^\/|\?)/g, &#39;&#39;));
    
    // æ¯æœ‰è¿æ¥è¿åˆ°websocketæœåŠ¡å™¨ï¼Œå°±å°†å½“å‰è¿æ¥ä¿å­˜åˆ°mapä¸­
    setConnectionToMap(connection, queryStrings);
    connection.on(&#39;message&#39;, onMessage);
    connection.on(&#39;close&#39;, (reasonCode, description) =&gt; {
      logger.info(`[ws server] connection closed ${reasonCode} ${description}`);
    });
  });

  wsServer.on(&#39;close&#39;, (connection, reason, description) =&gt; {
    logger.info(&#39;[ws server] some connection disconnect.&#39;);
    logger.info(reason, description);
  });
}</code></pre>
<p>ç„¶ååœ¨æµè§ˆå™¨ç«¯ç‚¹å‡»ä¸‹è½½çš„æ—¶å€™ï¼Œä¼šä¼ é€’ä¸¤ä¸ªä¸»è¦çš„å­—æ®µ<code>resourceId</code>(åœ¨ä»£ç ä¸­ç”±<code>parentId</code>å’Œ<code>childId</code>ç»„æˆ)å’Œå®¢æˆ·ç«¯ç”Ÿæˆçš„<code>bClientId</code>ã€‚è¿™ä¸¤ä¸ª<code>id</code>æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p>
<ul>
<li>æ¯æ¬¡ç‚¹å‡»ä¸‹è½½ï¼Œéƒ½ä¼šåœ¨<code>Web</code>æœåŠ¡å™¨ä¸­ç”Ÿæˆä¸€ä¸ª<code>WebSocket</code>çš„å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆè¿™ä¸ª<code>resouceId</code>å°±æ˜¯ä½œä¸ºåœ¨æœåŠ¡å™¨ä¸­ç”Ÿæˆçš„<code>WebSocket</code>æœåŠ¡å™¨çš„<code>key</code>å€¼ã€‚</li>
<li><code>bClientId</code>ä¸»è¦æ˜¯ä¸ºäº†åŒºåˆ†æµè§ˆå™¨çš„å®¢æˆ·ç«¯ï¼Œå› ä¸ºè€ƒè™‘åˆ°åŒæ—¶å¯èƒ½ä¼šæœ‰å¤šä¸ªæµè§ˆå™¨æ¥å…¥ï¼Œè¿™æ ·åœ¨<code>WebSocket</code>æœåŠ¡å™¨ä¸­äº§ç”Ÿæ¶ˆæ¯çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç”¨è¿™ä¸ª<code>id</code>æ¥åŒºåˆ†åº”è¯¥å‘é€ç»™å“ªä¸ªæµè§ˆå™¨å®¢æˆ·ç«¯</li>
</ul>
<p>å®¢æˆ·ç«¯ï¼š</p>
<pre><code><code>// list.jsx
http.get(
  &#39;download&#39;,
  {
    code,
    filename,
    parent_id: row.id,
    child_id: childId,
    download_url: url,
    client_id: clientId,
  },
);

// routes/api.js
router.get(&#39;/download&#39;, async (req, res) =&gt; {
  const { code, filename } = req.query;
  const url = req.query.download_url;
  const clientId = req.query.client_id;
  const parentId = req.query.parent_id;
  const childId = req.query.child_id;
  const connectionId = `${parentId}-${childId}`;

  const params = {
    code,
    url,
    filename,
    parent_id: parentId,
    child_id: childId,
    client_id: clientId,
  };

  const flag = await AnnieDownloader.download(connectionId, params);
  if (flag) {
    await res.json({ code: 200 });
  } else {
    await res.json({ code: 500, msg: &#39;download error&#39; });
  }
});

// public/javascript/annie.js
async download(connectionId, params) {
    //...
  // å½“annieä¸‹è½½æ—¶ï¼Œä¼šè¿›è¡Œæ•°æ®ç›‘å¬ï¼Œè¿™é‡Œä¼šç”¨åˆ°èŠ‚æµï¼Œé˜²æ­¢è¿›åº¦å›ä¼ å¤ªå¿«ï¼ŒwebsocketæœåŠ¡å™¨æ— æ³•ååº”
  downloadProcess.stdout.on(&#39;data&#39;, throttle((chunk) =&gt; {
    try {
      if (!chunk) {
        isDownloading = false;
      }
      // è¿™é‡Œä¸»è¦åšçš„æ˜¯è§£ææ•°æ®ï¼Œç„¶åå‘é€è¿›åº¦å’Œé€Ÿåº¦ç­‰ä¿¡æ¯ç»™websocketæœåŠ¡å™¨
      getDownloadInfo(chunk, ws, params);
    } catch (e) {
      downloadSuccess = false;
      WsClient.close(params.client_id, connectionId, &#39;download error&#39;);
      this.stop(connectionId);
      logger.error(`[server annie download] error: ${e}`);
    }
  }, 500, 300));
}</code></pre>
<p>æœåŠ¡ç«¯æ”¶åˆ°è¿›åº¦ä»¥åŠé€Ÿåº¦çš„æ¶ˆæ¯åï¼Œå›ä¼ ç»™å®¢æˆ·ç«¯ï¼Œå¦‚æœè¿›åº¦è¾¾åˆ°äº†100%ï¼Œé‚£ä¹ˆå°±åˆ é™¤æ‰å­˜åœ¨<code>server</code>ä¸­çš„æœåŠ¡å™¨ä¸­èµ·çš„<code>websocket</code>çš„å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”å‘é€ä¸€ä¸ªå®¢æˆ·ç«¯è¢«å…³é—­çš„é€šçŸ¥ï¼Œé€šçŸ¥æµè§ˆå™¨å·²ç»ä¸‹è½½å®Œæˆã€‚</p>
<pre><code><code>// public/javascript/websocket/websocket.server.js
function onMessage(message) {
  const data = JSON.parse(message.utf8Data);
  const id = data.client_id;

  if (data.event === &#39;close&#39;) {
    logger.info(&#39;[ws server] close event&#39;);
    closeConnection(id, data);
  } else {
    getConnectionAndSendProgressToClient(data, id);
  }
}

function getConnectionAndSendProgressToClient(data, clientId) {
  const browserClient = clientsMap.get(clientId);
  // logger.info(`[ws server] send ${JSON.stringify(data)} to client ${clientId}`);

  if (browserClient) {
    const serverClientId = `${data.parent_id}-${data.child_id}`;
    const serverClient = clientsMap.get(serverClientId);

    // å‘é€ä»webæœåŠ¡å™¨ä¸­ä¼ è¿‡æ¥çš„è¿›åº¦ã€é€Ÿåº¦ç»™æµè§ˆå™¨
    browserClient.send(JSON.stringify(data));
    // å¦‚æœè¿›åº¦å·²ç»è¾¾åˆ°äº†100%
    if (data.progress &gt;= 100) {
      logger.info(`[ws server] file has been download successfully, progress is ${data.progress}`);
      logger.info(`[ws server] server client ${serverClientId} ready to disconnect`);
      // ä»clientsMapå°†å½“å‰çš„è¿™ä¸ªç”±webæœåŠ¡å™¨åˆ›å»ºçš„websocketå®¢æˆ·ç«¯ç§»é™¤
      // ç„¶åå…³é—­å½“å‰è¿æ¥
      // åŒæ—¶å‘é€ä¸‹è½½å®Œæˆçš„æ¶ˆæ¯ç»™æµè§ˆå™¨
      clientsMap.delete(serverClientId);
      serverClient.send(JSON.stringify({ connectionId: serverClientId, event: &#39;complete&#39; }));
      serverClient.close(&#39;download completed&#39;);
    }
  }
}</code></pre>
<p>æ•´ä½“æ¥è¯´å°±è¿™ä¹ˆå¤šï¼Œæœ‰ä¸€ç‚¹éœ€è¦æŒ‡å‡ºï¼Œ<code>annie</code>åœ¨è§£æçš„æ—¶å€™æœ‰æ—¶å€™å¯èƒ½æ¶ˆæ¯å¤„ç†ä¸æ˜¯å¾ˆç¨³å®šï¼Œå¯¼è‡´æˆ‘æ•°æ®è§£æçš„æ—¶å€™å‡ºç°äº†ä¸€äº›é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ç”¨<code>mock</code>çš„æ•°æ®ä»¥åŠ<code>mock</code>çš„è¿›åº¦æ¡å›ä¼ æ˜¯ä¸ä¼šå‡ºç°é—®é¢˜çš„ã€‚</p>
<h2 id="æœ€åæ€»ç»“">æœ€åæ€»ç»“</h2>
<p>å¤šè¯»ä¹¦ï¼Œå¤šçœ‹æŠ¥ï¼Œå°‘åƒé›¶é£Ÿï¼Œå¤šç¡è§‰ğŸ˜ªğŸ˜ªğŸ’¤</p>

</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>