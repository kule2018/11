<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='ç”µè„‘,ç”µè„‘è®²è§£,ç”µè„‘æŠ€æœ¯,ç¼–ç¨‹,ç”µè„‘æ•…éšœç»´ä¿®Reactç¬”è®°-é¦–æ¬¡æ¸²æŸ“' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>é¦–é¡µ</a></li>
</div><div onclick='hidden1()' >åˆ†äº«</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Reactç¬”è®°-é¦–æ¬¡æ¸²æŸ“</center></div><div class='banquan'>åŸæ–‡å‡ºå¤„:æœ¬æ–‡ç”±åšå®¢å›­åšä¸»Raionæä¾›ã€‚<br/>
åŸæ–‡è¿æ¥:https://www.cnblogs.com/raion/p/10704050.html</div><br>
    <h3 id="æ¸²æŸ“æœºåˆ¶">æ¸²æŸ“æœºåˆ¶</h3>
<p>æ¸²æŸ“æœºåˆ¶ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†: é¦–æ¬¡æ¸²æŸ“å’Œæ›´æ–°æ¸²æŸ“ã€‚</p>
<h4 id="é¦–æ¬¡æ¸²æŸ“">é¦–æ¬¡æ¸²æŸ“</h4>
<p>é¦–å…ˆé€šè¿‡ä¸€ä¸ªå°ä¾‹å­ï¼Œæ¥è®²è§£é¦–æ¬¡æ¸²æŸ“è¿‡ç¨‹ã€‚</p>
<pre><code><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;React App&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
<pre class="jsx"><code>import React from &#39;react&#39;;
import ReactDOM from &#39;react-dom&#39;;

class ClickCounter extends React.Component {
  constructor(props) {
    super(props);
    this.state = { count: 0 };
  }
  handleClick = () =&gt; {
    this.setState((state) =&gt; {
      return {count: state.count + 1};
    });
  }
  render() {
    return [
      &lt;button key=&quot;1&quot; onClick={this.handleClick}&gt;Update counter&lt;/button&gt;,
      &lt;span key=&quot;2&quot;&gt;{this.state.count}&lt;/span&gt;,
    ]
  }
}
ReactDOM.hydrate(&lt;ClickCounter /&gt;, document.getElementById(&#39;root&#39;));</code></pre>
<p>ç¨‹åºè¿è¡Œåˆ°<code>ReactDOM.hydrate</code>æ—¶ï¼Œå…¶ä¸­çš„<code>&lt;ClickCounter /&gt;</code>å·²è¢«<code>babel</code>è½¬æ¢ä¸º<code>React.createElement(ClickCounter, null)</code>ï¼Œç”Ÿæˆçš„<code>element</code>å¦‚ä¸‹:</p>
<pre><code><code>{
    $$typeof: Symbol(react.element),
    key: null,
    props: {},
    ref: null,
    type: ClickCounter
}</code></pre>
<p>æ¥ä¸‹æ¥æ‰§è¡Œ<code>hydrate</code>å‡½æ•°ï¼Œç”Ÿæˆ<code>root</code>èŠ‚ç‚¹ã€‚é¦–å…ˆäº†è§£ä¸‹<code>fiber</code>çš„éƒ¨åˆ†æ•°æ®ç»“æ„ã€‚</p>
<ul>
<li>alternateï¼ˆå¯¹åº”çš„<code>workInProgress</code>æˆ–<code>fiber</code>ï¼‰</li>
<li>stateNodeï¼ˆå…³è”çš„<code>fiber</code>ï¼Œç»„ä»¶å®ä¾‹æˆ–è€…<code>DOM</code>èŠ‚ç‚¹ï¼‰</li>
<li>typeï¼ˆç»„ä»¶æˆ–<code>HTML tag</code>ï¼Œå¦‚<code>div</code>ï¼Œ<code>span</code>ç­‰ï¼‰</li>
<li>tagï¼ˆç±»å‹ï¼Œè¯¦è§<a href="https://github.com/facebook/react/blob/master/packages/shared/ReactWorkTags.js">workTags</a>ï¼‰</li>
<li>effectTagï¼ˆæ“ä½œç±»å‹ï¼Œè¯¦è§<a href="https://github.com/facebook/react/blob/master/packages/shared/ReactSideEffectTags.js">sideEffectTag</a>ï¼‰</li>
<li>updateQueueï¼ˆæ›´æ–°é˜Ÿåˆ—ï¼‰</li>
<li>memoizedStateï¼ˆ<code>state</code>ï¼‰</li>
<li>memoizedPropsï¼ˆ<code>props</code>ï¼‰</li>
<li>pendingPropsï¼ˆ<code>VDOM</code>ï¼‰</li>
<li>returnï¼ˆçˆ¶<code>fiber</code>ï¼‰</li>
<li>siblingï¼ˆå…„å¼Ÿ<code>fiber</code>ï¼‰</li>
<li>childï¼ˆå­©å­<code>fiber</code>ï¼‰</li>
<li>firstEffectï¼ˆç¬¬ä¸€ä¸ªå¾…å¤„ç†çš„<code>effect fiber</code>ï¼‰</li>
<li>lastEffectï¼ˆæœ€åä¸€ä¸ªå¾…å¤„ç†çš„<code>effect fiber</code>ï¼‰</li>
</ul>
<p>é¦–æ¬¡æ¸²æŸ“ä¼šä»¥åŒæ­¥æ¸²æŸ“çš„æ–¹å¼è¿›è¡Œæ¸²æŸ“ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ª<code>update</code>ï¼Œå°†<code>element</code>è£…è½½åˆ°å…¶<code>payload</code>å±æ€§ä¸­ï¼Œç„¶ååˆå¹¶åˆ°<code>root.current.updateQueue</code>ï¼Œå¦‚æœæ²¡æœ‰<code>updateQueue</code>ä¼šåˆ›å»ºä¸€ä¸ªã€‚æˆ‘ä»¬æš‚ä¸”å°†<code>root.current</code>çœ‹æˆ<code>HostRoot</code>ã€‚</p>
<p>æ¥ç€æ ¹æ®<code>HostRoot</code>å…‹éš†ä¸€æ£µ<code>workInProgress</code>æ›´æ–°æ ‘ã€‚å°†<code>HostRoot.alternate</code>æŒ‡å‘<code>workInProgress</code>ï¼Œ<code>workInProgress.alternate</code>æŒ‡å‘<code>HostRoot</code>ã€‚ç„¶åè¿›å…¥<code>workLoop</code>è¿›è¡Œæ›´æ–°æ ‘æ“ä½œéƒ¨åˆ†ã€‚<code>workLoop</code>çš„ä»»åŠ¡ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯å°†æ‰€æœ‰èŠ‚ç‚¹çš„æ›´æ–°æŒ‚è½½åˆ°æ›´æ–°æ ‘ä¸Šã€‚ä¸‹é¢è¯¦ç»†çœ‹çœ‹<code>reconciliation</code>é˜¶æ®µã€‚</p>
<h4 id="reconciliationé˜¶æ®µ">reconciliationé˜¶æ®µ</h4>
<p><code>reconciliation</code>çš„æ ¸å¿ƒåœ¨äº<code>workLoop</code>ã€‚<code>workLoop</code>ä¼šä»¥<code>workInProgress</code>ä¸ºèµ·ç‚¹ï¼Œå³å…‹éš†çš„<code>HostRoot</code>ï¼Œä¸æ–­å‘ä¸‹å¯»æ‰¾ã€‚å¦‚æœ<code>workInProgress.child</code>ä¸ä¸ºç©ºï¼Œä¼šè¿›è¡Œ<code>diff</code>ï¼›å¦‚æœä¸ºç©ºä¼šåˆ›å»ºworkInProgress.child`ã€‚</p>
<pre class="js"><code>// ç¬¬ä¸€æ¬¡å¾ªç¯nextUnitOfWorkä¸ºworkInProgress
function workLoop(isYieldy) {
  if (!isYieldy) {
    // Flush work without yielding
    while (nextUnitOfWork !== null) {
      nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
    }
  } else {
    // Flush asynchronous work until there&#39;s a higher priority event
    while (nextUnitOfWork !== null &amp;&amp; !shouldYieldToRenderer()) {
      nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
    }
  }
}</code></pre>
<p>å› ä¸ºåªæ¶‰åŠé¦–æ¬¡æ¸²æŸ“ï¼Œæ‰€ä»¥è¿™é‡Œå°†<code>performUnitOfWork</code>ç®€å•åŒ–ã€‚<code>beginWork</code>æ ¹æ®<code>workInProgress.tag</code>é€‰æ‹©ä¸åŒçš„å¤„ç†æ–¹å¼ã€‚å…ˆæš‚ä¸”çœ‹çœ‹å¦‚ä½•å¤„ç†<code>HostRoot</code>ã€‚è¿›å…¥<code>updateHostRoot</code>æ–¹æ³•ï¼Œå…ˆè¿›è¡Œ<code>workInProgress.updateQueue</code>çš„æ›´æ–°ï¼Œè®¡ç®—æ–°çš„<code>state</code>ï¼Œå°†<code>update.baseState</code>å’Œ<code>workInProgress.memoizedState</code>æŒ‡å‘æ–°çš„<code>state</code>ã€‚è¿™é‡Œæ–°çš„<code>state</code>è£…è½½çš„æ˜¯<code>element</code>ã€‚</p>
<p>æ¥ä¸‹æ¥è°ƒç”¨<code>createFiberFromElement</code>åˆ›å»º<code>fiber</code>ï¼Œå°†<code>workInProgress.child</code>æŒ‡å‘è¯¥<code>fiber</code>ï¼Œ<code>fiber.return</code>æŒ‡å‘<code>workInProgress</code>ã€‚</p>
<pre class="js"><code>function performUnitOfWork(workInProgress) {
  let next = beginWork(workInProgress); // åˆ›å»ºworkInProgress.childå¹¶è¿”å›
  if (next === null) { // æ²¡æœ‰å­©å­ï¼Œæ”¶é›†effect listï¼Œè¿”å›å…„å¼Ÿæˆ–è€…çˆ¶fiber
      next = completeUnitOfWork(workInProgress);
  }
  return next;
}

function beginWork(workInProgress) {
  switch(workInProgress.tag) {
    case HostRoot:
      return updateHostRoot(current, workInProgress, renderExpirationTime);
    case ClassComponent: 
      ...
  }
}</code></pre>
<p>ç”¨ä¸€å¼ å›¾ä½“ç°æ›´æ–°æ ‘åˆ›å»ºå®Œæˆåçš„æ ·å­:</p>
<p><img src="./images/Reactç¬”è®°-é¦–æ¬¡æ¸²æŸ“0.png" /></p>
<p>å½“<code>workInProgress</code>æ²¡æœ‰å­©å­æ—¶ï¼Œå³åˆ›å»ºçš„å­©å­ä¸ºç©ºã€‚è¯´æ˜å·²ç»åˆ°è¾¾åº•éƒ¨ï¼Œå¼€å§‹æ”¶é›†<code>effect</code>ã€‚</p>
<pre class="js"><code>function completeUnitOfWork(workInProgress) {
  while (true) {
    let returnFiber = workInProgress.return;
    let siblingFiber = workInProgress.sibling;
    nextUnitOfWork = completeWork(workInProgress);
ã€€ã€€ ...// çœç•¥æ”¶é›†effect listè¿‡ç¨‹
    if (siblingFiber !== null) {
      // If there is a sibling, return it
      // to perform work for this sibling
      return siblingFiber;
    } else if (returnFiber !== null) {
      // If there&#39;s no more work in this returnFiber,
      // continue the loop to complete the parent.
      workInProgress = returnFiber;
      continue;
    } else {
      // We&#39;ve reached the root.
      return null;
    }
  }
}
function completeWork(workInProgress) {
  //æ ¹æ®workInProgress.tagåˆ›å»ºã€æ›´æ–°æˆ–åˆ é™¤dom
  switch(workInProgress.tag) {
    case HostComponent: 
      ...
  }
  return null;
}</code></pre>
<p>åè°ƒç®—æ³•è¿‡ç¨‹ç»“æŸåï¼Œ<code>workInProgress</code>æ›´æ–°æ ‘æ›´æ–°å®Œæ¯•ï¼Œæ”¶é›†çš„<code>effect list</code>å¦‚ä¸‹:</p>
<p><img src="./images/Reactç¬”è®°-é¦–æ¬¡æ¸²æŸ“1.png" /></p>
<h4 id="commité˜¶æ®µ">commité˜¶æ®µ</h4>
<p><code>effect list</code>(é“¾è¡¨)æ˜¯<code>reconciliation</code>é˜¶æ®µçš„ç»“æœï¼Œå†³å®šäº†å“ªäº›èŠ‚ç‚¹éœ€è¦æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤ï¼Œä»¥åŠå“ªäº›ç»„ä»¶éœ€è¦è°ƒç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€‚<code>firstEffect</code>è®°å½•ç¬¬ä¸€ä¸ªæ›´æ–°æ“ä½œï¼Œ<code>firstEffect.nextEffectï¼ˆfiberï¼‰</code>è®°å½•ä¸‹ä¸€ä¸ªï¼Œç„¶åç»§ç»­é€šè¿‡å…¶<code>nextEffect</code>ä¸æ–­å¾€ä¸‹å¯»æ‰¾ç›´è‡³ä¸º<code>null</code>ã€‚ä¸‹é¢æ˜¯commité˜¶æ®µçš„ä¸»è¦æµç¨‹:</p>
<pre class="js"><code>// finishedWorkä¸ºæ›´æ–°æ ‘
function commitRoot(root, finishedWork) {
    commitBeforeMutationLifecycles();
    commitAllHostEffects();
    root.current = finishedWork;
    commitAllLifeCycles();
}</code></pre>
<p>å˜é‡<code>nextEffect</code>æ¯æ¬¡æ‰§è¡Œå®Œä¸Šé¢ä¸€ä¸ªå‡½æ•°ä¼šè¢«é‡ç½®ä¸º<code>finishedWork</code>ã€‚</p>
<ul>
<li><strong><code>commitBeforeMutationLifecycles</code></strong></li>
</ul>
<p>æ£€æŸ¥<code>effect list</code>ä¸­æ¯ä¸ª<code>fiber</code>æ˜¯å¦æœ‰<code>Snapshot effect</code>ï¼Œå¦‚æœæœ‰åˆ™æ‰§è¡Œ<code>getSnapshotBeforeUpdate</code>ã€‚</p>
<pre class="js"><code>// è§¦å‘getSnapshotBeforeUpdate
function commitBeforeMutationLifecycles() {
  while (nextEffect !== null) {
    const effectTag = nextEffect.effectTag;
    if (effectTag &amp; Snapshot) {
      const current = nextEffect.alternate;
      commitBeforeMutationLifeCycles(current, nextEffect);
    }
    nextEffect = nextEffect.nextEffect;
  }
}</code></pre>
<ul>
<li><strong><code>commitAllHostEffects</code></strong></li>
</ul>
<p>æäº¤æ‰€æœ‰<code>effect</code>ï¼Œå®ç°<code>dom</code>çš„æ›¿æ¢ã€æ›´æ–°å’Œåˆ é™¤ã€‚</p>
<pre class="js"><code>function commitAllHostEffects() {
  while(nextEffect !== null) {
    var effectTag = nextEffect.effectTag;
    var primaryEffectTag = effectTag &amp; (Placement | Update | Deletion);
    switch (primaryEffectTag) {
      case Placement: {
        commitPlacement(nextEffect);
        ...
      }
      case PlacementAndUpdate: {
        commitPlacement(nextEffect);
        var _current = nextEffect.alternate;
        commitWork(_current, nextEffect);
        ...
      }
      case Update: {
        var _current2 = nextEffect.alternate;
        commitWork(_current2, nextEffect); 
        ...
      }
      case Deletion: {// è§¦å‘componentWillUnmout
        commitDeletion(nextEffect);
        ...
      }
    }
    nextEffect = nextEffect.nextEffect;
  }
}</code></pre>
<ul>
<li><strong><code>commitAllLifeCycles</code></strong></li>
</ul>
<p>è§¦å‘<code>componentDidMount</code>æˆ–<code>componentDidUpdate</code></p>
<pre class="js"><code>function commitAllLifeCycles(finishedRoot, committedExpirationTime) {
  while (nextEffect !== null) {
    var effectTag = nextEffect.effectTag;

    if (effectTag &amp; (Update | Callback)) {
      var current$$1 = nextEffect.alternate;
      commitLifeCycles(finishedRoot, current$$1, nextEffect, committedExpirationTime);
    }
    if (effectTag &amp; Ref) {
      commitAttachRef(nextEffect);
    }
    if (effectTag &amp; Passive) {
      rootWithPendingPassiveEffects = finishedRoot;
    }

    nextEffect = nextEffect.nextEffect;
  }
}</code></pre>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>è¿™é‡Œå¹¶æœªé€ä¸€ç»†è¯´ï¼Œä¸æƒ³è¯»èµ·æ¥ç›´çŠ¯å›°ï¼Œæ›´å¤šè®²è¿°äº†å¤§æ¦‚æµç¨‹ã€‚å¦‚æœè§‰å¾—æœ‰ç–‘æƒ‘çš„åœ°æ–¹ï¼Œä¹ŸçŸ¥é“è¯¥åœ¨ä»€ä¹ˆåœ°æ–¹æ‰¾åˆ°å¯¹åº”çš„æºç ï¼Œè§£ç­”ç–‘æƒ‘ã€‚</p>
<p>æ›´å¥½çš„é˜…è¯»ä½“éªŒåœ¨æˆ‘çš„<a href="https://github.com/cy6121/front-notes">github</a>ï¼Œæ¬¢è¿ğŸ‘æissueã€‚</p>

</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>