<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='ç”µè„‘,ç”µè„‘è®²è§£,ç”µè„‘æŠ€æœ¯,ç¼–ç¨‹,ç”µè„‘æ•…éšœç»´ä¿®koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹web apiç¯‡' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>é¦–é¡µ</a></li>
</div><div onclick='hidden1()' >åˆ†äº«</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹web apiç¯‡</center></div><div class='banquan'>åŸæ–‡å‡ºå¤„:æœ¬æ–‡ç”±åšå®¢å›­åšä¸»Jeff.Zhongæä¾›ã€‚<br/>
åŸæ–‡è¿æ¥:https://www.cnblogs.com/edwardloveyou/p/10673663.html</div><br>
    <p>åŸæ–‡åœ°å€ï¼š<a href="https://edwardzhong.github.io/2019/04/08/fullstack/">koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹web apiç¯‡</a></p>
<p>ç›®æ ‡æ˜¯å»ºç«‹ä¸€ä¸ª <strong>web QQ</strong>çš„é¡¹ç›®ï¼Œä½¿ç”¨çš„æŠ€æœ¯æ ˆå¦‚ä¸‹ï¼š</p>
<ol>
<li><p>åç«¯æ˜¯åŸºäº<strong>koa2</strong> çš„ web api æœåŠ¡å±‚ï¼Œæä¾›curdæ“ä½œçš„httpæ¥å£ï¼Œç™»å½•éªŒè¯ä½¿ç”¨çš„æ˜¯ <strong>json web token</strong>ï¼Œè·¨åŸŸæ–¹æ¡ˆä½¿ç”¨çš„æ˜¯ <strong>cors</strong>ï¼›</p></li>
<li><p>æ•°æ®åº“ä½¿ç”¨çš„æ˜¯ <strong>mysql</strong>ï¼›</p></li>
<li><p>ä¸ºäº†å®æ—¶é€šä¿¡ï¼Œä½¿ç”¨çš„æ˜¯åŸºäºwebsocketåè®®çš„ <strong>socket.io</strong> æ¡†æ¶ï¼›</p></li>
<li><p>å‰ç«¯åˆ™ä½¿ç”¨çš„æ˜¯ <strong>vue + vuex</strong>ã€‚</p></li>
</ol>
<!-- more -->
<p>æœ¬ç¯‡åˆ™è®²å™æœåŠ¡ç«¯çš„æ­å»ºï¼Œä¹‹æ‰€ä»¥ä½¿ç”¨ <strong>koa</strong>ï¼Œè€Œä¸ä½¿ç”¨å…¶ä»–å°è£…è¿‡çš„æ¡†æ¶ï¼Œæ¯”å¦‚ <strong>Egg.js</strong>ï¼Œ <strong>Thinkjs</strong>ã€‚å› ä¸ºåœ¨æˆ‘çœ‹æ¥ï¼Œ<strong>koa2</strong> å·²ç»å¤Ÿæ–¹ä¾¿ï¼Œæ’ä»¶ä¹Ÿè¶³å¤Ÿå¤šï¼Œå®Œå…¨å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œåƒæ­ç§¯æœ¨ä¸€æ ·æ„å»ºå‡ºæœ€é€‚åˆä¸šåŠ¡éœ€æ±‚çš„æ¡†æ¶ã€‚è¿™æ ·ä¸ä½†æ‘’å¼ƒäº†å¾ˆå¤šç”¨ä¸åˆ°çš„æ’ä»¶ï¼Œä½¿æ•´ä¸ªæ¡†æ¶æ›´åŠ ç²¾ç®€ï¼Œä¹Ÿèƒ½å¯¹æ•´ä¸ªæ¡†æ¶çŸ¥æ ¹çŸ¥åº•ï¼Œå‡å°‘äº†å¾ˆå¤šä¸å¯é¢„çŸ¥å› ç´ çš„å½±å“ã€‚</p>
<p>å½“ç„¶æˆ‘è§‰å¾—æœ€ä¸»è¦çš„æ˜¯æˆ‘æ¯”è¾ƒæ‡’ğŸ˜„ï¼Œä¸æƒ³å†å»å­¦å…¶ä»–æ¡†æ¶ç‰¹æœ‰çš„apiï¼Œç‰¹æœ‰çš„é…ç½®ã€‚å› ä¸ºå‰ç«¯æœ‰å¤ªå¤šæ¡†æ¶å¤ªå¤šapiéœ€è¦æŒæ¡äº†ï¼Œå¯¹äºéäº’è”ç½‘å…¬è®¤çš„æŠ€æœ¯æ ‡å‡†ï¼Œæˆ‘è§‰å¾—å­¦ä¹ çš„ä¼˜å…ˆçº§è¿˜æ˜¯è¦é åä¸€ç‚¹çš„ã€‚å› ä¸ºè¿™äº›ä¸ªæ¡†æ¶ï¼Œä¸‰å¤©ä¸¤å¤´å°±å†’å‡ºä¸ªçƒ­é—¨çš„ï¼Œç®€ç›´å¤šä¸èƒœæ•°ï¼Œå­¦ä¸è¿‡æ¥å•Šï¼Œè€ŒkoaåŸºæœ¬éƒ½æ˜¯è¿™äº›æ¡†æ¶çš„åº•å±‚ï¼Œæ˜æ˜¾é è°±å¤šäº†ã€‚</p>
<h2 id="åŸºæœ¬æ¡†æ¶æ­å»º">åŸºæœ¬æ¡†æ¶æ­å»º</h2>
<p>è¿™å‡ ä¸ªkoaæ’ä»¶å¤§éƒ¨åˆ†é¡¹ç›®å…«ä¹ä¸ç¦»åè¦ç”¨åˆ°ï¼š</p>
<ul>
<li>koa-body è§£æhttpæ•°æ®</li>
<li>koa-compress gzipå‹ç¼©</li>
<li>koa-router è·¯ç”±</li>
<li>koa-static è®¾ç½®é™æ€ç›®å½•</li>
<li>koa2-cors è·¨åŸŸcors</li>
<li>log4js è€ç‰Œçš„æ—¥å¿—ç»„ä»¶</li>
<li>jsonwebtoken jwt ç»„ä»¶</li>
</ul>
<h2 id="åŸºæœ¬çš„ç›®å½•ç»“æ„">åŸºæœ¬çš„ç›®å½•ç»“æ„</h2>
<pre><code><code>public #å…¬å…±ç›®å½•
src    #å‰ç«¯ç›®å½•
server #åç«¯ç›®å½•
â”œâ”€â”€ common #å·¥å…·
â”œâ”€â”€ config #é…ç½®æ–‡ä»¶
â”œâ”€â”€ controller #æ§åˆ¶å™¨
â”œâ”€â”€ daos   #æ•°æ®åº“è®¿é—®å±‚
â”œâ”€â”€ logs   #æ—¥å¿—ç›®å½•
â”œâ”€â”€ middleware  #ä¸­é—´ä»¶ç›®å½•
â”œâ”€â”€ socket #socketioç›®å½•
â”œâ”€â”€ app.js #å…¥å£æ–‡ä»¶
â””â”€â”€ router.js #è·¯ç”±               </code></pre>
<h2 id="å…¥å£æ–‡ä»¶app.js">å…¥å£æ–‡ä»¶app.js</h2>
<p>ä¸»è¦å°±æ˜¯å‡ ä¸ªä¸­é—´ä»¶é…ç½®éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œè¿™é‡ŒåŒæ—¶è¿˜åŠ è½½äº† socket.io æœåŠ¡ã€‚socket.io ç›¸å…³çš„åŸºæœ¬çŸ¥è¯†ç‚¹å¯ä»¥çœ‹æˆ‘ä¹‹å‰å†™çš„æ–‡ç« <a href="https://www.cnblogs.com/edwardloveyou/p/10625152.html">å…³äºsocket.ioçš„ä½¿ç”¨</a>ã€‚</p>
<pre class="javascript"><code>//app.js
//...
const path = require(&quot;path&quot;);
const baseDir = path.normalize(__dirname + &quot;/..&quot;);

// gzip
app.use(
  compress({
    filter: function(content_type) {
      return /text|javascript/i.test(content_type);
    },
    threshold: 2048,
    flush: require(&quot;zlib&quot;).Z_SYNC_FLUSH
  })
);

// è§£æè¯·æ±‚
app.use(
  koaBody({
    jsonLimit: 1024 * 1024 * 5,
    formLimit: 1024 * 1024 * 5,
    textLimit: 1024 * 1024 * 5,
    multipart: true, // è§£æFormDataæ•°æ®
    formidable: { uploadDir: path.join(baseDir, &quot;public/upload&quot;) }//ä¸Šä¼ æ–‡ä»¶ç›®å½•
  })
);

// è®¾ç½®é™æ€ç›®å½•
app.use(static(path.join(baseDir, &quot;public&quot;), { index: false }));
app.use(favicon(path.join(baseDir, &quot;public/favicon.ico&quot;)));

//cors
app.use(
  cors({
    origin: &quot;http://localhost:&quot; + config.clientPort,
    credentials: true,
    allowMethods: [&quot;GET&quot;, &quot;POST&quot;, &quot;DELETE&quot;],
    exposeHeaders: [&quot;Authorization&quot;],
    allowHeaders: [&quot;Content-Type&quot;, &quot;Authorization&quot;, &quot;Accept&quot;]
  })
);

//json-web-tokenä¸­é—´ä»¶
app.use(
  jwt({
    secret: config.secret,
    exp: config.exp
  })
);

// ç™»å½•éªŒè¯ä¸­é—´ä»¶ï¼Œexclude è¡¨ç¤ºä¸éªŒè¯çš„é¡µé¢ï¼Œinclude è¡¨ç¤ºè¦éªŒè¯çš„é¡µé¢
app.use(
  verify({
    exclude: [&quot;/login&quot;, &quot;/register&quot;, &quot;/search&quot;]
  })
);

// é”™è¯¯å¤„ç†ä¸­é—´ä»¶
app.use(errorHandler()); 

// è·¯ç”±
addRouters(router);
app.use(router.routes()).use(router.allowedMethods());

// å¤„ç†404
app.use(async (ctx, next) =&gt; {
  log.error(`404 ${ctx.message} : ${ctx.href}`);
  ctx.status = 404;
  ctx.body = { code: 404, message: &quot;404! not found !&quot; };
});

// å¤„ç†ä¸­é—´ä»¶å’Œç³»ç»Ÿé”™è¯¯
app.on(&quot;error&quot;, (err, ctx) =&gt; {
  log.error(err); //log all errors
  ctx.status = 500;
  ctx.statusText = &quot;Internal Server Error&quot;;
  if (ctx.app.env === &quot;development&quot;) {
    //throw the error to frontEnd when in the develop mode
    ctx.res.end(err.stack); //finish the response
  } else {
    ctx.body = { code: -1, message: &quot;Server Error&quot; };
  }
});

if (!module.parent) {
  const { port, socketPort } = config;
  /**
   * koa app
   */
  app.listen(port);
  log.info(`=== app server running on port ${port}===`);
  console.log(&quot;app server running at: http://localhost:%d&quot;, port);

  /**
   * socket.io
   */
  addSocket(io);
  server.listen(socketPort);
}</code></pre>
<h2 id="è·¨åŸŸcors-å’Œ-json-web-token">è·¨åŸŸcors å’Œ json web token</h2>
<p>è¿™é‡Œè§£é‡Šä¸€ä¸‹ koa-cors å‚æ•°çš„è®¾ç½®ï¼Œæˆ‘é¡¹ç›®ä½¿ç”¨çš„æ˜¯ json web tokenï¼Œéœ€è¦æŠŠè®¤è¯å­—æ®µAuthorizationæ·»åŠ åˆ°headerï¼Œå‰ç«¯è·å–è¯¥headerå­—æ®µï¼Œä¹‹åç»™åå°å‘é€httpè¯·æ±‚çš„æ—¶å€™ï¼Œå†å¸¦ä¸Šè¯¥Authorizationã€‚</p>
<ul>
<li>originï¼šå¦‚æœè¦è®¿é—®headeré‡Œé¢çš„å­—æ®µæˆ–è€…è®¾ç½®cookieï¼Œè¦å†™å…·ä½“çš„åŸŸååœ°å€ï¼Œç”¨ æ˜Ÿå· * æ˜¯ä¸è¡Œçš„ï¼›</li>
<li>credentialsï¼šä¸»è¦æ˜¯ç»™å‰ç«¯è·å–cookieï¼›</li>
<li>allowMethodsï¼šå…è®¸è®¿é—®çš„æ–¹æ³•ï¼›</li>
<li>exposeHeadersï¼šå‰ç«¯å¦‚æœè¦è·å–è¯¥headerå­—æ®µï¼Œå¿…é¡»å†™æ˜ï¼ˆjson web tokenç”¨ï¼‰ï¼›</li>
<li>allowHeadersï¼šæ·»åŠ åˆ°headerçš„å­—æ®µï¼›</li>
</ul>
<p>è‡³äº json web tokençš„åŸç†ï¼Œç½‘ä¸Šèµ„æ–™é½å…¨ï¼Œè¿™é‡Œä¸å†ä»‹ç»äº†ã€‚</p>
<pre class="javascript"><code>app.use(
  cors({
    origin: &quot;http://localhost:&quot; + config.clientPort, // è®¿é—®header,è¦å†™æ˜å…·ä½“åŸŸåæ‰è¡Œ
    credentials: true, //å°†å‡­è¯æš´éœ²å‡ºæ¥, å‰ç«¯æ‰èƒ½è·å–cookie
    allowMethods: [&quot;GET&quot;, &quot;POST&quot;, &quot;DELETE&quot;],
    exposeHeaders: [&quot;Authorization&quot;], // å°†headerå­—æ®µexposeå‡ºå»
    allowHeaders: [&quot;Content-Type&quot;, &quot;Authorization&quot;, &quot;Accept&quot;] // å…è®¸æ·»åŠ åˆ°headerçš„å­—æ®µ
  })
);</code></pre>
<h2 id="ä¸­é—´ä»¶middleware">ä¸­é—´ä»¶middleware</h2>
<p>koa çš„ä¸­é—´ä»¶å°±æ˜¯ webå¼€å‘çš„åˆ©å™¨ï¼Œé€šè¿‡å®ƒå¯ä»¥éå¸¸æ–¹ä¾¿çš„å®ç° å¼ºç±»å‹è¯­è¨€ä¸­çš„ <strong>aop</strong> åˆ‡é¢ç¼–ç¨‹ï¼Œè€Œkoa2 ä¸­é—´ä»¶ çš„ç¼–å†™ä¹Ÿè¶³å¤Ÿç®€å• <a href="http://koajs.cn/">koajs</a>ã€‚</p>
<p>é¡¹ç›®åœ¨ä»¥ä¸‹å‡ ä¸ªåœ°æ–¹éƒ½ç”¨ä¸­é—´ä»¶è¿›è¡Œäº†å°è£…ï¼Œå¾ˆå¤šé‡å¤çš„æ ·æ¿ä»£ç å› æ­¤å¾—ä»¥ç®€åŒ–ã€‚</p>
<ul>
<li>json web tokenï¼ˆjwtï¼‰</li>
<li>ç™»å½•éªŒè¯ï¼ˆverifyï¼‰</li>
<li>é”™è¯¯å¤„ç†ï¼ˆerrorHandlerï¼‰</li>
</ul>
<p>å°±ä»¥æœ€ç®€å•çš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶ä¸ºä¾‹å­ï¼Œå¦‚æœä¸ä½¿ç”¨é”™è¯¯å¤„ç†ä¸­é—´ä»¶ï¼Œæˆ‘ä»¬éœ€è¦æ¯ä¸ªæ§åˆ¶å™¨æ–¹æ³•è¿›è¡Œ <strong>try{â€¦} catch{â€¦}</strong> ï¼Œå…¶ä»–ä¸­é—´ä»¶ç¼–å†™æ–¹å¼ç±»ä¼¼ï¼Œå°±ä¸å†ä»‹ç»ã€‚</p>
<pre class="javascript"><code>/**
 * error handler ä¸­é—´ä»¶
 */
module.exports = () =&gt; {
    return async (ctx, next) =&gt; {
        try {
            await next();//æ²¡æœ‰é”™è¯¯åˆ™è¿›å…¥ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
        } catch (err) {
            log.error(err);
            let obj = {
                code: -1,
                message: &#39;æœåŠ¡å™¨é”™è¯¯&#39;
            };
            if (ctx.app.env === &#39;development&#39;) {
                obj.err = err;
            }
            ctx.body = obj
        }
    };
};

// æ§åˆ¶å™¨ä»£ç ä½¿ç”¨error handlerä¸­é—´ä»¶åï¼Œæ¯ä¸ªæ–¹æ³•éƒ½ä¸éœ€è¦ try catchå¤„ç†é”™è¯¯ï¼Œè®°å½•é”™è¯¯æ—¥å¿—ï¼Œå¤„ç†é€»è¾‘éƒ½é›†ä¸­åœ¨ä¸­é—´ä»¶é‡Œé¢äº†ã€‚
exports.getInfo = async function(ctx) {
    // try {
        const token = await ctx.verify();
        const [users, friends] = await Promise.all([
            userDao.getUser({ id: token.uid }),
            getFriends([token.uid])
        ]);

        const msgs = applys.map(formatTime);
        ctx.body = {
            code: 0,
            message: &quot;å¥½å‹åˆ—è¡¨&quot;,
            data: {
                user: users[0],
                friends: mergeReads(friends, reads),
                groups,
                msgs
            }
        };
    // } catch (err) {
    //     log.error(err);
    //     let obj = {
    //         code: -1,
    //         message: &quot;æœåŠ¡å™¨é”™è¯¯&quot;
    //     };
    //     if (ctx.app.env === &quot;development&quot;) {
    //         obj.err = err;
    //     }
    //     ctx.body = obj;
    // }
};</code></pre>
<h2 id="è·¯ç”±é…ç½®">è·¯ç”±é…ç½®</h2>
<p>è·¯ç”±é…ç½®åªä½¿ç”¨äº†getï¼Œpost æ–¹æ³•ï¼Œå½“ç„¶è¦ä½¿ç”¨ putï¼Œdeleteä¹Ÿåªæ˜¯æ”¹ä¸€ä¸‹åå­—å°±è¡Œã€‚</p>
<pre class="javascript"><code>// router.js
const { uploadFile } = require(&#39;./controller/file&#39;)
const { login, register } = require(&#39;./controller/sign&#39;)
const { addGroup, delGroup, updateGroup } = require(&#39;./controller/group&#39;)
//...

module.exports = function (router) {
    router
        .post(&#39;/login&#39;, login)
        .post(&#39;/register&#39;, register)
        .post(&#39;/upload&#39;, uploadFile)
        .post(&#39;/addgroup&#39;, addGroup)
        .post(&#39;/delgroup&#39;, delGroup)
        .post(&#39;/updategroup&#39;, updateGroup)
            //...
};</code></pre>
<h2 id="æ§åˆ¶å™¨">æ§åˆ¶å™¨</h2>
<p>ä»¥updateInfoæ–¹æ³•ä¸ºä¾‹ï¼Œkoa2 å·²ç»å…¨é¢æ”¯æŒ <strong>async await</strong>ï¼Œç¼–å†™æ–¹å¼å’ŒåŒæ­¥ä»£ç æ²¡å¤šå¤§åŒºåˆ«ã€‚</p>
<pre class="javascript"><code>exports.updateInfo = async function (ctx) {
    const form = ctx.request.body;
    const token = await ctx.verify();
    const ret = await userDao.update([form, token.uid]);
    if (!ret.affectedRows) {
        return ctx.body = {
            code: 2,
            message: &#39;æ›´æ–°å¤±è´¥&#39;
        };
    }
    ctx.body = {
        code: 0,
        message: &#39;æ›´æ–°æˆåŠŸ&#39;
    };
}</code></pre>
<h2 id="åç»­">åç»­</h2>
<p>æ¥ç€ä¸‹ä¸€ç¼–å°±æ˜¯åŸºäº mysql æ„å»º æ•°æ®åº“è®¿é—®å±‚ã€‚</p>

</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>