<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='ç”µè„‘,ç”µè„‘è®²è§£,ç”µè„‘æŠ€æœ¯,ç¼–ç¨‹,ç”µè„‘æ•…éšœç»´ä¿®koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹å‰ç«¯ç¯‡' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>é¦–é¡µ</a></li>
</div><div onclick='hidden1()' >åˆ†äº«</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹å‰ç«¯ç¯‡</center></div><div class='banquan'>åŸæ–‡å‡ºå¤„:æœ¬æ–‡ç”±åšå®¢å›­åšä¸»Jeff.Zhongæä¾›ã€‚<br/>
åŸæ–‡è¿æ¥:https://www.cnblogs.com/edwardloveyou/p/10702471.html</div><br>
    <p>åŸæ–‡åœ°å€ï¼š<a href="https://edwardzhong.github.io/2019/04/13/fullstack3/">koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹å‰ç«¯ç¯‡</a></p>
<p><strong>React</strong> ä¸ <strong>Vue</strong> ä¹‹é—´çš„å¯¹æ¯”ï¼Œæ˜¯å‰ç«¯çš„ä¸€å¤§çƒ­é—¨è¯é¢˜ã€‚</p>
<ul>
<li><p><strong>vue</strong> ç®€æ˜“ä¸Šæ‰‹çš„è„šæ‰‹æ¶ï¼Œä»¥åŠå®˜æ–¹æä¾›å¿…å¤‡çš„åŸºç¡€ç»„ä»¶ï¼Œæ¯”å¦‚ <strong>vuex</strong>ï¼Œ<strong>vue-router</strong>ï¼Œå¯¹æ–°æ‰‹çœŸçš„æ¯”è¾ƒå‹å¥½ï¼›<strong>react</strong> åˆ™æŠŠè¿™äº›éƒ½äº¤ç»™ç¤¾åŒºå»åšï¼Œè™½ç„¶è¿™å£®å¤§äº† <strong>react</strong> çš„ç”Ÿæ€é“¾ï¼Œä½†æ–°æ‰‹è¦å¼„å‡ºä¸€å¥—è¶æ‰‹çš„æ–¹æ¡ˆæŒºéº»çƒ¦çš„ï¼Œä¸è¿‡å¥½åœ¨ç°åœ¨æœ‰å¾ˆå¤šç±»ä¼¼ dvaçš„æ–¹æ¡ˆäº†ã€‚</p></li>
<li><p><strong>vue</strong> æ¯”è¾ƒè®¨å–œçš„ä¸€ç‚¹ï¼Œå°±æ˜¯å®ƒçš„æ•°æ®åŒå‘æµåŠ¨åœ¨è¡¨å•å¼€å‘æ—¶ç‰¹åˆ«æ–¹ä¾¿ï¼Œè€Œ <strong>react</strong> åœ¨è¿™æ–¹é¢å¯å°±éº»çƒ¦å¤šäº†ã€‚</p></li>
<li><p>ä½†æ˜¯ <strong>vue</strong> å¤æ‚çš„ api ï¼Œç®€ç›´è®©äººå¤´å¤§ï¼Œå…‰æ˜¯æ–‡æ¡£è¯´æ˜éƒ½å‡ åé¡µäº†ã€‚å¤ªå¤šçš„è¯­æ³•ï¼Œå¤ªå¤šçš„é­”æ³•ç¬¦å·ï¼Œå¯¹è¿›åŒ–é€Ÿåº¦è¶Šæ¥è¶Šå¿«çš„å‰ç«¯å±Šæ¥è¯´ï¼Œå°±æ˜¯å…¥æ‰‹è¿™ä¸ªæ¡†æ¶çš„æœ€å¤§é˜»ç¢ã€‚</p></li>
<li><p>è€Œç›¸å <strong>react</strong> çš„ api æ•°é‡ç®€ç›´å¯ä»¥å¿½ç•¥ä¸è®¡äº†ï¼Œé¡¶å¤šèŠ±å‡ å°æ—¶å°±èƒ½çœ‹å®Œå®˜æ–¹æ–‡æ¡£ã€‚ä½ åªè¦ç†è§£ <strong>JavaScript</strong>ï¼Œå°±èƒ½ç†è§£ <strong>react</strong> çš„å¾ˆå¤šè¡Œä¸ºã€‚<strong>react</strong> çš„å¾ˆå¤šç”¨æ³•ï¼Œå®ƒçš„ api éƒ½æ˜¯ç¬¦åˆç›´è§‰çš„ï¼Œä½ å¯¹å®ƒç”¨æ³•çš„çŒœæµ‹åŸºæœ¬éƒ½æ˜¯å…«ä¹ä¸ç¦»åçš„ï¼Œè¿™çœŸæ˜¯å¤§å¤§é™ä½äº†å¿ƒæ™ºè´Ÿæ‹…ã€‚</p></li>
<li><p>é™¤æ­¤ä¹‹å¤–ï¼Œ<strong>react</strong> çš„ <strong>jsx</strong> è¯­æ³•è¡¨è¾¾èƒ½åŠ›æ›´å¼ºï¼Œè¿˜æœ‰ <strong>hoc</strong> å’Œ <strong>hooks</strong> ä½¿ä»£ç ä¹Ÿæ›´å®¹æ˜“ç»„ç»‡å’Œå¤ç”¨ã€‚</p></li>
</ul>
<p>è™½ç„¶æˆ‘æ›´å–œæ¬¢ <strong>React</strong> ï¼Œä½†å·¥ä½œä¸Šçš„éœ€æ±‚ï¼Œè¿˜ä¸æ˜¯è¦ä½ ç”¨ä»€ä¹ˆä½ å°±å¾—ç”¨ä»€ä¹ˆğŸ˜‚ï¼Œæ‰€ä»¥è¿™ä¸ª demo å°±å½“æ˜¯æ¢ç´¢ <strong>Vue</strong> çš„å‰å¥ã€‚</p>
<!-- more -->
<p>ä¹‹å‰æˆ‘è¿˜æ˜¯æœ‰ç”¨è¿‡ <strong>vue</strong> çš„ï¼Œè®°å¾—è¿˜æ˜¯ 1.0 ç‰ˆæœ¬ï¼Œå½“æ—¶çš„æ½®æµå°±æ˜¯ç±»ä¼¼ <strong>angular</strong> 1.x çš„ <strong>mvvm</strong> æ–¹æ¡ˆï¼Œæ•°æ®åŒå‘æµåŠ¨ã€‚é‚£æ—¶çš„ <strong>vue</strong> è¿œæ²¡æœ‰ç°åœ¨çš„çƒ­åº¦ï¼Œç»„ä»¶ä¹Ÿå°‘ï¼Œæ²¡æœ‰ <strong>vue-router</strong>ï¼Œæ²¡æœ‰ <strong>vuex</strong>ï¼Œç»„ä»¶ä¹‹å‰çš„é€šä¿¡ç®€ç›´å¤ªç—›è‹¦äº†ã€‚ç°åœ¨ <strong>vue</strong> 2.x æ¯”èµ·ä¹‹å‰ï¼Œå·²ç»å‘ç”Ÿäº†å¤©ç¿»åœ°è¦†çš„å˜åŒ–ï¼Œ<strong>vue</strong> ä¹Ÿåœ¨ä¸æ–­å‘ <strong>react</strong> é æ‹¢ï¼Œè€Œæˆ‘ä¹Ÿåªèƒ½ä»å¤´å¼€å§‹å­¦èµ·ã€‚</p>
<p>é—²è¯è¯´å¾—æœ‰ç‚¹å¤šï¼Œè¿˜æ˜¯èµ¶ç´§è¿›å…¥ä¸»é¢˜å§</p>
<h2 id="é¡¹ç›®é…ç½®">é¡¹ç›®é…ç½®</h2>
<p>é€‰æ‹© webpack 4 æ‰“åŒ…å’Œç®¡ç†ï¼Œtemplate å¼•æ“ä½¿ç”¨ pug ï¼Œcss é¢„ç¼–è¯‘æ˜¯ scssã€‚</p>
<h4 id="webpack.common.js-çš„é…ç½®">webpack.common.js çš„é…ç½®</h4>
<pre><code><code>// webpack.common.js
module.exports = {
    entry: &#39;./src/main.js&#39;,
    output: {
        path: resolve(__dirname, &#39;dist&#39;),
        filename: &#39;[name]-[hash].js&#39;//è¾“å‡ºæ–‡ä»¶æ·»åŠ hash
    },
    optimization: { // ä»£æ›¿commonchunk, ä»£ç åˆ†å‰²
        runtimeChunk: &#39;single&#39;,
        splitChunks: {
            cacheGroups: {
                vendor: {
                    test: /[\\/]node_modules[\\/]/,
                    name: &#39;vendors&#39;,
                    chunks: &#39;all&#39;
                }
            }
        }
    },
    module: {
        rules: [
            {
                test:/\.vue$/,
                exclude: /node_modules/,
                use:[&#39;vue-loader&#39;]
            },
            {
                test: /\.js?$/,
                exclude: /node_modules/,
                use: [&#39;babel-loader&#39;]//&#39;eslint-loader&#39;
            },
            {
                test: /\.pug$/,
                use: [&#39;pug-plain-loader&#39;]
            },
            {
                test: /\.css$/,
                use: [&#39;style-loader&#39;, &#39;css-loader&#39;]
            },
            {
                test: /\.scss$/,
                use: [&#39;style-loader&#39;, &#39;css-loader&#39;, &#39;postcss-loader&#39;, &#39;sass-loader&#39;]
            },
            {   
                test: /\.(png|jpg|jpeg|gif|eot|ttf|woff|woff2|svg|svgz)(\?.+)?$/,
                use: [{
                    loader: &#39;url-loader&#39;,
                    options: {
                        limit: 1000
                    }
                }]
            }
        ]
    },
    plugins: [
        new VueLoaderPlugin(),
        new CleanWebpackPlugin([resolve(__dirname, &#39;dist&#39;)]),//ç”Ÿæˆæ–°æ–‡ä»¶æ—¶ï¼Œæ¸…ç©ºç”Ÿå‡ºç›®å½•
        new HtmlWebpackPlugin({
            template: &#39;./public/index.html&#39;,//æ¨¡ç‰ˆè·¯å¾„
            filename: &#39;index.html&#39;,//ç”Ÿæˆåçš„æ–‡ä»¶å,é»˜è®¤index.html
            favicon: &#39;./public/favicon.ico&#39;,
            minify: {
                removeAttributeQuotes:true,
                removeComments: true,
                collapseWhitespace: true,
                removeScriptTypeAttributes:true,
                removeStyleLinkTypeAttributes:true
             }
        }),
        new HotModuleReplacementPlugin()//HMR
    ]
};</code></pre>
<h4 id="webpack.dev.js-çš„é…ç½®">webpack.dev.js çš„é…ç½®</h4>
<p>å°±æ˜¯å¼€å‘æœåŠ¡å™¨ devServerçš„é…ç½®ï¼Œç›‘æ§ä»£ç å˜æ›´ã€‚</p>
<pre><code><code>// webpack.dev.js
module.exports = merge(common, {
    mode: &#39;development&#39;,
    devtool: &#39;inline-source-map&#39;,
    devServer: {
        contentBase: &#39;./dist&#39;,
        index:&#39;index.html&#39;,
        port: 3002,
        compress: true,
        historyApiFallback: true,
        hot: true
    }
});</code></pre>
<h4 id="babel.config.js-çš„é…ç½®">babel.config.js çš„é…ç½®</h4>
<pre><code><code>module.exports = {
  presets: [
    [
      &#39;@vue/app&#39;, {
        &quot;useBuiltIns&quot;: &quot;entry&quot;
      }
    ]
  ]
}</code></pre>
<h2 id="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</h2>
<pre class="bash"><code>public #å…¬å…±ç›®å½•
server #åç«¯ç›®å½•
src    #å‰ç«¯ç›®å½•
â”œâ”€â”€ assets #é™æ€æ–‡ä»¶ç›®å½•
â”œâ”€â”€ common #å·¥å…·ç›®å½•
â”œâ”€â”€ components #ç»„ä»¶ç›®å½•
â”œâ”€â”€ store   # vuex storeç›®å½•
â”œâ”€â”€ App.vue # æ ¹ç»„ä»¶
â”œâ”€â”€ main.js # å…¥å£æ–‡ä»¶
â””â”€â”€ router.js #è·¯ç”±    </code></pre>
<h2 id="å…¥å£å’Œè·¯ç”±">å…¥å£å’Œè·¯ç”±</h2>
<h4 id="è·¯ç”±æ–‡ä»¶">è·¯ç”±æ–‡ä»¶</h4>
<p>ä¸‹é¢ä½¿ç”¨äº†åµŒå¥—è·¯ç”±ï¼Œä½¿ç”¨çš„æ˜¯åŸºäº history çš„è·¯ç”±ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©åŸºäº hashchangeçš„è·¯ç”±ã€‚</p>
<pre><code><code>import Vue from &#39;vue&#39;
import Router from &#39;vue-router&#39;
//...

Vue.use(Router)

//è·¯ç”±
const routes = [{
    path: &#39;/&#39;,
    name: &#39;home&#39;,
    component: Index
},{
    path: &#39;/sign&#39;,
    name: &#39;sign&#39;,
    component: Sign,
    children: [ //åµŒå¥—è·¯ç”±
        {
            path: &quot;log&quot;,
            name: &quot;login&quot;,
            component: Login
        },
        {
            path: &quot;reg&quot;,
            name: &quot;register&quot;,
            component: Register
        },
        { path: &#39;*&#39;, redirect: &#39;log&#39; }
    ]
}, { path: &#39;*&#39;, redirect: &#39;/&#39; }]

export default new Router({
    mode: &quot;history&quot;,
    routes
})</code></pre>
<h4 id="å…¥å£æ–‡ä»¶">å…¥å£æ–‡ä»¶</h4>
<p>æŠŠrouterï¼Œstore å’Œæ ¹ç»„ä»¶ç»„åˆèµ·æ¥</p>
<pre><code><code>import Vue from &#39;vue&#39;
import App from &#39;./App.vue&#39;
import router from &#39;./router&#39;
import store from &#39;./store&#39;
import &#39;../public/base.min.css&#39;
import &#39;../public/fontello.css&#39;

Vue.config.productionTip = false
new Vue({
    router,
    store,
    render: h =&gt; h(App),
}).$mount(&#39;#app&#39;)</code></pre>
<h2 id="æ¨¡å—çš„ç¼–å†™">æ¨¡å—çš„ç¼–å†™</h2>
<p>æ¨¡ç‰ˆï¼Œé€»è¾‘ä»£ç ï¼Œæ ·å¼åˆæˆåˆ°ä¸€ä¸ªé¡µé¢ä¹Ÿæ˜¯æˆ‘æ¬£èµ <strong>vue</strong> çš„ä¸€ä¸ªæ–¹é¢ï¼Œå› ä¸ºè¿™æ ·ä½ å°±ä¸éœ€è¦åœ¨å¤šä¸ªæ–‡ä»¶ä¹‹é—´åå¤çš„åˆ‡æ¢ã€‚</p>
<h4 id="æ¨¡ç‰ˆtemplate">æ¨¡ç‰ˆtemplate</h4>
<p><strong>pug</strong> å°±æ˜¯ä¹‹å‰çš„ jadeï¼Œå®ƒçš„ç®€æ´åœ¨å¤æ‚çš„é¡µé¢ä¸‹ä¼šè®© <strong>template</strong> æ¸…æ™°ä¸å°‘ï¼Œæœ€èµ·ç ä¼šè®©ä½ å°‘æ•²ä»£ç ï¼Œè¿™é‡Œä»¥index é¡µé¢çš„éƒ¨åˆ†ä»£ç ä¸ºä¾‹ã€‚</p>
<pre class="jade"><code>&lt;template lang=&quot;pug&quot;&gt;
div.content
    div.bar
        header(v-drag)
            div.avatar(v-on:click=&quot;profile(selfInfo)&quot;)
                img(:src=&quot;selfInfo.avatar? selfInfo.avatar: aPic.src&quot;) 
            div.name {{ selfInfo.nick }}
                p {{ selfInfo.signature}}
            i.icon-logout(v-on:click=&quot;logout&quot;)
        div.body
            div.main-panel(v-if=&quot;!isSearch&quot;)        
                nav
                    div(v-on:click=&quot;showTab(0)&quot; :class=&quot;{active:tabIndex==0}&quot;) å¥½å‹
                    div(v-on:click=&quot;showTab(1)&quot; :class=&quot;{active:tabIndex==1}&quot;) åˆ†ç»„
                    div(v-on:click=&quot;showTab(2)&quot; :class=&quot;{active:tabIndex==2}&quot;) æ¶ˆæ¯
                        span(v-if=&quot;dealCount&quot;) {{dealCount}}    
                ul.friends(v-if=&quot;tabIndex == 0&quot;)
                    li(v-for=&quot;item in friends&quot; :key=&quot;item.id&quot;)
                        div.avatar(v-on:click=&quot;profile(item)&quot;)
                            img(:src=&quot;item.avatar? item.avatar: aPic.src&quot;) 
                        p(v-on:click=&quot;chatWin(item)&quot;) {{item.nick}}
                        span(v-if=&quot;item.reads &amp;&amp; item.reads &gt; 0&quot;) ({{item.reads}})
        //åŠ¨æ€åˆ›å»ºç»„ä»¶
    component(:is=&quot;item.component&quot;  v-for=&quot;(item,i) in wins&quot; :key=&quot;item.id&quot; 
        :info=&quot;item.info&quot;
        :sty=&quot;item.sty&quot;
        :msgs=&quot;item.msgs&quot;
        v-on:close=&quot;closeWin(i)&quot;
        v-on:setZ=&quot;setZ(i)&quot;)
&lt;/template&gt;</code></pre>
<h4 id="åŠ¨æ€åˆ›å»ºç»„ä»¶">åŠ¨æ€åˆ›å»ºç»„ä»¶</h4>
<p>ä¸Šé¢ç”¨åˆ°äº† vue çš„ åŠ¨æ€åˆ›å»ºç»„ä»¶ çš„æ¦‚å¿µï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Ÿè¿™ä¸ªç»„ä»¶åœ¨å½“å‰é¡µé¢ä¸­æ˜¯ä¸å­˜åœ¨çš„ï¼Œéœ€è¦æˆ‘ä»¬è§¦å‘ä¹‹åï¼Œæ‰å¼€å§‹åˆ›å»ºã€‚æ¯”å¦‚ï¼Œå½“ä½ ç‚¹å‡»æŸä¸ªæŒ‰é’®ï¼Œæ‰å¼€å§‹åŠ è½½åˆ›å»ºç»„ä»¶ï¼Œç„¶åå¡«å……åˆ°é¡µé¢ä¸­æ¥ã€‚ä¸‹é¢å°±æ˜¯åŠ¨æ€ç»„ä»¶ç›¸å…³åŠŸèƒ½çš„ç¼–å†™ã€‚</p>
<pre><code><code>data() {
    return {
       wins: [] //ç»„ä»¶åˆ—è¡¨
    }
},
methods: {  
  addWin(info, com) { // æ·»åŠ ç»„ä»¶çš„æ–¹æ³•
      this.wins.push({
          msgs: info.msgs || [],
          info,
          sty: {
              left: l * 30 + 270,
              top: l * 30 + 30,
              z: 0
          },
          component: com
      });
  }
}  

//å¡«å……ç»„ä»¶
component(:is=&quot;item.component&quot;  v-for=&quot;(item,i) in wins&quot; :key=&quot;item.id&quot; 
  :info=&quot;item.info&quot;
  :sty=&quot;item.sty&quot;
  :msgs=&quot;item.msgs&quot;
  v-on:close=&quot;closeWin(i)&quot;
  v-on:setZ=&quot;setZ(i)&quot;)</code></pre>
<h4 id="javascriptéƒ¨åˆ†">javascriptéƒ¨åˆ†</h4>
<p>è¿™é‡Œå°±æ˜¯ä¸šåŠ¡é€»è¾‘çš„éƒ¨åˆ†äº†ï¼Œä»¥éƒ¨åˆ†ä»£ç ä¸ºä¾‹, å…·ä½“çš„éƒ¨åˆ†å‚è€ƒå®˜æ–¹çš„æ–‡æ¡£</p>
<pre class="vue"><code>&lt;script&gt;
import { mapState, mapGetters } from &quot;vuex&quot;;
import ChatMsg from &quot;./ChatMsg.vue&quot;;
import Profile from &quot;./Profile.vue&quot;;
import { get, post } from &quot;../common/request&quot;;

export default {
    name: &quot;index&quot;,
    data() {
        return {
            tabIndex: 0,
            wins: [],
            aPic: {
                src: require(&quot;../assets/avatar.jpg&quot;)
            }
        };
    },
    async created() {
        //...
    },
    computed: {
        ...mapState([&quot;selfInfo&quot;]),
        ...mapGetters([
            &quot;isLogin&quot;,
            &quot;friends&quot;,
            &quot;msgs&quot;
        ])
    },
    watch: {
        isLogin: {
            //ç›‘å¬ç™»å½•çŠ¶æ€
            handler: function(val, old) {
                            //...
            }
            // ,immediate: true //è¿›å…¥ç»„ä»¶ç«‹å³æ‰§è¡Œä¸€æ¬¡
        }
    },
    methods: {
        addWin(info, com) {},
      sendMsg(user,data){}
      //...
      }
}
&lt;/script&gt;</code></pre>
<h4 id="styleéƒ¨åˆ†">styleéƒ¨åˆ†</h4>
<p>ä½¿ç”¨äº† <strong>vue</strong> é»˜è®¤çš„ <strong>scoped</strong> ï¼Œå½“ç„¶æœ€å®Œå–„çš„æ–¹æ¡ˆæ˜¯ <strong>css-module</strong>ï¼Œé…ç½®è¦å¤æ‚ä¸€äº›ï¼Œå½“ç„¶è¿™è¦çœ‹ä½ é¡¹ç›®éœ€æ±‚ã€‚é¢„ç¼–è¯‘å™¨ä½¿ç”¨çš„æ˜¯ <strong>scss</strong>ï¼Œä¸ªäººè®¤ä¸ºæ¯”è¾ƒå¼ºå¤§å’Œæ–¹ä¾¿ã€‚</p>
<pre class="vue"><code>&lt;style lang=&quot;scss&quot; scoped&gt;
$blue: hsl(200, 100%, 45%);
@mixin nowrap {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.content {
    height: 100%;
    width: 1000px;
    margin: 0 auto;
    position: relative;
}
.main-panel {
    width: 100%;
}
.search-panel {
    width: 100%;
    min-height: 313px;
    max-height: 513px;
    li {
        line-height: 2;
    }
}
.bar {
    position: absolute;
    top: 30px;
    width: 250px;
    background-color: #fff;
    user-select: none;
    box-shadow: 0 6px 20px 0 hsla(0, 0%, 0%, 0.19),
        0 8px 17px 0 hsla(0, 0%, 0%, 0.2);
    header {
        display: flex;
        align-items: flex-start;
        align-items: center;
        background-color: $blue;
        color: #fff;
        .avatar {
            width: 30px;
            height: 30px;
            margin: 10px;
            border: 1px solid $blue;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            &amp;:hover {
                border-color: #fff;
            }
            img {
                width: 100%;
                height: 100%;
            }
        }
    }
}
&lt;style&gt;</code></pre>
<h2 id="vuexçš„ä½¿ç”¨">vuexçš„ä½¿ç”¨</h2>
<p><strong>vuex</strong> ç›¸æ¯” <strong>react</strong> ä¸­çš„ <strong>redux</strong>ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæ›´åŠ ç®€å•å’Œæ–¹ä¾¿ï¼Œå°½ç®¡ç›¸æ¯” <strong>redux</strong> å¯èƒ½æ²¡æœ‰é‚£ä¹ˆ &quot;çº¯&quot;ï¼Œä½†å¥½ç”¨å°±è¡Œã€‚ <strong>vuex</strong> ç›´æ¥æŠŠå¼‚æ­¥çš„ action å°è£…è¿›é‡Œé¢ï¼Œä½¿ç”¨moduleå°†ä¸åŒç»„ä»¶çš„çŠ¶æ€åŒºåˆ†å¼€æ¥ã€‚å¯ä»¥è¯´ <strong>vuex</strong> çš„ store é›†ä¸­äº† é¡¹ç›®å¤§éƒ¨åˆ†ä¸ çŠ¶æ€ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿™ä¹Ÿæ˜¯ <strong>vue</strong> é¡¹ç›®çš„ä¸€å¤§å…³é”®ç‚¹ã€‚</p>
<h4 id="store">store</h4>
<p><strong>vuex</strong> çš„ store å’Œ <strong>redux</strong> çš„ store ä¸€æ ·ã€‚</p>
<pre><code><code>import Vue from &#39;vue&#39;
import Vuex from &#39;vuex&#39;
import { state, mutations } from &#39;./mutations&#39;
import * as getters from &#39;./getters&#39;
import * as actions from &#39;./actions&#39;
import friend from &#39;./modules/friend&#39;
import msg from &#39;./modules/msg&#39;

Vue.use(Vuex)

export default new Vuex.Store({
    actions,
    getters,
    state,
    mutations,
    modules: {
        friend,
        msg
    }
})</code></pre>
<h4 id="å…¨å±€-state-å’Œ-mutations">å…¨å±€ state å’Œ mutations</h4>
<p><strong>vuex</strong> ä¸­çš„ <strong>state</strong> å¯¹åº” <strong>redux</strong> çš„ <strong>state</strong>ï¼Œ<strong>mutations</strong> åˆ™ç±»ä¼¼ <strong>redux</strong> ä¸­çš„ <strong>action</strong>ï¼Œå…¶ä¸­mutationsæ˜¯åŒæ­¥çš„ã€‚</p>
<pre><code><code>export const state = {
    loginInfo: { token },
    selfInfo: selfInfo,
    dialog: { txt: &#39;content&#39;, cancal: false, callback: () =&gt; { }, show: false }
}

export const mutations = {
    showDialog(state, payload) {
        state.modal.visible = true;
        state.dialog = Object.assign({}, state.dialog, payload);
        state.dialog.show = true;
    },
    closeDialog(state) {
        state.modal.visible = false;
        state.dialog.show = false;
    },
    setLoginInfo(state) {
        state.loginInfo = { token: localStorage.getItem(&quot;token&quot;) };
    },
    setSelfInfo(state, payload) {
        state.selfInfo = payload;
        localStorage.setItem(&quot;selfInfo&quot;, JSON.stringify(payload));
    },
    logout() {
        state.loginInfo = {};
        state.selfInfo = {};
        localStorage.clear();
    }
}</code></pre>
<h4 id="å…¨å±€-action-å’Œ-getters">å…¨å±€ action å’Œ getters</h4>
<p><strong>vuex</strong> çš„ <strong>aciton</strong> å°±æ˜¯å°†å¼‚æ­¥çš„åŠ¨ä½œå°è£…èµ·æ¥ã€‚è€Œ<strong>redux</strong> å¾—é€šè¿‡ <strong>redux-saga</strong> ä¹‹ç±»çš„ä¸­é—´ä»¶æ‰èƒ½å®ç°ç±»ä¼¼çš„æ•ˆæœã€‚</p>
<pre><code><code>import { get, post } from &quot;../common/request&quot;;

export const getInfo = ({ commit }) =&gt; {
    return  get(&quot;/getinfo&quot;).then(res =&gt; {
        if (res.code == 0) {
            commit(&quot;setSelfInfo&quot;, res.data.user);
            commit(&quot;setFriends&quot;, res.data.friends);
            commit(&quot;setGroup&quot;, res.data.groups);
            commit(&quot;setMsgs&quot;, res.data.msgs);
        } else if (res.code == 1) {
            commit(&quot;logout&quot;);
        } else {
            commit(&#39;showDialog&#39;,{txt:res.message})
        }
    }).catch(err=&gt;{
        commit(&#39;showDialog&#39;,{txt:err.message})
    });
}

export const updateSelf=({commit},form)=&gt;{
    post(&quot;/updateinfo&quot;, form).then(res =&gt; {
        if (res.code == 0) {
            commit(&quot;updateSelfInfo&quot;, form);
        } else if (res.code == 1) {
            commit(&quot;logout&quot;);
        } else {
            commit(&#39;showDialog&#39;,{txt:res.message})
        }
    }).catch(err=&gt;{
        commit(&#39;showDialog&#39;,{txt:err.message})
    });
}
</code></pre>
<p>getterså¯ä»¥çœ‹æˆæ˜¯å¯¹state ä¸­æŸäº›å­—æ®µçš„å°è£…</p>
<pre><code><code>export const visible = state =&gt; state.modal.visible
export const isLogin = state =&gt; !!state.loginInfo.token</code></pre>
<h4 id="modules">modules</h4>
<p>éšç€é¡¹ç›®è§„æ¨¡çš„æ‰©å±•ï¼Œæ‹†åˆ†å’Œæ¨¡å—åŒ–éƒ½æ˜¯ä¸€ä¸ªå¿…ç„¶ã€‚é’ˆå¯¹æŸä¸ªå­æ¨¡å—è€Œè®¾ç½®çš„storeï¼Œå®ƒçš„ç»“æ„å’Œæ ¹storeä¸€æ ·ï¼Œmodule çš„ store æœ€ç»ˆä¼šåˆå¹¶åˆ°æ ¹ storeé‡Œé¢ã€‚msgä¸ºä¾‹çš„ç¼–å†™æ–¹å¼å¦‚ä¸‹:</p>
<pre><code><code>import { get, post } from &quot;../../common/request&quot;;

export default {
    state: {
        msgs: []
    },
    getters: {
        msgs: state =&gt; state.msgs,
        dealCount: state =&gt; state.msgs.filter(i =&gt; i.status == 0).length
    },
    actions: {
        accept({ commit }, form) {
            return post(&quot;/accept&quot;, { id: form.id, friend_id: form.from_id }).then(res =&gt; {
                if (res.code == 0) {
                    commit(&quot;setMsgState&quot;, { id: form.id, status: 1 });
                    commit(&quot;addFriend&quot;, Object.assign({}, form, { id: form.from_id }));
                } else {
                    commit(&#39;showDialog&#39;,{txt:res.message})
                }
            }).catch(err=&gt;{
                commit(&#39;showDialog&#39;,{txt:err.message})
            });
        },
        reject({ commit }, form) {
            post(&quot;/reject&quot;, { id: form.id }).then(res =&gt; {
                if (res.code == 0) {
                    form.status = 2;
                    commit(&quot;setMsgState&quot;, form);
                } else {
                    commit(&#39;showDialog&#39;,{txt:res.message})
                }
            }).catch(err=&gt;{
                commit(&#39;showDialog&#39;,{txt:err.message})
            });
        }
    },
    mutations: {
        setMsgs(state, payload) {
            state.msgs = payload;
        },
        setMsgState(state, payload) {
            state.msgs.forEach(i =&gt; {
                if (i.id == payload.id) {
                    i.status = payload.status;
                }
            })
        },
        addMsg(state, payload) {
            state.msgs.unshift(payload);
        }
    }
}</code></pre>
<h2 id="socket.ioçš„æ¥å…¥">socket.ioçš„æ¥å…¥</h2>
<p>æ¥ç€å°†websocketä½¿ç”¨èµ·æ¥ï¼Œè®©æˆ‘ä»¬å®ç° å¥½å‹èŠå¤©å’Œåˆ†ç»„èŠå¤©çš„åŠŸèƒ½ï¼Œsocket.io çš„ä»‹ç»å¯ä»¥çœ‹æˆ‘ä¹‹å‰çš„æ–‡ç«  <em><a href="https://www.cnblogs.com/edwardloveyou/p/10625152.html">å…³äºsocket.ioçš„ä½¿ç”¨</a></em>ã€‚</p>
<h4 id="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</h4>
<p>é¦–å…ˆè¿æ¥æœåŠ¡ç«¯çš„ socketï¼Œç„¶åå°†è‡ªèº«çš„ç”¨æˆ·ä¿¡æ¯æ³¨å†Œåˆ° socket.io æœåŠ¡ï¼Œè¿™æ ·æœåŠ¡ç«¯æ‰çŸ¥é“ä½ æ˜¯è°ï¼Œä¹Ÿæ‰èƒ½ä¸å…¶ä»–äººå®è¡Œé€šä¿¡ã€‚</p>
<pre><code><code>async created() {// vue ç»„ä»¶åˆ›å»ºæ—¶å»ºç«‹socketè¿æ¥
  const token = localStorage.getItem(&quot;token&quot;) || &quot;&quot;;
  if (!token) {
        return this.$router.push(&quot;/sign/log&quot;);
  }
  await this.$store.dispatch(&quot;getInfo&quot;);
  this.socket = io(&quot;http://localhost:3001?token=&quot; + token);

  //æ³¨å†Œç”¨æˆ·ä¿¡æ¯åæ‰å¼€å§‹ä¸æœåŠ¡ç«¯é€šä¿¡
  this.socket.emit(&quot;sign&quot;, { user: this.selfInfo, rooms }, res =&gt; {
    // console.log(res);
    this.$store.commit(&quot;friendStatus&quot;, res.data);
    this.socket.on(&quot;userin&quot;, (map, user) =&gt; {
      this.$store.commit(&quot;friendStatus&quot;, map);
      showTip(user, &quot;ä¸Šçº¿äº†&quot;);
    });
    this.socket.on(&quot;userout&quot;, (map, user) =&gt; {
      this.$store.commit(&quot;friendStatus&quot;, map);
      showTip(user, &quot;ä¸‹çº¿äº†&quot;);
    });

    this.socket.on(&quot;auth&quot;, data =&gt; {
      this.$store.commit(&#39;showDialog&#39;,{txt:data.message})
      this.$store.commit(&quot;logout&quot;);
    });

    //æ¥æ”¶ç”³è¯·å¥½å‹å’Œç»„ç¾¤
    this.socket.on(&quot;apply&quot;, data =&gt; {
      this.$store.commit(&quot;addMsg&quot;, data);
    });

    //æ¥æ”¶èŠå¤©ä¿¡æ¯
    this.socket.on(&quot;reply&quot;, (user, data) =&gt; {
      this.sendMsg(user, data);
    });

    //æ¥æ”¶ç¾¤ç»„èŠå¤©ä¿¡æ¯
    this.socket.on(&quot;groupReply&quot;, (info, data) =&gt; {
      this.sendGroupMsg(info, data);
    });
  });
},
beforeDestroy() { //ç»„ä»¶é”€æ¯ä¹‹å‰ï¼Œå°†socket å…³é—­
    this.socket.close();
},</code></pre>
<h4 id="æœåŠ¡ç«¯">æœåŠ¡ç«¯</h4>
<p>socket.io å¯¹åº”çš„æœåŠ¡ç«¯éƒ¨åˆ†ï¼Œé€»è¾‘ä¸»è¦åŒ…æ‹¬ç”¨æˆ·æ³¨å†Œï¼Œä¸¤äººèŠå¤©ï¼Œç¾¤èŠå¤©ï¼Œå½“ç„¶å¯¹åº”çš„ä¿¡æ¯éœ€è¦ä¿å­˜åˆ°æ•°æ®åº“ã€‚ è¿™é‡Œçš„æŠ€å·§å°±æ˜¯ä½¿ç”¨å˜é‡è®°å½•å½“å‰æ‰€æœ‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ã€‚</p>
<pre><code><code>const auth = require(&#39;./auth.js&#39;)
const { insertMsg, insertToUser } = require(&#39;../daos/message&#39;);
const log = require(&#39;../common/logger&#39;)

let MAP = {};//ç”¨æˆ·idå’Œsocket id
let LIST = []; //ç”¨æˆ·ä¿¡æ¯
let ROOMS = []; //æˆ¿é—´

const currTime = () =&gt; {
    const d = new Date(), date = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
    return (&#39;0&#39; + d.getHours()).slice(-2) + &#39;:&#39; + (&#39;0&#39; + d.getMinutes()).slice(-2) + &#39;:&#39; + (&#39;0&#39; + d.getSeconds()).slice(-2);
};

module.exports = io =&gt; {
    // middleware
    io.use(auth);
    //namespace (/)
    io.on(&#39;connection&#39;, socket =&gt; {
        socket.emit(&#39;open&#39;, {
            code: 0,
            handshake: socket.handshake,
            namespace: &#39;/&#39;,
            message: &#39;welcome to main channel, please sign&#39;
        });
                
        //ç”¨æˆ·æ³¨å†Œ
        socket.on(&#39;sign&#39;, ({ user, rooms }, fn) =&gt; {
            if (!user.id) {
                return fn({ code: 2, message: &#39;id not exist&#39; });
            }
            MAP[user.id] = socket.id;
            user.socketId = socket.id;
            LIST.push(user);

            socket.join(rooms);//åŠ å…¥è‡ªå·±æ‰€åœ¨çš„ç»„
            socket.emit(&#39;userin&#39;, MAP, user);
            socket.broadcast.emit(&#39;userin&#39;, MAP, user);

            fn({
                code: 0,
                message: &#39;sign success&#39;,
                data: MAP
            });
        });

        //ä¸¤äººèŠå¤©
        socket.on(&#39;send&#39;, async (uid, msg) =&gt; {
            const sid = MAP[uid];//æ¥æ”¶ç”¨æˆ·socket.id
            const cid = findUid(socket.id);//å‘é€ç”¨æˆ·id

            if (sid) { // å¥½å‹åœ¨çº¿åˆ™å‘é€
                socket.to(sid).emit(&#39;reply&#39;, { id: cid, self: false }, { date: currTime(), msg });
            }
            // ç»™è‡ªå·±ä¹Ÿå‘ä¸€ä»½
            socket.emit(&#39;reply&#39;, { id: uid, self: true }, { date: currTime(), msg });
            // ä¿å­˜æ•°æ®åº“
            try {
                const ret = await insertMsg({ send_id: cid, receive_id: uid, content: msg });
                insertToUser({ user_id: uid, send_id: cid, message_id: ret.insertId, is_read: sid ? 1 : 0 });
            } catch (err) {
                log.error(err);
            }
        });

        //ç¾¤ç»„èŠå¤©
        socket.on(&#39;groupSend&#39;, async ({gid,user}, msg) =&gt; {
                    //...
        });

        socket.on(&#39;acceptFriend&#39;, (uid) =&gt; {
                    //...
        });

        socket.on(&#39;sendApply&#39;, (uid, data) =&gt; {
                    //...
        });

        socket.on(&#39;disconnect&#39;, () =&gt; {
                    //...
        });
    });
};
</code></pre>
<h2 id="å®¢æˆ·ç«¯çš„å¯åŠ¨">å®¢æˆ·ç«¯çš„å¯åŠ¨</h2>
<p>é¦–å…ˆå¾—ç¼–å†™client.jsï¼Œå°†å‰ç«¯æœåŠ¡å¯åŠ¨èµ·æ¥ï¼Œä¾ç„¶è¿˜æ˜¯ä½¿ç”¨æˆ‘ä»¬é«˜æ•ˆçš„koaæ¡†æ¶ã€‚æˆ‘è¿™é‡Œå›¾çœäº‹ï¼Œå’Œä¹‹å‰çš„æœåŠ¡ç«¯æ‰€åœ¨åŒä¸€ä¸ªæ ¹ç›®å½•ä¸‹ï¼ŒçœŸæ­£é¡¹ç›®ä¼šå°†æœåŠ¡ç«¯éƒ¨åˆ†å’Œå®¢æˆ·ç«¯éƒ¨åˆ† åˆ†ç¦»åˆ°ä¸åŒç›®å½•æˆ–ä¸åŒçš„æœåŠ¡å™¨çš„ã€‚</p>
<pre><code><code>const koa = require(&#39;koa&#39;)
const app = new koa()
const static = require(&#39;koa-static&#39;)
const compress = require(&#39;koa-compress&#39;)
const router = require(&#39;koa-router&#39;)()
const { clientPort } = require(&#39;./server/config/app&#39;)
const tpl = require(&#39;./server/middleware/tpl&#39;)
const path = require(&#39;path&#39;)

// gzip
app.use(compress({
    filter: function (content_type) {
        return /text|javascript/i.test(content_type)
    },
    threshold: 2048,
    flush: require(&#39;zlib&#39;).Z_SYNC_FLUSH
}));

// set static directiory
app.use(static(path.join(__dirname, &#39;dist&#39;), { index: false }));

// simple template engine
app.use(tpl({
    path: path.join(__dirname, &#39;dist&#39;)
}));

// add routers
router
    .get(&#39;/&#39;, ctx =&gt; {
        ctx.render(&#39;index.html&#39;);
    })
    .get(&#39;/sign/*&#39;, ctx =&gt; {
        ctx.redirect(&#39;/&#39;);
    })

app.use(router.routes())
    .use(router.allowedMethods());

// deal 404
app.use(async (ctx, next) =&gt; {
    ctx.status = 404;
    ctx.body = { code: 404, message: &#39;404! not found !&#39; };
});

// koa already had event to deal with the error, just rigister it
app.on(&#39;error&#39;, (err, ctx) =&gt; {
    ctx.status = 500;
    ctx.statusText = &#39;Internal Server Error&#39;;
    if (ctx.app.env === &#39;development&#39;) { //throw the error to frontEnd when in the develop mode
        ctx.res.end(err.stack); //finish the response
    } else {
        ctx.body = { code: -1, message: &#39;Server Error&#39; };
    }
});

if (!module.parent) {
    app.listen(clientPort);
    console.log(&#39;app server running at: http://localhost:%d&#39;, clientPort);
}</code></pre>
<p>å¯åŠ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬æ•´ä¸ªdemoå°±èƒ½è¿è¡Œï¼Œä¸»è¦å®ç°å¦‚ä¸‹åŠŸèƒ½ç‚¹ï¼š</p>
<ol>
<li>ä¸»é¡µé¢çš„æ‰€æœ‰çš„çª—å£éƒ½å¯ä»¥æ‹–åŠ¨ï¼Œå…³é—­</li>
<li>å¯ä»¥ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯ï¼Œç¾¤ç»„ä¿¡æ¯ï¼Œæ¯ä¸ªç”¨æˆ·å¯ä»¥æ–°å»º3ä¸ªç¾¤ç»„</li>
<li>å¯ä»¥å¥½å‹èŠå¤©ï¼Œç¾¤ç»„èŠå¤©</li>
<li>æœç´¢ç”¨æˆ·å’Œç¾¤ç»„</li>
<li>å¥½å‹ç”³è¯·å’Œç¾¤ç»„ç”³è¯·</li>
<li>åœ¨çº¿æ—¶ï¼Œå¯ä»¥è·å¾—å¥½å‹ä¸Šçº¿ä¸‹çº¿æé†’ï¼Œå®æ—¶ç­”å¤ç”¨æˆ·ç”³è¯·</li>
<li>ç¦»çº¿æ—¶ï¼Œä»ç„¶å¯ä»¥ç»™ç”¨æˆ·å’Œç¾¤ç»„ç•™è¨€ï¼Œä¸‹æ¬¡ç™»å½•è·å¾—æé†’</li>
</ol>
<p><img src="./images/koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹å‰ç«¯ç¯‡0.png" alt="web QQ" /></p>
<h2 id="åç»­">åç»­</h2>
<p>æ¥ä¸‹æ¥å¯ä»¥ä¼˜åŒ–å’Œå¢å¼ºçš„åœ°æ–¹ï¼Œæˆ‘æƒ³åˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ol>
<li>ä½¿ç”¨ <strong>nuxt</strong> å°† vue è¿›è¡ŒæœåŠ¡ç«¯æ¸²æŸ“ ï¼Œè¿›ä¸€æ­¥æé«˜æ€§èƒ½</li>
<li>node éƒ¨åˆ†ï¼Œä½¿ç”¨ pm2 è¿›è¡Œéƒ¨ç½²ã€‚</li>
</ol>
<p>æºä»£ç : <em><a href="https://github.com/edwardzhong/vue_qq">vue_qq</a></em></p>

</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>