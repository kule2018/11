<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='ç”µè„‘,ç”µè„‘è®²è§£,ç”µè„‘æŠ€æœ¯,ç¼–ç¨‹,ç”µè„‘æ•…éšœç»´ä¿®koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹æ•°æ®è®¿é—®ç¯‡' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>é¦–é¡µ</a></li>
</div><div onclick='hidden1()' >åˆ†äº«</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹æ•°æ®è®¿é—®ç¯‡</center></div><div class='banquan'>åŸæ–‡å‡ºå¤„:æœ¬æ–‡ç”±åšå®¢å›­åšä¸»Jeff.Zhongæä¾›ã€‚<br/>
åŸæ–‡è¿æ¥:https://www.cnblogs.com/edwardloveyou/p/10693744.html</div><br>
    <p>åŸæ–‡åœ°å€ï¼š<a href="https://edwardzhong.github.io/2019/04/12/fullstack2/">koa+mysql+vue+socket.ioå…¨æ ˆå¼€å‘ä¹‹æ•°æ®è®¿é—®ç¯‡</a></p>
<p>åç«¯æ­èµ·å¤§ä½“çš„æ¡†æ¶åï¼Œæ¥ç€æ¶‰åŠåˆ°çš„å°±æ˜¯å¦‚ä½•å°†æ•°æ®æŒä¹…åŒ–çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å¯¹æ•°æ®åº“è¿›è¡Œ <strong>CURD</strong> æ“ä½œã€‚</p>
<p>å…³äºæ•°æ®åº“æ–¹æ¡ˆ, <strong>mongodb</strong> å’Œ <strong>mysql</strong> éƒ½ä½¿ç”¨è¿‡ï¼Œä½†æˆ‘é€‰ç”¨çš„æ˜¯ <strong>mysql</strong>ï¼ŒåŸå› ï¼š</p>
<ol>
<li>ç›®å‰ä¸ºæ­¢ <strong>mysql</strong> ä¸ <strong>mongodb</strong> æ€§èƒ½ç›¸å·®ä¸å¤§ï¼Œå°¤å…¶æ˜¯ <strong>mysql</strong> 8.0 ç‰ˆæœ¬ï¼Œé€Ÿåº¦éå¸¸å¿«ï¼ŒæŸ¥è¯¢æ•°æ®æ˜¯ mysql æ›´å¿«ï¼Œå†™æ•°æ®æ–¹é¢ <strong>mongodb</strong> åˆ™æ›´èƒœä¸€ç­¹ï¼›</li>
<li><strong>mysql</strong> å»ºç«‹ å…³è”æ•°æ®è¦æ›´æ–¹ä¾¿äº›ï¼Œæ¯”å¦‚ï¼š ä¸€å¯¹å¤šï¼Œå¤šå¯¹å¤šçš„å…³ç³»ï¼›</li>
<li><strong>mysql</strong> ä½œä¸ºå…³ç³»å‹æ•°æ®åº“ï¼Œæ•°æ®ä¸€è‡´æ€§æ–¹é¢æ›´å¥½ï¼Œå°¤å…¶æ˜¯äº‹åŠ¡ç”¨èµ·æ¥æ›´é¡ºæ‰‹ï¼›</li>
<li>æœ¬äººå¯¹ sql æ“ä½œæ¯”è¾ƒå¾—å¿ƒåº”æ‰‹ï¼Œæ¯•ç«Ÿå¤§éƒ¨åˆ†é¡¹ç›®ç”¨å¾—éƒ½æ˜¯ <strong>mysql</strong>ï¼Œè€Œ <strong>mongodb</strong> åœ¨æ­£å¼äº›çš„é¡¹ç›®ä¸Šç”¨çš„å°±å°‘äº†ï¼Œè€Œä¸”ç›®å‰å…³ç³»å‹æ•°æ®åº“ä¹Ÿåœ¨è¿›åŒ–, <strong>postgrep</strong> å’Œ <strong>mysql</strong> éƒ½å·²ç»æ”¯æŒ jsonäº†ã€‚</li>
</ol>
<!-- more -->
<h2 id="node-mysql">node-mysql</h2>
<p><strong>node-mysql</strong> æ˜¯ç”¨ sql è¯­å¥å¯¹ mysql è¿›è¡Œæ“ä½œçš„åº“, å¹¶æ²¡æœ‰ä½¿ç”¨ <a href="http://docs.sequelizejs.com/">Sequelize</a> è¿™ç§ ormã€‚å› ä¸ºæˆ‘å¯¹ sql ç†Ÿæ‚‰ï¼ŒåŸç”Ÿå¼€å‘æ•ˆç‡é«˜ã€‚</p>
<h4 id="è¿æ¥æ± ">è¿æ¥æ± </h4>
<p>è¿æ¥æ•°æ®åº“æˆ‘é€‰ç”¨ è¿æ¥æ± çš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼èƒ½é«˜æ•ˆçš„åˆ©ç”¨æ•°æ®åº“è¿æ¥</p>
<pre><code><code>//dbPool.js
const mysql = require(&#39;mysql&#39;);
const dbconfig = require(&#39;../config/db&#39;);
const log = require(&#39;../common/logger&#39;);
let pool = null;

/**
 * get the connection pool of database
 * è·å–æ•°æ®åº“è¿æ¥æ± 
 */
exports.getPool = function () {
    if (!pool) {
        log.info(&quot;creating pool&quot;);
        pool = mysql.createPool(dbconfig);
    }
    return pool;
}</code></pre>
<h4 id="æ•°æ®åº“é…ç½®æ–‡ä»¶">æ•°æ®åº“é…ç½®æ–‡ä»¶</h4>
<p><strong>emoji</strong> æ ¼å¼è¦ç”¨ <strong>utf8mb4</strong> æ ¼å¼å­˜å‚¨ï¼Œæ‰€ä»¥è¿™é‡Œè¿æ¥å­—ç¬¦é›†é€‰ç”¨ <strong>utf8mb4</strong>ï¼Œå½“ç„¶å®¢æˆ·ç«¯å’Œæ•°æ®ç»“æœé›† ä¸€æ ·ä¹Ÿè¦è®¾ç½®ä¸º <strong>utf8mb4</strong>ã€‚</p>
<pre><code><code>module.exports={
    host: &quot;localhost&quot;,
    port: &quot;3306&quot;,
    user: &quot;root&quot;,
    password: &quot;jeff&quot;,
    database: &quot;chatdb&quot;,
    charset : &#39;utf8mb4&#39;,//utf8mb4æ‰èƒ½ä¿å­˜emoji
    multipleStatements: true,// å¯åŒæ—¶æŸ¥è¯¢å¤šæ¡è¯­å¥, ä½†ä¸èƒ½å‚æ•°åŒ–ä¼ å€¼
    connectionLimit: 100 //è¿æ¥æ•°é‡
};</code></pre>
<h2 id="daoçš„ç¼–å†™">Daoçš„ç¼–å†™</h2>
<p>åŸºæœ¬çš„ä»£ç ç¼–å†™æ–¹å¼å¦‚ä¸‹ï¼Œæ¯ä¸ªæ–¹æ³•åŸºæœ¬éƒ½æ˜¯è¿™ä¹ˆä¸€ç§æµç¨‹ï¼Œè·å–æ•°æ®åº“è¿æ¥ï¼Œæ‰§è¡Œ sql è¯­å¥ï¼Œè¿”å›ç»“æœï¼Œå¤„ç†å¼‚å¸¸ã€‚</p>
<pre><code><code>exports.queryInfo = function (params, callback){
    pool.query(&#39;select ...&#39;, params, function (error, result, fields) {
        if (error) {
          log(error);
          callback(false);
        }
        else callback(result)
    }); 
}</code></pre>
<h4 id="exportdao">exportDao</h4>
<p>è¿™é€ æˆäº†ä¸€å¤§å †é‡å¤çš„æ ·æ¿ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦å°è£…å®ƒï¼Œç”¨ <strong>JavaScript</strong> é«˜é˜¶å‡½æ•°ç‰¹æ€§ å¾ˆå®¹æ˜“å°±èƒ½å®ç°ï¼ŒåŒæ—¶åŠ ä¸Š Promiseï¼Œè°ƒç”¨æ—¶å°±èƒ½æ–¹ä¾¿åœ°ç”¨ <strong>async await</strong> äº†ï¼Œè¿˜æœ‰æ—¥å¿—è®°å½•åŠŸèƒ½ä¹ŸåŠ ä¸Šã€‚</p>
<pre><code><code>const pool = require(&quot;./dbPool&quot;).getPool();
const log = require(&#39;../common/logger&#39;);

/**
 * export named query function
 */
const exportDao = opts =&gt; Object.keys(opts).reduce((next, key) =&gt; {
    next[key] = (...args) =&gt; new Promise((resolve, reject) =&gt; {
        if (opts[key]) args.unshift(opts[key]);
        log.info(&#39;====== execute sql ======&#39;)
        log.info(args);
        pool.query(...args, (err, result, fields) =&gt; {// fields is useless
            if (err) reject(err)
            else resolve(result);
        });
    });
    return next;
}, {});</code></pre>
<p>userDaoæ–‡ä»¶ä¸ºä¾‹ï¼Œä½¿ç”¨ <strong>exportDao</strong> ç›´æ¥å°±èƒ½æŠŠé‡Œé¢çš„ key-value å¯¹è±¡è¾“å‡ºä¸º ä»¥key ä¸ºæ–¹æ³•åçš„daoæ–¹æ³•ï¼ŒæŒ‚è½½åˆ° <strong>module.exports</strong> ä¸‹ã€‚</p>
<pre><code><code>const { exportDao } = require(&#39;./common&#39;);

//ç›´æ¥å°±exportsé‡Œé¢çš„keyå€¼å¯¹åº”çš„æ–¹æ³•
module.exports = exportDao({
    sql: null,// æœ‰äº›æ—¶å€™éœ€è¦ç›´æ¥å†™sql
    count: &#39;select count(*) as count from user where ?&#39;,
    getUser: &#39;select * from user where ?&#39;,
    insert: &#39;insert into user set ?&#39;,
    update: &#39;update user set ? where id = ?&#39;,
    delete: &#39;delete from user where ?&#39;
});

/* æœ€ç»ˆè¾“å‡ºæ ¼å¼
module.exports = {
  sql:() =&gt; {},
  count:() =&gt; {},
  ...
}*/</code></pre>
<h4 id="transaction">transaction</h4>
<p>è¿˜æœ‰äº‹åŠ¡ <strong>transaction</strong> çš„åŠŸèƒ½éœ€è¦ç”¨åˆ°ï¼Œæ¥çœ‹ä¸€ä¸‹ <strong>node-mysql</strong> å®˜æ–¹çš„ä¾‹å­ï¼Œå±‚å±‚å›è°ƒğŸ˜¢ï¼Œå¦‚æœæ¯ä¸ªä¸šåŠ¡éƒ½è¦è¿™æ ·ç¼–å†™ï¼Œç®€ç›´ä¸èƒ½å¿ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ‰‹åŠ¨å°è£…ä¸‹äº‹åŠ¡å§ã€‚</p>
<pre><code><code>// å®˜æ–¹çš„äº‹åŠ¡æ ·ä¾‹
pool.getConnection(function(err, connection) {
    if (err) { throw err; }
    connection.beginTransaction(function(err) {
    if (err) { throw err; }
        connection.query(&#39;INSERT INTO posts SET title=?&#39;, title, function (error, results, fields) {
            if (error) {
                return connection.rollback(function() {
                    throw error;
                });
            }

            var log = &#39;Post &#39; + results.insertId + &#39; added&#39;;

            connection.query(&#39;INSERT INTO log SET data=?&#39;, log, function (error, results, fields) {
                if (error) {
                    return connection.rollback(function() {
                    throw error;
                    });
                }
                connection.commit(function(err) {
                    if (err) {
                        return connection.rollback(function() {
                            throw err;
                        });
                    }
                    console.log(&#39;success!&#39;);
                });
            });
        });
    });
});</code></pre>
<p>ä¸‹é¢å°±æ˜¯å°è£…å¥½çš„äº‹åŠ¡æ–¹æ³•ï¼Œè°ƒç”¨å‚æ•°ä¸ºæ•°ç»„ï¼Œæ•°ç»„é¡¹æ—¢å¯ä»¥æ˜¯ sql å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ <strong>node-mysql</strong> ä¸­çš„å¸¦å‚æ•°ä¼ å€¼çš„æ•°ç»„ï¼Œè¿™æ‰æ˜¯ç»™äººç”¨çš„å˜›ï¼Œå¿ƒæƒ…å¥½å¤šäº†ã€‚æ¨èè¿˜æ˜¯ç”¨ å‚æ•°åŒ–ä¼ å€¼ï¼Œè¿™æ ·å¯ä»¥é¿å… sql æ³¨å…¥ï¼Œå¦‚æœç¡®å®è¦ç”¨sqlå­—ç¬¦ä¸²ï¼Œå¯ä»¥è°ƒç”¨ mysql.escape æ–¹æ³•å¯¹ å‚æ•° è¿›è¡Œè½¬æ¢ã€‚</p>
<pre><code><code>//è°ƒç”¨å°è£…åçš„äº‹åŠ¡
const rets = await transaction([
     [&quot;insert into user_group values (?,?)&quot;,[11,11]],
     [&quot;insert into user_friend set ? &quot;,{user_id:&#39;12&#39;,friend_id:12}],
     &#39;select * from user&#39;
 ]);

/**
 * sql transaction å°è£…åçš„äº‹åŠ¡
 * @param  {Array} list 
 */
const transaction = list =&gt; {
    return new Promise((resolve, reject) =&gt; {
        if (!Array.isArray(list) || !list.length) return reject(&#39;it needs a Array with sql&#39;)
        pool.getConnection((err, connection) =&gt; {
            if (err) return reject(err);
            connection.beginTransaction(err =&gt; {
                if (err) return reject(err);
                log.info(&#39;============ begin execute transaction ============&#39;)
                let rets = [];
                return (function dispatch(i) {
                    let args = list[i];
                    if (!args) {//finally commit
                        connection.commit(err =&gt; {
                            if (err) {
                                connection.rollback();
                                connection.release();
                                return reject(err);
                            }
                            log.info(&#39;============ success executed transaction ============&#39;)
                            connection.release();
                            resolve(rets);
                        });
                    } else {
                        log.info(args);
                        args = typeof args == &#39;string&#39; ? [args] : args;
                        connection.query(...args, (error, ret) =&gt; {
                            if (error) {
                                connection.rollback();
                                connection.release();
                                return reject(error);
                            }
                            rets.push(ret);
                            dispatch(i + 1);
                        });
                    }
                })(0);
            });
        });
    })
}</code></pre>
<h4 id="controller-è°ƒç”¨-dao">controller è°ƒç”¨ dao</h4>
<p>éƒ½å°è£…å®Œæ¯•ï¼Œæœ€åå°±æ˜¯è°ƒç”¨ï¼Œ å°±ä»¥applyæ§åˆ¶å™¨ä¸ºä¾‹ï¼Œå…¶ä¸­çš„ <strong>apply</strong> æ–¹æ³•æ˜¯æ™®é€šè°ƒç”¨ï¼Œ<strong>accept</strong> æ–¹æ³•åˆ™ä½¿ç”¨äº†äº‹åŠ¡è¿›è¡Œå¤„ç†ã€‚</p>
<pre><code><code>const { stringFormat } = require(&#39;../common/util&#39;)
const { transaction } = require(&#39;../daos/common&#39;)
const applyDao = require(&#39;../daos/apply&#39;)

exports.apply = async function (ctx) {
    const form = ctx.request.body;
    const token = await ctx.verify();
    const ret = await applyDao.apply({ ...form, from_id: token.uid });
    if (!ret.affectedRows) {
        return ctx.body = {
            code: 2,
            message: &#39;ç”³è¯·å¤±è´¥&#39;
        };
    }
    ctx.body = {
        code: 0,
        message: &#39;ç”³è¯·æˆåŠŸ&#39;,
        data:ret.insertId
    };
}

exports.accept = async function (ctx) {
    const { id, friend_id } = ctx.request.body;
    const token = await ctx.verify();
    const ret = await transaction([// éç”¨æˆ·è¾“å…¥çš„ idï¼Œæ²¡æœ‰ä½¿ç”¨ escape è¿›è¡Œè½¬æ¢ã€‚
        [&#39;update apply set status = 1 where id = ? and to_id = ?&#39;, [id, token.uid]],
        stringFormat(&quot;replace into user_friend values (&#39;$1&#39;,&#39;$2&#39;),(&#39;$2&#39;,&#39;$1&#39;)&quot;, token.uid, friend_id)
    ]);
    if (!ret[0].affectedRows || !ret[1].affectedRows) {
        return ctx.body = {
            code: 2,
            message: &#39;æ·»åŠ å¥½å‹å¤±è´¥&#39;
        };
    }
    ctx.body = {
        code: 0,
        message: &#39;æ·»åŠ å¥½å‹æˆåŠŸ&#39;
    };
}</code></pre>
<h2 id="sqlè„šæœ¬">sqlè„šæœ¬</h2>
<p>å½“ç„¶è¿˜éœ€è¦å®šä¹‰æ•°æ®ç»“æ„ï¼Œæœ‰å¾ˆå¤šå·¥å…·å¯ä»¥æ–¹ä¾¿å»ºè¡¨å’Œå»ºç”Ÿäº§sqlï¼Œè¿™é‡Œä»¥éƒ¨åˆ†è¡¨ä¸ºä¾‹ï¼Œé¡¹ç›®ä½¿ç”¨åˆ°çš„è¡¨è¦å¤šå¾—å¤šã€‚æˆ‘è¿™é‡Œè¿˜å†™äº†äº›æ— å…³ç´§è¦çš„è§¦å‘å™¨å¤„ç† æ•°æ®æ’å…¥æ—¶é—´ å’Œæ•°æ®ä¿®æ”¹æ—¶é—´ï¼Œè¿™æ˜¯ä¸ªäººçš„ä¹ æƒ¯ã€‚å®Œå…¨å¯ä»¥ä¸ç”¨è§¦å‘å™¨ï¼Œç›´æ¥åœ¨ä»£ç é‡Œé¢èµ‹å€¼ï¼Œä¸å½±å“ä½¿ç”¨ã€‚æœ‰ç”¨åˆ° emoji çš„æ•°æ®è¡¨ï¼Œè®°å¾—è¦ç”¨ utf8mb4 æ ¼å¼ã€‚</p>
<pre class="sql"><code>create database if not exists chatdb;
use chatdb;

drop table if exists `user`;
CREATE TABLE `user` (
  `id` char(36) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;ä¸»é”®&#39;,
  `name` varchar(50) DEFAULT NULL COMMENT &#39;ç”¨æˆ·å&#39;,
  `num` int(8) DEFAULT NULL  COMMENT &#39;ç”¨æˆ·å·ç &#39;,
  `salt` varchar(13) DEFAULT NULL COMMENT &#39;åŠ å¯†çš„ç›&#39;,
  `hash_password` varchar(64) DEFAULT NULL COMMENT &#39;åŠ å¯†åçš„å¯†ç &#39;,
  `email` varchar(50) NOT NULL COMMENT &#39;emailåœ°å€&#39;,
  `nick` varchar(50) DEFAULT NULL COMMENT &#39;æ˜µç§°&#39;,
  `avatar` varchar(200) DEFAULT NULL COMMENT &#39;å¤´åƒ&#39;,
  `signature` varchar(200) DEFAULT NULL COMMENT &#39;ä¸ªæ€§ç­¾å&#39;,
  `status` tinyint(1) DEFAULT 0 COMMENT &#39;çŠ¶æ€(0 ç¦»çº¿ 1 åœ¨çº¿ 2 éšèº«)&#39;,
  `is_admin` tinyint(1) DEFAULT 0 COMMENT &#39;æ˜¯å¦ç®¡ç†å‘˜&#39;,
  `is_block` tinyint(1) DEFAULT 0 COMMENT &#39;æ˜¯å¦ç¦ç”¨&#39;,
  `create_date` int(10) unsigned DEFAULT NULL COMMENT &#39;æ³¨å†Œæ—¶é—´&#39;,
  `update_date` int(10) unsigned DEFAULT NULL COMMENT &#39;æ›´æ–°æ—¶é—´&#39;,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT=&#39;ç”¨æˆ·è¡¨&#39;; 

drop table if exists `message`;
CREATE TABLE `message` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT &#39;ä¸»é”®&#39;,
  `content` text NOT NULL COMMENT &#39;å†…å®¹&#39;,
  `type` tinyint(1) DEFAULT 0 COMMENT &#39;ç±»å‹(0 ç”¨æˆ· 1 ç»„ç¾¤)&#39;,
  `send_id` char(36) NOT NULL COMMENT &#39;å‘é€ç”¨æˆ·id&#39;,
  `receive_id` char(36) DEFAULT NULL COMMENT &#39;æ¥æ”¶ç”¨æˆ·id&#39;,
  `group_id` int(11) DEFAULT NULL COMMENT &#39;ç»„id&#39;,
  `create_date` int(10) unsigned DEFAULT NULL COMMENT &#39;åˆ›å»ºæ—¶é—´&#39;,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT=&#39;æ¶ˆæ¯è¡¨&#39;;

drop table if exists `user_message`;
CREATE TABLE `user_message` (
  `user_id` char(36) DEFAULT NULL COMMENT &#39;æ¥æ”¶ç”¨æˆ·id&#39;,
  `send_id` char(36) NOT NULL COMMENT &#39;å‘é€ç”¨æˆ·id&#39;,
  `message_id` int(11) NOT NULL COMMENT &#39;æ¶ˆæ¯id&#39;,
  `is_read` tinyint(1) DEFAULT 0 COMMENT &#39;æ˜¯å¦è¯»è¿‡(0 æ²¡æœ‰ 1 è¯»è¿‡)&#39;,
  PRIMARY KEY (`send_id`,`message_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT=&#39;ç”¨æˆ·æ¶ˆæ¯è¿æ¥è¡¨&#39;;


-- userè¡¨insertè§¦å‘å™¨
delimiter $$
create trigger `user_insert` before insert on `user`
for each ROW
begin
if (new.id = &#39;&#39; or new.id is null)
    then set new.id = uuid();
end if;
if (new.num = 0 or new.num is null)
    then set new.num = 1000;
end if;
if (new.`create_date` = 0 or new.`create_date` is null)
    then set new.`create_date` = unix_timestamp(now());
end if;
if (new.`update_date` = 0 or new.`update_date` is null)
    then set new.`update_date` = unix_timestamp(now());
end if;
END
$$

-- userè¡¨updateè§¦å‘å™¨
delimiter $$
create trigger `user_update` before update on `user`
for each ROW
begin
if ((new.`name` &lt;&gt; old.`name`) or (new.`name` is not null and old.`name` is null) 
    or (new.`email` &lt;&gt; old.`email`) or (new.`email` is not null and old.`email` is null)
    or (new.`nick` &lt;&gt; old.`nick`) or (new.`nick` is not null and old.`nick` is null)
    or (new.`avatar` &lt;&gt; old.`avatar`) or (new.`avatar` is not null and old.`avatar` is null)
    or (new.`signature` &lt;&gt; old.`signature`) or (new.`signature` is not null and old.`signature` is null))
    then set new.`update_date` = unix_timestamp(now());
end if;
END
$$

-- messageè¡¨insertè§¦å‘å™¨
delimiter $$
create trigger `message_insert` before insert on `message`
for each ROW
begin
if (new.`create_date` = 0 or new.`create_date` is null)
    then set new.`create_date` = unix_timestamp(now());
end if;
END
$$</code></pre>
<h2 id="åç»­">åç»­</h2>
<p>æ¥ç€å°±æ˜¯æˆ‘ä»¬çš„å¤§å‰ç«¯éƒ¨åˆ†äº†ï¼Œå°†ä¼šç”¨åˆ° vueï¼Œvuexï¼Œè¯·ç»§ç»­å…³æ³¨ã€‚</p>

</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>