<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修websql操作类封装' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>websql操作类封装</center></div><div class='banquan'>原文出处:本文由博客园博主邹琼俊提供。<br/>
原文连接:https://www.cnblogs.com/jiekzou/p/11366121.html</div><br>
    <p>　　在之前，我写了一个websql的封装类库，代码如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('e92a8cd3-5ffe-4f13-a6a6-72b9e27c76e3')"><img id="code_img_closed_e92a8cd3-5ffe-4f13-a6a6-72b9e27c76e3" class="code_img_closed" src="./images/websql操作类封装0.png" alt="" /><img id="code_img_opened_e92a8cd3-5ffe-4f13-a6a6-72b9e27c76e3" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('e92a8cd3-5ffe-4f13-a6a6-72b9e27c76e3',event)" src="./images/websql操作类封装1.png" alt="" />
<div id="cnblogs_code_open_e92a8cd3-5ffe-4f13-a6a6-72b9e27c76e3" class="cnblogs_code_hide">
<pre><code>(<span style="color: #0000ff;">function</span><span style="color: #000000;">(win) {
    </span><span style="color: #0000ff;">function</span><span style="color: #000000;"> smpWebSql(options){
        options </span>= options ||<span style="color: #000000;"> {};
        </span><span style="color: #0000ff;">this</span>.database = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
        </span><span style="color: #0000ff;">this</span>.DateBaseName = options.DateBaseName || 'SmpDB'<span style="color: #000000;">;
        </span><span style="color: #0000ff;">this</span>.Version = options.Version || '1.0'<span style="color: #000000;">;
        </span><span style="color: #0000ff;">this</span>.Description = options.Description || 'SmpDB'<span style="color: #000000;">;
        </span><span style="color: #0000ff;">this</span>.DataBaseSize = options.DataBaseSize || 2 * 1024 * 1024<span style="color: #000000;">;
        </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.init();
    }
    smpWebSql.prototype </span>=<span style="color: #000000;"> {
        init: </span><span style="color: #0000ff;">function</span><span style="color: #000000;">() {
            </span><span style="color: #0000ff;">this</span>.database = openDatabase(<span style="color: #0000ff;">this</span>.DateBaseName, <span style="color: #0000ff;">this</span>.Version, <span style="color: #0000ff;">this</span>.Description, <span style="color: #0000ff;">this</span>.DataBaseSize); <span style="color: #008000;">//</span><span style="color: #008000;">初始化数据库</span>
<span style="color: #000000;">        },
        addBlob: </span><span style="color: #0000ff;">function</span> (tableName, arr,index,isFirst,callback) {<span style="color: #008000;">//</span><span style="color: #008000;">批量添加字段</span>
            <span style="color: #008000;">/*</span><span style="color: #008000;">
                注 ： 数据里面的第一个key存储类型为BLOB
                @param  tableName 表名
                @param  arr 更新的数据    [{key1：value1 , key2 : value2 ...},{key1：value1 , key2 : value2 ...}]
                @param  index BLOG字段所在的索引位置
                @param  isFirst 是否是第一次创建表
                @param  callback  回调
             </span><span style="color: #008000;">*/</span>
            <span style="color: #0000ff;">if</span> (arr == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
                </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
            }
            callback </span>= <span style="color: #0000ff;">this</span>.isFunction(callback) ? callback : <span style="color: #0000ff;">new</span><span style="color: #000000;"> Function();
            </span><span style="color: #0000ff;">var</span> _me = <span style="color: #0000ff;">this</span><span style="color: #000000;">,
                _db </span>= <span style="color: #0000ff;">this</span><span style="color: #000000;">.database,
                keyC </span>=<span style="color: #000000;"> [],
                keyI </span>=<span style="color: #000000;"> [],
                _key </span>= ''<span style="color: #000000;">;
            arr </span>= arr ||<span style="color: #000000;"> [];
            </span><span style="color: #0000ff;">if</span> (arr &amp;&amp; arr.constructor ==<span style="color: #000000;"> Array) {
                </span><span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> i <span style="color: #0000ff;">in</span> arr[0<span style="color: #000000;">]) {
                    keyC.push(i);
                    keyI.push(i);
                }
                _key </span>= keyI.join(","<span style="color: #000000;">);
                index </span>= index == undefined ? 0<span style="color: #000000;"> : index;
                keyC[index] </span>= keyC[index] + ' BLOB'<span style="color: #000000;">;
                _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx, result) {
                    </span><span style="color: #008000;">//</span><span style="color: #008000;">var csql = 'CREATE TABLE IF NOT EXISTS ' + tableName + ' (' + keyC.join(",") + ')';</span>
                    <span style="color: #008000;">//</span><span style="color: #008000;">console.log('csql:' + csql);</span>
                    <span style="color: #0000ff;">if</span> (isFirst == <span style="color: #0000ff;">true</span><span style="color: #000000;">) {
                        tx.executeSql(</span>'CREATE TABLE IF NOT EXISTS ' + tableName + ' (' + keyC.join(",") + ')'<span style="color: #000000;">);
                    }
                    </span><span style="color: #008000;">//</span><span style="color: #008000;">var sql = "";</span>
                    <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> s = 0, _len = arr.length; s &lt; _len ; s++<span style="color: #000000;">) {
                        </span><span style="color: #0000ff;">var</span> _value =<span style="color: #000000;"> _me.split(arr[s]);
                        </span><span style="color: #008000;">//</span><span style="color: #008000;">sql += 'INSERT INTO ' + tableName + ' (' + _key + ') VALUES (' + _value + ')';</span>
                        <span style="color: #008000;">//</span><span style="color: #008000;">console.log("sql:" + sql);</span>
                        tx.executeSql('INSERT INTO ' + tableName + ' (' + _key + ') VALUES (' + _value + ')',[],<span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx, result) {
                            callback(result.rowsAffected);
                            </span><span style="color: #008000;">//</span><span style="color: #008000;">console.log('添加成功'+result.rowsAffected);</span>
                        },<span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx, error) {
                            console.error(</span>'添加失败'<span style="color: #000000;">);
                            callback(</span><span style="color: #0000ff;">false</span><span style="color: #000000;">);
                        });
                    }
                    _key </span>= keyI = keyC = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
                    callback();
                });
            }
            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
        },
        add: </span><span style="color: #0000ff;">function</span> (tableName, arr, callback, noKey) {<span style="color: #008000;">//</span><span style="color: #008000;">批量添加字段</span>
            <span style="color: #008000;">/*</span><span style="color: #008000;">
                注 ： 数据里面的第一个key 为主键
                @param  tableName 表名
                @param  arr 更新的数据    [{key1：value1 , key2 : value2 ...},{key1：value1 , key2 : value2 ...}]
                @param  callback  回调
                @param  noKey 第一个字段是否是主键（默认是）
             </span><span style="color: #008000;">*/</span>
            <span style="color: #0000ff;">if</span>(arr==<span style="color: #0000ff;">null</span><span style="color: #000000;">){
                </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
            }
            callback </span>= <span style="color: #0000ff;">this</span>.isFunction(callback) ? callback : <span style="color: #0000ff;">new</span><span style="color: #000000;"> Function();
            </span><span style="color: #0000ff;">var</span> _me = <span style="color: #0000ff;">this</span><span style="color: #000000;">,
                _db </span>= <span style="color: #0000ff;">this</span><span style="color: #000000;">.database,
                keyC </span>=<span style="color: #000000;"> [],
                keyI </span>=<span style="color: #000000;"> [],
                _key </span>= ''<span style="color: #000000;">;
            arr </span>= arr ||<span style="color: #000000;"> [];
            </span><span style="color: #0000ff;">if</span> (arr &amp;&amp; arr.constructor ==<span style="color: #000000;"> Array) {
                </span><span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">var</span> i <span style="color: #0000ff;">in</span> arr[0<span style="color: #000000;">]){
                    keyC.push(i);
                    keyI.push(i);
                }
                </span><span style="color: #0000ff;">if</span> (noKey==<span style="color: #000000;">undefined) {
                    keyC[</span>0] = keyC[0] + ' unique'<span style="color: #000000;">;
                }
                _key </span>= keyI.join(","<span style="color: #000000;">);
                _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx) {
                   </span><span style="color: #008000;">//</span><span style="color: #008000;">/var csql = 'CREATE TABLE IF NOT EXISTS ' + tableName + ' (' + keyC.join(",") + ')';</span>
                    <span style="color: #008000;">//</span><span style="color: #008000;"> console.log('csql:' + csql);</span>
                     tx.executeSql('CREATE TABLE IF NOT EXISTS ' + tableName + ' (' + keyC.join(",") + ')'<span style="color: #000000;">);
                    </span><span style="color: #008000;">//</span><span style="color: #008000;">var sql = "";</span>
                    <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">var</span> s = 0 , _len = arr.length; s &lt; _len ; s++<span style="color: #000000;">){
                        </span><span style="color: #0000ff;">var</span> _value =<span style="color: #000000;"> _me.split(arr[s]);
                        </span><span style="color: #008000;">//</span><span style="color: #008000;">sql += 'INSERT INTO ' + tableName + ' (' + _key + ') VALUES (' + _value + ')';</span>
                        <span style="color: #008000;">//</span><span style="color: #008000;">console.log("sql:" + sql);</span>
                        tx.executeSql('INSERT INTO '+tableName+' ('+_key+') VALUES ('+_value+')',[],<span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx, result) {
                            callback(result.rowsAffected);
                            </span><span style="color: #008000;">//</span><span style="color: #008000;">console.log('添加成功'+result.rowsAffected);</span>
                        },<span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx, error) {
                            console.error(</span>'添加失败'<span style="color: #000000;">);
                            callback(</span><span style="color: #0000ff;">false</span><span style="color: #000000;">);
                        });
                    }
                    _key </span>= keyI = keyC = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
                    callback();
                });
            }
            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
        },
        update : </span><span style="color: #0000ff;">function</span>(tableName,key,value,obj,callback){<span style="color: #008000;">//</span><span style="color: #008000;">更新指定数据</span>
            <span style="color: #008000;">/*</span><span style="color: #008000;">
                @param  tableName 表名
                @param  key 查询的键 
                @param  value 对应键的值
                @param  obj 更新的数据    {key1：value1 , key2 : value2 ...} 
                @param  callback  回调  传递参数为真则查询成功 反之更新失败
             </span><span style="color: #008000;">*/</span><span style="color: #000000;">
            callback </span>= <span style="color: #0000ff;">this</span>.isFunction(callback) ? callback : <span style="color: #0000ff;">new</span><span style="color: #000000;"> Function();
            </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database,
                _value </span>= <span style="color: #0000ff;">this</span><span style="color: #000000;">.splitU(obj);
            _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx) {
                </span><span style="color: #008000;">//</span><span style="color: #008000;">console.log('sql:' + 'UPDATE ' + tableName + ' set ' + _value + ' where ' + key + '="' + value + '"')</span>
                tx.executeSql('UPDATE '+tableName+' set '+_value+' where '+key+'="'+value+'"',[],<span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx, result) {
                    callback(result.rowsAffected);
                },</span><span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx, error) {
                    console.error(</span>'更新失败'<span style="color: #000000;">);
                    callback(</span><span style="color: #0000ff;">false</span><span style="color: #000000;">);
                });
            });
            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
        },
        updateWhere: </span><span style="color: #0000ff;">function</span> (tableName, where, obj, callback) {<span style="color: #008000;">//</span><span style="color: #008000;">更新指定数据</span>
            <span style="color: #008000;">/*</span><span style="color: #008000;">
                @param  tableName 表名
                @param  查询条件 
                @param  obj 更新的数据    {key1：value1 , key2 : value2 ...} 
                @param  callback  回调  传递参数为真则查询成功 反之更新失败
             </span><span style="color: #008000;">*/</span><span style="color: #000000;">
            callback </span>= <span style="color: #0000ff;">this</span>.isFunction(callback) ? callback : <span style="color: #0000ff;">new</span><span style="color: #000000;"> Function();
            </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database,
                _value </span>= <span style="color: #0000ff;">this</span><span style="color: #000000;">.splitU(obj);
            _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx) {
                console.log(</span>'UPDATE ' + tableName + ' set ' + _value + ' where ' + where + '"'<span style="color: #000000;">)
                tx.executeSql(</span>'UPDATE ' + tableName + ' set ' + _value + ' where ' + where + '"', [], <span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx, result) {
                    callback(result.rowsAffected);
                }, </span><span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx, error) {
                    console.error(</span>'更新失败'<span style="color: #000000;">);
                    callback(</span><span style="color: #0000ff;">false</span><span style="color: #000000;">);
                });
            });
            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
        },
        read : </span><span style="color: #0000ff;">function</span>(tableName,condition,callback){ <span style="color: #008000;">//</span><span style="color: #008000;">读取表数据</span>
            <span style="color: #008000;">/*</span><span style="color: #008000;">
                @param  tableName 表名
                @param  condition 查询条件   'where name="汪文君"'
                @param  callback  回调  传递参数为真则查询成功 反之查询失败
             </span><span style="color: #008000;">*/</span>
            <span style="color: #0000ff;">var</span> _condition = <span style="color: #0000ff;">this</span>.isString(condition) ? condition : ''<span style="color: #000000;">;
            </span><span style="color: #0000ff;">var</span> _callback = <span style="color: #0000ff;">this</span>.isFunction(condition) ? condition : <span style="color: #0000ff;">this</span>.isFunction(callback) ? callback : <span style="color: #0000ff;">new</span><span style="color: #000000;"> Function;
            </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database,
                _me </span>= <span style="color: #0000ff;">this</span><span style="color: #000000;">,
                _re </span>=<span style="color: #000000;"> [];
                _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx) {
                    tx.executeSql(</span>'SELECT * FROM ' + tableName + ' ' + _condition + ' ', [], <span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx, results) {
                        </span><span style="color: #0000ff;">if</span>(results &amp;&amp;<span style="color: #000000;"> results.rows){
                            _re </span>=<span style="color: #000000;">_me.toArray(results.rows);
                            _callback(_re);
                        }</span><span style="color: #0000ff;">else</span><span style="color: #000000;">{
                            _callback([]);
                        }
                    },</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx,error){
                        _callback([]);
                        console.error(</span>'查询失败'<span style="color: #000000;">);
                    });
                });
                </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
        },
        remove:</span><span style="color: #0000ff;">function</span>(tableName,condition,callback){<span style="color: #008000;">//</span><span style="color: #008000;">删除数据</span>
            <span style="color: #008000;">/*</span><span style="color: #008000;">
                @param  tableName 表名
                @param  condition 查询条件   'where name="汪文君"'
                @param  callback  回调  传递参数为真则删除成功 反之删除失败
             </span><span style="color: #008000;">*/</span>
            <span style="color: #0000ff;">var</span> _me = <span style="color: #0000ff;">this</span><span style="color: #000000;">;
            </span><span style="color: #0000ff;">var</span> _condition = <span style="color: #0000ff;">this</span>.isString(condition) ? condition : ''<span style="color: #000000;">;
            </span><span style="color: #0000ff;">var</span> _callback = <span style="color: #0000ff;">this</span>.isFunction(condition) ? condition : <span style="color: #0000ff;">this</span>.isFunction(callback) ? callback : <span style="color: #0000ff;">new</span><span style="color: #000000;"> Function;
            _me.database.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx) {
                tx.executeSql(</span>'DELETE FROM '+tableName+ ' '+ _condition+' ',[],<span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx, result) {
                    _callback(result.rowsAffected);
                },</span><span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx, error) {
                    _callback(</span><span style="color: #0000ff;">false</span><span style="color: #000000;">);
                    console.error(</span>'删除失败'<span style="color: #000000;">);
                });
            });
        },
        counts: </span><span style="color: #0000ff;">function</span> (tableName, condition, callback) { <span style="color: #008000;">//</span><span style="color: #008000;">读取表数据</span>
            <span style="color: #008000;">/*</span><span style="color: #008000;">
                @param  tableName 表名
                @param  condition 查询条件   'where name="汪文君"'
                @param  callback  回调  传递参数为真则查询成功 反之查询失败
             </span><span style="color: #008000;">*/</span>
            <span style="color: #0000ff;">var</span> _condition = <span style="color: #0000ff;">this</span>.isString(condition) ? condition : ''<span style="color: #000000;">;
            </span><span style="color: #0000ff;">var</span> _callback = <span style="color: #0000ff;">this</span>.isFunction(condition) ? condition : <span style="color: #0000ff;">this</span>.isFunction(callback) ? callback : <span style="color: #0000ff;">new</span><span style="color: #000000;"> Function;
            </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database,
                _me </span>= <span style="color: #0000ff;">this</span><span style="color: #000000;">,
                _re </span>=<span style="color: #000000;"> [];
            </span><span style="color: #0000ff;">if</span> (mui.os.ios) { <span style="color: #008000;">//</span><span style="color: #008000;">ios下面特有的</span>
                _db.transaction(<span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx) {
                    tx.executeSql(</span>'SELECT NO FROM ' + tableName + ' ' + _condition + ' ', [], <span style="color: #0000ff;">function</span> (tx, results) {<span style="color: #008000;">//</span><span style="color: #008000;"> count (*) as num</span>
                        <span style="color: #0000ff;">if</span> (results &amp;&amp;<span style="color: #000000;"> results.rows) {
                            _re </span>=<span style="color: #000000;"> _me.toArray(results.rows);
                            _callback(_re.length);
                        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                            _callback(</span>0<span style="color: #000000;">);
                        }
                    }, </span><span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx, error) {
                        _callback(</span>0<span style="color: #000000;">);
                        console.error(</span>'查询失败'<span style="color: #000000;">);
                    });
                });
            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx) {
                    tx.executeSql(</span>'SELECT count (*) as num FROM ' + tableName + ' ' + _condition + ' ', [], <span style="color: #0000ff;">function</span> (tx, results) {<span style="color: #008000;">//</span><span style="color: #008000;"> count (*) as num</span>
                        <span style="color: #0000ff;">if</span> (results &amp;&amp;<span style="color: #000000;"> results.rows) {
                            </span><span style="color: #0000ff;">if</span> (results.rows[0<span style="color: #000000;">]) {
                                _callback(results.rows[</span>0<span style="color: #000000;">].num);
                            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                                _callback(</span>0<span style="color: #000000;">);
                            }
                        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                            _callback(</span>0<span style="color: #000000;">);
                        }
                    }, </span><span style="color: #0000ff;">function</span><span style="color: #000000;"> (tx, error) {
                        _callback(</span>0<span style="color: #000000;">);
                        console.error(</span>'查询失败'<span style="color: #000000;">);
                    });
                });
            }
            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
        },
        delTable:</span><span style="color: #0000ff;">function</span>(tableName,callback){ <span style="color: #008000;">//</span><span style="color: #008000;">删除数据表</span>
            callback = <span style="color: #0000ff;">this</span>.isFunction(callback) ? callback : <span style="color: #0000ff;">new</span><span style="color: #000000;"> Function();
            </span><span style="color: #0000ff;">this</span>.database.transaction(<span style="color: #0000ff;">function</span><span style="color: #000000;">(tx){
                tx.executeSql(</span>'DROP TABLE IF EXISTS '+tableName,[],<span style="color: #0000ff;">function</span><span style="color: #000000;">(tx,res){
                    callback();
                },</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx,err){
                    console.error(err);
                });
            });
            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
        },
        splitU: </span><span style="color: #0000ff;">function</span>(obj){<span style="color: #008000;">//</span><span style="color: #008000;">更新字符处理</span>
            <span style="color: #0000ff;">var</span> _arr =<span style="color: #000000;"> [];
            </span><span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">var</span> t <span style="color: #0000ff;">in</span><span style="color: #000000;"> obj){
                _arr.push(t</span>+'="'+obj[t]+'"'<span style="color: #000000;">);
            }
            </span><span style="color: #0000ff;">return</span> _arr.join(','<span style="color: #000000;">);
        },
        split : </span><span style="color: #0000ff;">function</span>(obj){<span style="color: #008000;">//</span><span style="color: #008000;">添加字符处理</span>
            <span style="color: #0000ff;">var</span> _arr =<span style="color: #000000;"> [];
            </span><span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">var</span> m <span style="color: #0000ff;">in</span><span style="color: #000000;"> obj){
                _arr.push(</span>"'"+obj[m]+"'"<span style="color: #000000;">);
            }
            </span><span style="color: #0000ff;">return</span> _arr.join(','<span style="color: #000000;">);
        },
        isFunction : </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(callback){
            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">typeof</span> callback != 'undefined' &amp;&amp; callback.constructor == Function ? <span style="color: #0000ff;">true</span> : <span style="color: #0000ff;">false</span><span style="color: #000000;">
        },
        isString : </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(string){
            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">typeof</span> string == 'string' ? <span style="color: #0000ff;">true</span> : <span style="color: #0000ff;">false</span><span style="color: #000000;">
        },
        toArray : </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(obj){
            </span><span style="color: #0000ff;">var</span> _arr =<span style="color: #000000;"> [],
                _len </span>=<span style="color: #000000;"> obj.length;
                </span><span style="color: #0000ff;">if</span>(_len &gt; 0<span style="color: #000000;">){
                    </span><span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> i = 0; i &lt; _len; i++<span style="color: #000000;">) {
                        _arr.push(obj.item(i));
                    };
                }
                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> _arr;
        }
    }
    win.smpWebSql </span>=<span style="color: #000000;"> smpWebSql;
}(window))</span></pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>　　上述代码存在的问题非常明显，由于websql操作都是异步操作，当我们为了获取到websql操作的结果之后再进行后续操作时，往往是通过回调函数来实现的，当回调一多的时候，回调地狱就出现了，为了解决回调地狱问题，我将通过Promise来改写，后续调用时，可以直接通过await和async来调用，或者直接通过Promise链式调用也是可以的。</p>
<p>　　现在我将通过ES6的语法重写之前的封装类，为了应用ES6中js面向对象的思想，我这里用到了class，最终代码如下：</p>
<div class="cnblogs_code">
<pre><code>import { browserVersions } from '@/utils/utils.js'<span style="color: #000000;">;
class SmpWebSql {
  constructor(options) {
    options </span>= options ||<span style="color: #000000;"> {};
    </span><span style="color: #0000ff;">this</span>.database = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
    </span><span style="color: #0000ff;">this</span>.DateBaseName = options.DateBaseName || 'RedDB'<span style="color: #000000;">;
    </span><span style="color: #0000ff;">this</span>.Version = options.Version || '1.0'<span style="color: #000000;">;
    </span><span style="color: #0000ff;">this</span>.Description = options.Description || '智维离线工单数据库'<span style="color: #000000;">;
    </span><span style="color: #0000ff;">this</span>.DataBaseSize = options.DataBaseSize || 2 * 1024 * 1024<span style="color: #000000;">;
    </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.init();
  }
  </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
   * 初始化数据库
   </span><span style="color: #008000;">*/</span><span style="color: #000000;">
  init() {
    </span><span style="color: #0000ff;">this</span>.database =<span style="color: #000000;"> openDatabase(
      </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.DateBaseName,
      </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.Version,
      </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.Description,
      </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.DataBaseSize
    );
  }
  </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
   * 批量添加字段
   * @param {*} tableName 表名
   * @param {*} arr 更新的数据    [{key1：value1 , key2 : value2 ...},{key1：value1 , key2 : value2 ...}]
   * @param {*} index BLOG字段所在的索引位置
   * @param {*} isFirst 是否是第一次创建表
   </span><span style="color: #008000;">*/</span><span style="color: #000000;">
  addBlob(tableName, arr, index, isFirst </span>= <span style="color: #0000ff;">true</span><span style="color: #000000;">) {
    </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database;
    </span><span style="color: #0000ff;">var</span> _me = <span style="color: #0000ff;">this</span><span style="color: #000000;">;
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line promise/param-names</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise(<span style="color: #0000ff;">function</span><span style="color: #000000;">(resovle, reject) {
      </span><span style="color: #0000ff;">if</span> (arr == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
      }
      </span><span style="color: #0000ff;">var</span> keyC =<span style="color: #000000;"> [];
      </span><span style="color: #0000ff;">var</span> keyI =<span style="color: #000000;"> [];
      </span><span style="color: #0000ff;">var</span> _key = ''<span style="color: #000000;">;
      arr </span>= arr ||<span style="color: #000000;"> [];
      </span><span style="color: #0000ff;">if</span> (arr &amp;&amp; arr.constructor ==<span style="color: #000000;"> Array) {
        </span><span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> i <span style="color: #0000ff;">in</span> arr[0<span style="color: #000000;">]) {
          keyC.push(i);
          keyI.push(i);
        }
        keyC[</span>0] = keyC[0] + ' unique'<span style="color: #000000;">;
        _key </span>= keyI.join(','<span style="color: #000000;">);
        index </span>= index == undefined ? 0<span style="color: #000000;"> : index;
        keyC[index] </span>= keyC[index] + ' BLOB'<span style="color: #000000;">;
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line promise/param-names</span>
<span style="color: #000000;">
        _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, result) {
          </span><span style="color: #008000;">//</span><span style="color: #008000;"> var csql = 'CREATE TABLE IF NOT EXISTS ' + tableName + ' (' + keyC.join(",") + ')';</span>
          <span style="color: #008000;">//</span><span style="color: #008000;"> console.log('csql:' + csql);</span>
          <span style="color: #0000ff;">if</span> (isFirst == <span style="color: #0000ff;">true</span><span style="color: #000000;">) {
            tx.executeSql(
              </span>'CREATE TABLE IF NOT EXISTS ' +<span style="color: #000000;">
                tableName </span>+
                ' (' +<span style="color: #000000;">
                keyC.join(</span>',') +
                ')'<span style="color: #000000;">
            );
          }
          </span><span style="color: #008000;">//</span><span style="color: #008000;"> var sql = "";</span>
          <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> s = 0, _len = arr.length; s &lt; _len; s++<span style="color: #000000;">) {
            </span><span style="color: #0000ff;">var</span> _value =<span style="color: #000000;"> _me.split(arr[s]);
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> sql += 'INSERT INTO ' + tableName + ' (' + _key + ') VALUES (' + _value + ')';</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> console.log("sql:" + sql);</span>
<span style="color: #000000;">            tx.executeSql(
              </span>'INSERT INTO ' +<span style="color: #000000;">
                tableName </span>+
                ' (' +<span style="color: #000000;">
                _key </span>+
                ') VALUES (' +<span style="color: #000000;">
                _value </span>+
                ')'<span style="color: #000000;">,
              [],
              </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, result) {
                resovle(result.rowsAffected);
                console.log(</span>'添加成功' +<span style="color: #000000;"> result.rowsAffected);
              },
              </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx) {
                console.error(</span>'添加失败'<span style="color: #000000;">);
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line prefer-promise-reject-errors</span>
                reject(<span style="color: #0000ff;">false</span><span style="color: #000000;">);
              }
            );
          }
          _key </span>= keyI = keyC = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
          resovle(arr.length);
        });
      }
    }).</span><span style="color: #0000ff;">catch</span>(error =&gt;<span style="color: #000000;"> {
      console.log(</span>'error :'<span style="color: #000000;">, error);
    });
  }
  </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
   * 批量添加字段
   * @param {*} tableName 表名
   * @param {*} arr 更新的数据    [{key1：value1 , key2 : value2 ...},{key1：value1 , key2 : value2 ...}]
   * @param {*} index BLOG字段所在的索引位置
   * @param {*} firstKey firstKey 第一个字段是否是主键（默认是）
   * @param {*} isFirst 是否是第一次创建表
   </span><span style="color: #008000;">*/</span><span style="color: #000000;">
  patchAddBlob(tableName, arr, index, firstKey </span>= <span style="color: #0000ff;">true</span>, isFirst = <span style="color: #0000ff;">true</span><span style="color: #000000;">) {
    </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database;
    </span><span style="color: #0000ff;">var</span> _me = <span style="color: #0000ff;">this</span><span style="color: #000000;">;
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line promise/param-names</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise(<span style="color: #0000ff;">function</span><span style="color: #000000;">(resovle, reject) {
      </span><span style="color: #0000ff;">if</span> (arr == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
      }
      </span><span style="color: #0000ff;">var</span> keyC =<span style="color: #000000;"> [];
      </span><span style="color: #0000ff;">var</span> keyI =<span style="color: #000000;"> [];
      </span><span style="color: #0000ff;">var</span> _key = ''<span style="color: #000000;">;
      arr </span>= arr ||<span style="color: #000000;"> [];
      </span><span style="color: #0000ff;">if</span> (arr &amp;&amp; arr.constructor ==<span style="color: #000000;"> Array) {
        </span><span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> i <span style="color: #0000ff;">in</span> arr[0<span style="color: #000000;">]) {
          keyC.push(i);
          keyI.push(i);
        }
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (firstKey) {
          keyC[</span>0] = keyC[0] + ' unique'<span style="color: #000000;">;
        }
        _key </span>= keyI.join(','<span style="color: #000000;">);
        index </span>= index == undefined ? 0<span style="color: #000000;"> : index;
        keyC[index] </span>= keyC[index] + ' text'<span style="color: #000000;">;
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line promise/param-names</span>
<span style="color: #000000;">
        _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, result) {
          </span><span style="color: #008000;">//</span><span style="color: #008000;"> var csql = 'CREATE TABLE IF NOT EXISTS ' + tableName + ' (' + keyC.join(",") + ')';</span>
          <span style="color: #008000;">//</span><span style="color: #008000;"> console.log('csql:' + csql);</span>
          <span style="color: #0000ff;">if</span> (isFirst == <span style="color: #0000ff;">true</span><span style="color: #000000;">) {
            tx.executeSql(
              </span>'CREATE TABLE IF NOT EXISTS ' +<span style="color: #000000;">
                tableName </span>+
                ' (' +<span style="color: #000000;">
                keyC.join(</span>',') +
                ')'<span style="color: #000000;">
            );
          }
          </span><span style="color: #0000ff;">var</span> sql = ''<span style="color: #000000;">;
          </span><span style="color: #0000ff;">var</span> _values =<span style="color: #000000;"> [];
          </span><span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> s = 0, _len = arr.length; s &lt; _len; s++<span style="color: #000000;">) {
            _values.push(</span>'(' + _me.split(arr[s]) + ')'<span style="color: #000000;">);
          }
          sql </span>=
            'INSERT INTO ' +<span style="color: #000000;">
            tableName </span>+
            ' (' +<span style="color: #000000;">
            _key </span>+
            ') VALUES ' +<span style="color: #000000;">
            _values.join(</span>','<span style="color: #000000;">);
          </span><span style="color: #008000;">//</span><span style="color: #008000;"> console.log('sql:' + sql);</span>
<span style="color: #000000;">          tx.executeSql(
            sql,
            [],
            </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, result) {
              resovle(result.rowsAffected);
              </span><span style="color: #008000;">//</span><span style="color: #008000;"> console.log('添加成功'+result.rowsAffected);</span>
<span style="color: #000000;">            },
            </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, error) {
              console.error(</span>'添加失败'<span style="color: #000000;">, tx, error);
              </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line prefer-promise-reject-errors</span>
              reject(<span style="color: #0000ff;">false</span><span style="color: #000000;">);
            }
          );
          _key </span>= keyI = keyC = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
          resovle(arr.length);
        });
      }
    }).</span><span style="color: #0000ff;">catch</span>(error =&gt;<span style="color: #000000;"> {
      console.log(</span>'error :'<span style="color: #000000;">, error);
    });
  }
  </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
   * 批量添加字段 注 ： 数据里面的第一个key 为主键
   * @param {*} tableName 表名
   * @param {*} arr arr 更新的数据    [{key1：value1 , key2 : value2 ...},{key1：value1 , key2 : value2 ...}]
   * @param {*} firstKey firstKey 第一个字段是否是主键（默认是）
   </span><span style="color: #008000;">*/</span><span style="color: #000000;">
  add(tableName, arr, firstKey </span>= <span style="color: #0000ff;">true</span><span style="color: #000000;">) {
    </span><span style="color: #0000ff;">var</span> _me = <span style="color: #0000ff;">this</span><span style="color: #000000;">;
    </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database;
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line promise/param-names</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise(<span style="color: #0000ff;">function</span><span style="color: #000000;">(resovle, reject) {
      </span><span style="color: #0000ff;">if</span> (arr == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
      }
      </span><span style="color: #0000ff;">var</span> keyC =<span style="color: #000000;"> [];
      </span><span style="color: #0000ff;">var</span> keyI =<span style="color: #000000;"> [];
      </span><span style="color: #0000ff;">var</span> _key = ''<span style="color: #000000;">;
      arr </span>= arr ||<span style="color: #000000;"> [];
      </span><span style="color: #0000ff;">if</span> (arr &amp;&amp; arr.constructor ==<span style="color: #000000;"> Array) {
        </span><span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> i <span style="color: #0000ff;">in</span> arr[0<span style="color: #000000;">]) {
          keyC.push(i);
          keyI.push(i);
        }
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (firstKey) {
          keyC[</span>0] = keyC[0] + ' unique'<span style="color: #000000;">;
        }
        _key </span>= keyI.join(','<span style="color: #000000;">);
        _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx) {
          </span><span style="color: #008000;">//</span><span style="color: #008000;"> /var csql = 'CREATE TABLE IF NOT EXISTS ' + tableName + ' (' + keyC.join(",") + ')';</span>
          <span style="color: #008000;">//</span><span style="color: #008000;"> console.log('csql:' + csql);</span>
<span style="color: #000000;">          tx.executeSql(
            </span>'CREATE TABLE IF NOT EXISTS ' +<span style="color: #000000;">
              tableName </span>+
              ' (' +<span style="color: #000000;">
              keyC.join(</span>',') +
              ')'<span style="color: #000000;">
          );
          </span><span style="color: #008000;">//</span><span style="color: #008000;"> var sql = "";</span>
          <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> s = 0, _len = arr.length; s &lt; _len; s++<span style="color: #000000;">) {
            </span><span style="color: #0000ff;">var</span> _value =<span style="color: #000000;"> _me.split(arr[s]);
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> sql += 'INSERT INTO ' + tableName + ' (' + _key + ') VALUES (' + _value + ')';</span>
            <span style="color: #008000;">//</span><span style="color: #008000;"> console.log("sql:" + sql);</span>
<span style="color: #000000;">            tx.executeSql(
              </span>'INSERT INTO ' +<span style="color: #000000;">
                tableName </span>+
                ' (' +<span style="color: #000000;">
                _key </span>+
                ') VALUES (' +<span style="color: #000000;">
                _value </span>+
                ')'<span style="color: #000000;">,
              [],
              </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, result) {
                resovle(result.rowsAffected);
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> console.log('添加成功'+result.rowsAffected);</span>
<span style="color: #000000;">              },
              </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, error) {
                console.error(</span>'添加失败'<span style="color: #000000;">, error);
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line prefer-promise-reject-errors</span>
                reject(<span style="color: #0000ff;">false</span><span style="color: #000000;">);
              }
            );
          }
          _key </span>= keyI = keyC = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
          resovle(arr.length);
        });
      }
    }).</span><span style="color: #0000ff;">catch</span>(error =&gt;<span style="color: #000000;"> {
      console.log(</span>'error :'<span style="color: #000000;">, error);
    });
  }
  </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
   * 批量添加行记录 注 ： 数据里面的第一个key 为主键
   * @param {*} tableName 表名
   * @param {*} arr arr 更新的数据    [{key1：value1 , key2 : value2 ...},{key1：value1 , key2 : value2 ...}]
   * @param {*} firstKey firstKey 第一个字段是否是主键（默认是）
   </span><span style="color: #008000;">*/</span><span style="color: #000000;">
  patchAdd(tableName, arr, firstKey </span>= <span style="color: #0000ff;">true</span><span style="color: #000000;">) {
    </span><span style="color: #0000ff;">var</span> _me = <span style="color: #0000ff;">this</span><span style="color: #000000;">;
    </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database;
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line promise/param-names</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise(<span style="color: #0000ff;">function</span><span style="color: #000000;">(resovle, reject) {
      </span><span style="color: #0000ff;">if</span> (arr == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
      }
      </span><span style="color: #0000ff;">var</span> keyC =<span style="color: #000000;"> [];
      </span><span style="color: #0000ff;">var</span> keyI =<span style="color: #000000;"> [];
      </span><span style="color: #0000ff;">var</span> _key = ''<span style="color: #000000;">;
      arr </span>= arr ||<span style="color: #000000;"> [];
      </span><span style="color: #0000ff;">if</span> (arr &amp;&amp; arr.constructor ==<span style="color: #000000;"> Array) {
        </span><span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> i <span style="color: #0000ff;">in</span> arr[0<span style="color: #000000;">]) {
          keyC.push(i);
          keyI.push(i);
        }
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (firstKey) {
          keyC[</span>0] = keyC[0] + ' unique'<span style="color: #000000;">;
        }
        _key </span>= keyI.join(','<span style="color: #000000;">);
        _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx) {
          </span><span style="color: #008000;">//</span><span style="color: #008000;"> /var csql = 'CREATE TABLE IF NOT EXISTS ' + tableName + ' (' + keyC.join(",") + ')';</span>
          <span style="color: #008000;">//</span><span style="color: #008000;"> console.log('csql:' + csql);</span>
<span style="color: #000000;">          tx.executeSql(
            </span>'CREATE TABLE IF NOT EXISTS ' +<span style="color: #000000;">
              tableName </span>+
              ' (' +<span style="color: #000000;">
              keyC.join(</span>',') +
              ')'<span style="color: #000000;">
          );
          </span><span style="color: #0000ff;">var</span> sql = ''<span style="color: #000000;">;
          </span><span style="color: #0000ff;">var</span> _values =<span style="color: #000000;"> [];
          </span><span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> s = 0, _len = arr.length; s &lt; _len; s++<span style="color: #000000;">) {
            _values.push(</span>'(' + _me.split(arr[s]) + ')'<span style="color: #000000;">);
          }
          sql </span>=
            'INSERT INTO ' +<span style="color: #000000;">
            tableName </span>+
            ' (' +<span style="color: #000000;">
            _key </span>+
            ') VALUES ' +<span style="color: #000000;">
            _values.join(</span>','<span style="color: #000000;">);
          console.log(</span>'sql:' +<span style="color: #000000;"> sql);

          tx.executeSql(
            sql,
            [],
            </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, result) {
              resovle(result.rowsAffected);
              </span><span style="color: #008000;">//</span><span style="color: #008000;"> console.log('添加成功'+result.rowsAffected);</span>
<span style="color: #000000;">            },
            </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, error) {
              console.error(</span>'添加失败'<span style="color: #000000;">);
              </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line prefer-promise-reject-errors</span>
              reject(<span style="color: #0000ff;">false</span><span style="color: #000000;">);
            }
          );
          _key </span>= keyI = keyC = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
          resovle(arr.length);
        });
      }
    }).</span><span style="color: #0000ff;">catch</span>(error =&gt;<span style="color: #000000;"> {
      console.log(</span>'error :'<span style="color: #000000;">, error);
    });
  }
  </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
   * 更新指定数据
   * @param {*} tableName 表名
   * @param {*} key 查询的键
   * @param {*} value 对应键的值
   * @param {*} obj obj 更新的数据    {key1：value1 , key2 : value2 ...}
   </span><span style="color: #008000;">*/</span><span style="color: #000000;">
  update(tableName, key, value, obj) {
    </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database;
    </span><span style="color: #0000ff;">var</span> _value = <span style="color: #0000ff;">this</span><span style="color: #000000;">.splitU(obj);
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line promise/param-names</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise(<span style="color: #0000ff;">function</span><span style="color: #000000;">(resovle, reject) {
      _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx) {
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> console.log('sql:' + 'UPDATE ' + tableName + ' set ' + _value + ' where ' + key + '="' + value + '"')</span>
<span style="color: #000000;">        tx.executeSql(
          </span>'UPDATE ' +<span style="color: #000000;">
            tableName </span>+
            ' set ' +<span style="color: #000000;">
            _value </span>+
            ' where ' +<span style="color: #000000;">
            key </span>+
            '="' +<span style="color: #000000;">
            value </span>+
            '"'<span style="color: #000000;">,
          [],
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, result) {
            resovle(result.rowsAffected);
          },
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, error) {
            console.error(</span>'更新失败'<span style="color: #000000;">);
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line prefer-promise-reject-errors</span>
            reject(<span style="color: #0000ff;">false</span><span style="color: #000000;">);
          }
        );
      });
    }).</span><span style="color: #0000ff;">catch</span>(error =&gt;<span style="color: #000000;"> {
      console.log(</span>'error :'<span style="color: #000000;">, error);
    });
  }
  </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
   * 更新指定数据
   * @param {*} tableName 表名
   * @param {*} condition 查询条件
   * @param {*} obj obj 更新的数据    {key1：value1 , key2 : value2 ...}
   </span><span style="color: #008000;">*/</span><span style="color: #000000;">
  updateWhere(tableName, condition, obj) {
    </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database;
    </span><span style="color: #0000ff;">var</span> _value = <span style="color: #0000ff;">this</span><span style="color: #000000;">.splitU(obj);
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line promise/param-names</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise(<span style="color: #0000ff;">function</span><span style="color: #000000;">(resovle, reject) {
      _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx) {
        console.log(</span>'UPDATE ' + tableName + ' set ' + _value + ' ' +<span style="color: #000000;"> condition);
        tx.executeSql(
          </span>'UPDATE ' + tableName + ' set ' + _value + +' ' +<span style="color: #000000;"> condition,
          [],
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, result) {
            resovle(result.rowsAffected);
          },
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, error) {
            console.error(</span>'更新失败'<span style="color: #000000;">, error);
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line prefer-promise-reject-errors</span>
            reject(<span style="color: #0000ff;">false</span><span style="color: #000000;">);
          }
        );
      });
    }).</span><span style="color: #0000ff;">catch</span>(error =&gt;<span style="color: #000000;"> {
      console.log(</span>'error :'<span style="color: #000000;">, error);
    });
  }
  </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
   * 读取表数据
   * @param {*} tableName 表名
   * @param {*} condition 查询条件   'where name="jiekzou"'
   </span><span style="color: #008000;">*/</span><span style="color: #000000;">
  read(tableName, condition) {
    </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database;
    </span><span style="color: #0000ff;">var</span> _me = <span style="color: #0000ff;">this</span><span style="color: #000000;">;
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line promise/param-names</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise(<span style="color: #0000ff;">function</span><span style="color: #000000;">(resovle, reject) {
      </span><span style="color: #0000ff;">var</span> _condition = _me.isString(condition) ? condition : ''<span style="color: #000000;">;
      </span><span style="color: #0000ff;">var</span> _re =<span style="color: #000000;"> [];
      _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx) {
        tx.executeSql(
          </span>'SELECT * FROM ' + tableName + ' ' + _condition + ' '<span style="color: #000000;">,
          [],
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, results) {
            </span><span style="color: #0000ff;">if</span> (results &amp;&amp;<span style="color: #000000;"> results.rows) {
              _re </span>=<span style="color: #000000;"> _me.toArray(results.rows);
              resovle(_re);
            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
              resovle([]);
            }
          },
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, error) {
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line prefer-promise-reject-errors</span>
<span style="color: #000000;">            reject([]);
            console.error(</span>'查询失败'<span style="color: #000000;">, error);
          }
        );
      });
    }).</span><span style="color: #0000ff;">catch</span>(error =&gt;<span style="color: #000000;"> {
      console.log(</span>'error :'<span style="color: #000000;">, error);
    });
  }
  </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
   * 读取表数据
   * @param {*} tableName 表名
   * @param {*} field 查询字段，逗号隔开
   * @param {*} condition 查询条件   'where name="jiekzou"'
   </span><span style="color: #008000;">*/</span><span style="color: #000000;">
  readField(tableName, field </span>= '*'<span style="color: #000000;">, condition) {
    </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database;
    </span><span style="color: #0000ff;">var</span> _me = <span style="color: #0000ff;">this</span><span style="color: #000000;">;
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line promise/param-names</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise(<span style="color: #0000ff;">function</span><span style="color: #000000;">(resovle, reject) {
      </span><span style="color: #0000ff;">var</span> _condition = _me.isString(condition) ? condition : ''<span style="color: #000000;">;
      </span><span style="color: #0000ff;">var</span> _re =<span style="color: #000000;"> [];
      _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx) {
        tx.executeSql(
          </span>'SELECT ' + field + ' FROM ' + tableName + ' ' + _condition + ' '<span style="color: #000000;">,
          [],
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, results) {
            </span><span style="color: #0000ff;">if</span> (results &amp;&amp;<span style="color: #000000;"> results.rows) {
              _re </span>=<span style="color: #000000;"> _me.toArray(results.rows);
              resovle(_re);
            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
              resovle([]);
            }
          },
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, error) {
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line prefer-promise-reject-errors</span>
<span style="color: #000000;">            reject([]);
            console.error(</span>'查询失败'<span style="color: #000000;">);
          }
        );
      });
    }).</span><span style="color: #0000ff;">catch</span>(error =&gt;<span style="color: #000000;"> {
      console.log(</span>'error :'<span style="color: #000000;">, error);
    });
  }
  </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
   * 删除数据
   * @param {*} tableName 表名
   * @param {*} condition 查询条件   'where name="jiekzou"'
   </span><span style="color: #008000;">*/</span><span style="color: #000000;">
  remove(tableName, condition) {
    </span><span style="color: #0000ff;">var</span> _me = <span style="color: #0000ff;">this</span><span style="color: #000000;">;
    </span><span style="color: #0000ff;">var</span> _condition = _me.isString(condition) ? condition : ''<span style="color: #000000;">;
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line promise/param-names</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise(<span style="color: #0000ff;">function</span><span style="color: #000000;">(resovle, reject) {
      _me.database.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx) {
        tx.executeSql(
          </span>'DELETE FROM ' + tableName + ' ' + _condition + ' '<span style="color: #000000;">,
          [],
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, result) {
            resovle(result.rowsAffected);
          },
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, error) {
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line prefer-promise-reject-errors</span>
            reject(<span style="color: #0000ff;">false</span><span style="color: #000000;">);
            console.error(</span>'删除失败'<span style="color: #000000;">);
          }
        );
      });
    }).</span><span style="color: #0000ff;">catch</span>(error =&gt;<span style="color: #000000;"> {
      console.log(</span>'error :'<span style="color: #000000;">, error);
    });
  }
  </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
   * 根据查询条件读取表记录数
   * @param {*} tableName 表名
   * @param {*} condition 查询条件   'where name="jiekzou"'
   </span><span style="color: #008000;">*/</span><span style="color: #000000;">
  counts(tableName, condition) {
    </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
      </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (browserVersions.android) {
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">.androidCounts(tableName, condition);
      } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">.iosCounts(tableName, condition);
      }
    } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> {
      </span><span style="color: #0000ff;">return</span> 0<span style="color: #000000;">;
    }
  }
  </span><span style="color: #008000;">//</span><span style="color: #008000;"> ios下面特有的</span>
  <span style="color: #008000;">/*</span><span style="color: #008000;">*
   * 读取表数据(ios下面特有的)
   * @param {*} tableName 表名
   * @param {*} condition  查询条件   'where name="jiekzou"'
   </span><span style="color: #008000;">*/</span><span style="color: #000000;">
  iosCounts(tableName, condition) {
    </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database;
    </span><span style="color: #0000ff;">var</span> _me = <span style="color: #0000ff;">this</span><span style="color: #000000;">;
    </span><span style="color: #0000ff;">var</span> _condition = _me.isString(condition) ? condition : ''<span style="color: #000000;">;
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line promise/param-names</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise(<span style="color: #0000ff;">function</span><span style="color: #000000;">(resovle, reject) {
      </span><span style="color: #0000ff;">var</span> _re =<span style="color: #000000;"> [];
      _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx) {
        tx.executeSql(
          </span>'SELECT 1 FROM ' + tableName + ' ' + _condition + ' '<span style="color: #000000;">,
          [],
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, results) {
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> count (*) as num</span>
            <span style="color: #0000ff;">if</span> (results &amp;&amp;<span style="color: #000000;"> results.rows) {
              _re </span>=<span style="color: #000000;"> _me.toArray(results.rows);
              resovle(_re.length);
            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
              resovle(</span>0<span style="color: #000000;">);
            }
          },
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, error) {
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line prefer-promise-reject-errors</span>
            reject(0<span style="color: #000000;">);
            console.error(</span>'查询失败'<span style="color: #000000;">, error);
          }
        );
      });
    }).</span><span style="color: #0000ff;">catch</span>(e =&gt;<span style="color: #000000;"> {
      console.log(</span>'e :'<span style="color: #000000;">, e);
      </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line no-undef</span>
      <span style="color: #008000;">//</span><span style="color: #008000;"> reject(0);</span>
<span style="color: #000000;">    });
  }
  </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
   * 读取表数据（Android）
   * @param {*} tableName 表名
   * @param {*} condition 查询条件   'where name="jiekzou"'
   </span><span style="color: #008000;">*/</span><span style="color: #000000;">
  androidCounts(tableName, condition) {
    </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database;
    </span><span style="color: #0000ff;">var</span> _me = <span style="color: #0000ff;">this</span><span style="color: #000000;">;
    </span><span style="color: #0000ff;">var</span> _condition = _me.isString(condition) ? condition : ''<span style="color: #000000;">;
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line promise/param-names</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise(<span style="color: #0000ff;">function</span><span style="color: #000000;">(resovle, reject) {
      </span><span style="color: #0000ff;">var</span> _re =<span style="color: #000000;"> [];
      _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx) {
        tx.executeSql(
          </span>'SELECT count (*) as num FROM ' + tableName + ' ' + _condition + ' '<span style="color: #000000;">,
          [],
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, results) {
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> count (*) as num</span>
            <span style="color: #0000ff;">if</span> (results &amp;&amp;<span style="color: #000000;"> results.rows) {
              </span><span style="color: #0000ff;">if</span> (results.rows[0<span style="color: #000000;">]) {
                resovle(results.rows[</span>0<span style="color: #000000;">].num);
              } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                resovle(</span>0<span style="color: #000000;">);
              }
            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
              resovle(</span>0<span style="color: #000000;">);
            }
          },
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, error) {
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line prefer-promise-reject-errors</span>
            reject(0<span style="color: #000000;">);
            console.error(</span>'查询失败'<span style="color: #000000;">);
          }
        );
      });
    }).</span><span style="color: #0000ff;">catch</span>(e =&gt;<span style="color: #000000;"> {
      console.log(</span>'e :'<span style="color: #000000;">, e);
      </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line no-undef</span>
      <span style="color: #008000;">//</span><span style="color: #008000;"> reject(0);</span>
<span style="color: #000000;">    });
  }
  </span><span style="color: #008000;">/*</span><span style="color: #008000;">*
   * 删除数据表
   * @param {*} tableName 表名
   </span><span style="color: #008000;">*/</span><span style="color: #000000;">
  delTable(tableName) {
    </span><span style="color: #0000ff;">var</span> _db = <span style="color: #0000ff;">this</span><span style="color: #000000;">.database;
    console.log(</span>'_db :'<span style="color: #000000;">, _db);
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line promise/param-names</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise(<span style="color: #0000ff;">function</span><span style="color: #000000;">(resovle, reject) {
      _db.transaction(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx) {
        tx.executeSql(
          </span>'DROP TABLE IF EXISTS ' +<span style="color: #000000;"> tableName,
          [],
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, res) {
            resovle(</span>1<span style="color: #000000;">);
          },
          </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(tx, err) {
            console.error(err);
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> eslint-disable-next-line prefer-promise-reject-errors</span>
            reject(0<span style="color: #000000;">);
          }
        );
      });
    });
  }
  </span><span style="color: #008000;">//</span><span style="color: #008000;"> 更新字符处理</span>
<span style="color: #000000;">  splitU(obj) {
    </span><span style="color: #0000ff;">var</span> _arr =<span style="color: #000000;"> [];
    </span><span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> t <span style="color: #0000ff;">in</span><span style="color: #000000;"> obj) {
      _arr.push(t </span>+ '=\'' + obj[t] + '\''<span style="color: #000000;">);
    }
    </span><span style="color: #0000ff;">return</span> _arr.join(','<span style="color: #000000;">);
  }
  </span><span style="color: #008000;">//</span><span style="color: #008000;"> 添加字符处理</span>
<span style="color: #000000;">  split(obj) {
    </span><span style="color: #0000ff;">var</span> _arr =<span style="color: #000000;"> [];
    </span><span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> m <span style="color: #0000ff;">in</span><span style="color: #000000;"> obj) {
      _arr.push(</span>'\'' + obj[m] + '\''<span style="color: #000000;">);
    }
    </span><span style="color: #0000ff;">return</span> _arr.join(','<span style="color: #000000;">);
  }
  isFunction(callback) {
    </span><span style="color: #0000ff;">return</span> !!<span style="color: #000000;">(
      </span><span style="color: #0000ff;">typeof</span> callback != 'undefined' &amp;&amp; callback.constructor ==<span style="color: #000000;"> Function
    );
  }
  isString(string) {
    </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">typeof</span> string == 'string'<span style="color: #000000;">;
  }
  toArray(obj) {
    </span><span style="color: #0000ff;">var</span> _arr =<span style="color: #000000;"> [];
    </span><span style="color: #0000ff;">var</span> _len =<span style="color: #000000;"> obj.length;
    </span><span style="color: #0000ff;">if</span> (_len &gt; 0<span style="color: #000000;">) {
      </span><span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">var</span> i = 0; i &lt; _len; i++<span style="color: #000000;">) {
        _arr.push(obj.item(i));
      }
    }
    </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> _arr;
  }
}

export </span><span style="color: #0000ff;">default</span> SmpWebSql;</pre>
</div>
<p>&nbsp;</p>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>