<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修一文了解H5照片上传过程' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>一文了解H5照片上传过程</center></div><div class='banquan'>原文出处:本文由博客园博主JoeJoan提供。<br/>
原文连接:https://www.cnblogs.com/Joe-and-Joan/p/10977887.html</div><br>
    <p>&nbsp;</p>
<h3><strong>一、选择拍照或文件</strong></h3>
<p>HTML：</p>
<p>使用<code>&lt;input&gt;</code>标签，</p>
<p><code>type</code>设为<code>"file"</code>选择文件，</p>
<p><code>a</code><code>ccept</code>设为<code>"image/*"</code>选择文件为图片类型和相机拍摄，</p>
<p>设置<code>multiple</code>支持多选。</p>
<div class="cnblogs_code">
<pre><code><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">div </span><span style="color: #ff0000;">class</span><span style="color: #0000ff;">="add-image"</span><span style="color: #0000ff;">&gt;</span>
          <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">input </span><span style="color: #ff0000;">class</span><span style="color: #0000ff;">="file"</span><span style="color: #ff0000;"> type</span><span style="color: #0000ff;">="file"</span><span style="color: #ff0000;"> accept</span><span style="color: #0000ff;">="image/*"</span><span style="color: #ff0000;"> multiple @change</span><span style="color: #0000ff;">="onFileChange"</span><span style="color: #0000ff;">&gt;</span>
          <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">div </span><span style="color: #ff0000;">class</span><span style="color: #0000ff;">="add"</span> <span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">img </span><span style="color: #ff0000;">src</span><span style="color: #0000ff;">="../../assets/add/icon_addphoto.png"</span><span style="color: #ff0000;"> alt</span><span style="color: #0000ff;">&gt;</span>
            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">p</span><span style="color: #0000ff;">&gt;</span>添加照片<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">p</span><span style="color: #0000ff;">&gt;</span>
          <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span></pre>
</div>
<p>样式：</p>
<p>设置opacity为0，使用自定义div覆盖于上面</p>
<div class="cnblogs_code">
<pre><code><span style="color: #800000;">.add-image</span>{<span style="color: #ff0000;">
      width</span>:<span style="color: #0000ff;"> 148px</span>;<span style="color: #ff0000;">
      height</span>:<span style="color: #0000ff;"> 148px</span>;<span style="color: #ff0000;">
      position</span>:<span style="color: #0000ff;"> relative</span>;<br /><span style="color: #ff0000;">
      .file{
        position</span>:<span style="color: #0000ff;"> absolute</span>;<span style="color: #ff0000;">
        top</span>:<span style="color: #0000ff;"> 0</span>;<span style="color: #ff0000;">
        left</span>:<span style="color: #0000ff;"> 0</span>;<span style="color: #ff0000;">
        width</span>:<span style="color: #0000ff;"> 148px</span>;<span style="color: #ff0000;">
        height</span>:<span style="color: #0000ff;"> 148px</span>;<span style="color: #ff0000;">
        opacity</span>:<span style="color: #0000ff;"> 0</span>;
      }</pre>
</div>
<p>效果：</p>
<p><img src="./images/一文了解H5照片上传过程0.png" alt="" /></p>
<h3>二、图片预览</h3>
<p>VUE数据驱动更新前端所展示图片</p>
<p>两种方式：</p>
<p>1、使用本地URL（如果项目需要整理服务器图片地址作为表单提交，则本地URL不可以使用，操作删除不便）</p>
<p><code>URL.createObjectURL</code>方法可创建一个本地的 URL 路径指向本地资源对象，下面使用该接口创建所选图片的地址并展示。</p>
<div class="cnblogs_code">
<pre><code>let url=<span style="color: #000000;">window.URL.createObjectURL(file)
</span><span style="color: #0000ff;">this</span>.goods.goodsImageList.push(url)</pre>
</div>
<p>2、使用服务器返回路径（缺点：如果上传失败就无法显示）</p>
<p>上传图片请求成功后，服务器返回一个url，使用该url进行字符串拼接，然后加入goods.goodsImageList数组。</p>
<p><img src="./images/一文了解H5照片上传过程1.png" alt="" /></p>
<h3>三、图片旋转</h3>
<div>
<div>通过相机拍摄的图片，由于拍摄时手持相机的方向问题，导致拍摄的图片可能存在旋转，需要进行纠正。纠正旋转需要知道图片的旋转信息，这里借助了一个叫 <a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2Fexif-js%2Fexif-js" rel="nofollow noopener noreferrer" target="_blank">exif-js</a> 的库，该库可以读取图片的 EXIF 元数据，其中包括拍摄时相机的方向，根据这个方向可以推算出图片的旋转信息。</div>
<div>下面是 EXIF 旋转标志位，总共有 8 种，但是通过相机拍摄时只能产生1、3、6、8 四种，分别对应相机正常、顺时针旋转180&deg;、逆时针旋转90&deg;、顺时针旋转90&deg;时所拍摄的照片。</div>
<div><img src="./images/一文了解H5照片上传过程2.png" alt="" />
<p>纠正图片旋转角度，只要读取图片的 EXIF 旋转标志位，判断旋转角度，在画布上对图片进行旋转后，重新导出新的图片即可。</p>
<div class="cnblogs_code">
<pre><code><span style="color: #008000;">/*</span><span style="color: #008000;">*
 * 修正图片旋转角度问题
 * @param {file} 原图片
 * @return {Promise} resolved promise 返回纠正后的新图片
 </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">function</span><span style="color: #000000;"> fixImageOrientation (file) {
  </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise((resolve, reject) =&gt;<span style="color: #000000;"> {
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> 获取图片</span>
    const img = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Image();
    img.src </span>=<span style="color: #000000;"> window.URL.createObjectURL(file);
    img.onerror </span>= () =&gt;<span style="color: #000000;"> resolve(file);
    img.onload </span>= () =&gt;<span style="color: #000000;"> {
      </span><span style="color: #008000;">//</span><span style="color: #008000;"> 获取图片元数据（EXIF 变量是引入的 exif-js 库暴露的全局变量）</span>
      EXIF.getData(img, <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 获取图片旋转标志位</span>
        <span style="color: #0000ff;">var</span> orientation = EXIF.getTag(<span style="color: #0000ff;">this</span>, "Orientation"<span style="color: #000000;">);
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 根据旋转角度，在画布上对图片进行旋转</span>
        <span style="color: #0000ff;">if</span> (orientation === 3 || orientation === 6 || orientation === 8<span style="color: #000000;">) {
          const canvas </span>= document.createElement("canvas"<span style="color: #000000;">);
          const ctx </span>= canvas.getContext("2d"<span style="color: #000000;">);
          </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (orientation) {
            </span><span style="color: #0000ff;">case</span> 3: <span style="color: #008000;">//</span><span style="color: #008000;"> 旋转180&deg;</span>
              canvas.width =<span style="color: #000000;"> img.width;
              canvas.height </span>=<span style="color: #000000;"> img.height;
              ctx.rotate((</span>180 * Math.PI) / 180<span style="color: #000000;">);
              ctx.drawImage(img, </span>-img.width, -<span style="color: #000000;">img.height, img.width, img.height);
              </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;
            </span><span style="color: #0000ff;">case</span> 6: <span style="color: #008000;">//</span><span style="color: #008000;"> 旋转90&deg;</span>
              canvas.width =<span style="color: #000000;"> img.height;
              canvas.height </span>=<span style="color: #000000;"> img.width;
              ctx.rotate((</span>90 * Math.PI) / 180<span style="color: #000000;">);
              ctx.drawImage(img, </span>0, -<span style="color: #000000;">img.height, img.width, img.height);
              </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;
            </span><span style="color: #0000ff;">case</span> 8: <span style="color: #008000;">//</span><span style="color: #008000;"> 旋转-90&deg;</span>
              canvas.width =<span style="color: #000000;"> img.height;
              canvas.height </span>=<span style="color: #000000;"> img.width;
              ctx.rotate((</span>-90 * Math.PI) / 180<span style="color: #000000;">);
              ctx.drawImage(img, </span>-img.width, 0<span style="color: #000000;">, img.width, img.height);
              </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;
          }
          </span><span style="color: #008000;">//</span><span style="color: #008000;"> 返回新图片</span>
          canvas.toBlob(file =&gt; resolve(file), 'image/jpeg', 0.92<span style="color: #000000;">)
        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
          </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> resolve(file);
        }
      });
    };
  });
}</span></pre>
</div>
<h3>四、图片压缩</h3>
<p>现在手机拍照质量越来越高，拍出来的照片多达几M甚至十几M，直接上传原图不合理，容易上传失败，且后台对请求体大小有限制，后续加载图片展示也会变得慢，所以要求我们前端在上传之前进行图片的压缩。</p>
<p>下面函数实现了对图片的压缩，原理是在画布上绘制缩放后的图片，最终从画布导出压缩后的图片。方法中有两处可以对图片进行压缩控制：一处是控制图片的缩放比；另一处是控制导出图片的质量。</p>
<div class="cnblogs_code">
<pre><code><span style="color: #008000;">//</span><span style="color: #008000;"> 压缩图片</span>
<span style="color: #000000;">        compressImage(file) {
            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise((resolve, reject) =&gt;<span style="color: #000000;"> {
                const img </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Image();
                img.src </span>=<span style="color: #000000;"> window.URL.createObjectURL(file);
                img.onerror </span>= error =&gt;<span style="color: #000000;"> reject(error);
                img.onload </span>= () =&gt;<span style="color: #000000;"> {
                    const canvas </span>= document.createElement('canvas'<span style="color: #000000;">);
                    const ctx </span>= canvas.getContext('2d'<span style="color: #000000;">);
                    canvas.width </span>= Math.min(img.width, 200<span style="color: #000000;">);//控制图片大小
                    const radio </span>= canvas.width /<span style="color: #000000;"> img.width; 
                    canvas.height </span>= img.height *<span style="color: #000000;"> radio;  //等比缩放
                    ctx.drawImage(img, </span>0, 0<span style="color: #000000;">, canvas.width, canvas.height);
                    const quality </span>= 0.8<span style="color: #000000;">; //控制输出图片质量
                    canvas.toBlob(file </span>=&gt;<span style="color: #000000;"> {
                        let files </span>= <span style="color: #0000ff;">new</span> window.File([file], 'file.jpg'<span style="color: #000000;">, { type: file.type });
                        resolve(files);
                    }, </span>'image/jpeg'<span style="color: #000000;">, quality);
                };
            });
        },</span></pre>
</div>
<p>这里有个要注意的点，toBlob之后是一个Blob对象，但是请求要求传入file文件，所以我们要将blob对象转为file</p>
<div class="cnblogs_code">
<pre><code>    let files = <span style="color: #0000ff;">new</span> window.File([<span style="color: #0000ff;">this</span>.blob], file.name, {type: file.type})</pre>
</div>
<h3>五、图片上传</h3>
<p>通过<code>FormData</code>创建表单数据，发起 ajax&nbsp;<code>POST</code>请求即可，下面函数实现了上传文件。</p>
<div class="cnblogs_code">
<pre><code><span style="color: #008000;">//</span><span style="color: #008000;"> 上传图片</span>
<span style="color: #000000;">        uploadFile(file) {
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> request({
                method: </span>'post'<span style="color: #000000;">,
                postType: </span>'file'<span style="color: #000000;">,
                url: </span>'//...域名.../upload/comments'<span style="color: #000000;">,
                data: {
                    file: file
                }
            });
        },</span></pre>
</div>
<div class="cnblogs_code">
<pre><code>export <span style="color: #0000ff;">function</span><span style="color: #000000;"> formData(obj) {
    let formData </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> FormData();

    Object.keys(obj).forEach(key </span>=&gt;<span style="color: #000000;"> {
        let val </span>=<span style="color: #000000;"> obj[key];
        val </span>= val == <span style="color: #0000ff;">null</span> ? ''<span style="color: #000000;"> : val;
        </span><span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">typeof</span> val === 'object'<span style="color: #000000;">) {
            </span><span style="color: #0000ff;">if</span> (val <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> window.File) {
                formData.append(key, val);
            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                formData.append(key, JSON.stringify(val));
            }
        } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
            formData.append(key, val);
        }
    });
    </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> formData;
}</span></pre>
</div>
<div class="cnblogs_code">
<pre><code>export <span style="color: #0000ff;">function</span><span style="color: #000000;"> request(options) {
    </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Promise((resolve, reject) =&gt;<span style="color: #000000;"> {
        let {
            method,
            url,
            data,
            params,
            headers </span>=<span style="color: #000000;"> {},
            withCredentials </span>= <span style="color: #0000ff;">false</span><span style="color: #000000;">,
            </span><span style="color: #008000;">//</span><span style="color: #008000;"> file || ''</span>
            postType = ''<span style="color: #000000;">
        } </span>=<span style="color: #000000;"> options;

        const xhr </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> XMLHttpRequest();
        let sendData </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;
        method </span>= (method || 'GET'<span style="color: #000000;">).toUpperCase();

        const urlParse </span>= /\?/.test(url) ?<span style="color: #000000;"> parseString(url) : {};
        const querys </span>= { timestamp: Math.round(<span style="color: #0000ff;">new</span> Date() / 1000<span style="color: #000000;">), app_id: values.app_id, ...urlParse, ...params };

        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 验签</span>
        let keys =<span style="color: #000000;"> Object.keys(querys);
        keys.push(</span>'app_secret'<span style="color: #000000;">);
        const api_sign </span>= sha1(keys.sort().map(key =&gt; querys[key] || values[key]).join(''<span style="color: #000000;">));

        </span><span style="color: #008000;">//</span><span style="color: #008000;"> console.log('api_sign', api_sign);</span>
<span style="color: #000000;">
        headers.api_sign </span>=<span style="color: #000000;"> api_sign;

        url </span>+=<span style="color: #000000;">
        (</span>/\?/.test(url) ? '&amp;' : '?') +<span style="color: #000000;">
        Object.keys(querys)
            .map(key </span>=&gt; `${key}=<span style="color: #000000;">${escape(querys[key])}`)
            .join(</span>'&amp;'<span style="color: #000000;">);

        xhr.open(method, url, </span><span style="color: #0000ff;">true</span><span style="color: #000000;">);

        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 处理sendData</span>
        <span style="color: #008000;">//</span><span style="color: #008000;"> postType file</span>
        <span style="color: #0000ff;">if</span> (method === 'POST'<span style="color: #000000;">) {
            </span><span style="color: #0000ff;">if</span> (postType === 'file'<span style="color: #000000;">) {
                sendData </span>= data ? formData(data) : <span style="color: #0000ff;">null</span><span style="color: #000000;">;
            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                headers[</span>'Content-Type'] = headers['Content-Type'] || 'application/json;charset=UTF-8'<span style="color: #000000;">;
                sendData </span>= data ? JSON.stringify(data) : <span style="color: #0000ff;">null</span><span style="color: #000000;">;
            }
        }

        Object.keys(headers).forEach(key </span>=&gt;<span style="color: #000000;"> {
            xhr.setRequestHeader(key, headers[key]);
        });

        xhr.onreadystatechange </span>= <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
            </span><span style="color: #0000ff;">if</span> (xhr.readyState === 4 &amp;&amp; xhr.status === 200<span style="color: #000000;">) {
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> options.success(xhr.responseText);</span>
                let response =<span style="color: #000000;"> {
                    status: xhr.status,
                    data: {}
                };
                </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
                    response.data </span>=<span style="color: #000000;"> JSON.parse(xhr.responseText);
                } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (e) {
                    console.warn(</span>'request error:'<span style="color: #000000;">, e);
                }

                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (response) {
                    resolve(response);
                } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                    reject(</span><span style="color: #0000ff;">new</span> Error('cancel by response interceptor'<span style="color: #000000;">));
                }
            }
        };
        xhr.onerror </span>=<span style="color: #000000;"> reject;

        </span><span style="color: #008000;">//</span><span style="color: #008000;"> withCredentials默认为true</span>
        xhr.withCredentials =<span style="color: #000000;"> withCredentials;

        </span><span style="color: #008000;">//</span><span style="color: #008000;"> console.log(url, headers, sendData);</span>
<span style="color: #000000;">        xhr.send(sendData);
    });
}</span></pre>
</div>
<h3>&nbsp;六、合并上传</h3>
<div class="cnblogs_code">
<pre><code><span style="color: #000000;">onFileChange(e) {
            const files </span>=<span style="color: #000000;"> Array.prototype.slice.call(e.target.files);
            files.forEach(file </span>=&gt;<span style="color: #000000;"> {
                </span><span style="color: #008000;">//</span><span style="color: #008000;"> 本地预览</span>
                <span style="color: #008000;">//</span><span style="color: #008000;"> let url=window.URL.createObjectURL(file)</span>
                <span style="color: #008000;">//</span><span style="color: #008000;"> this.photo.push(url)</span>
                <span style="color: #0000ff;">this</span><span style="color: #000000;">.compressImage(file)
                    .then(file </span>=&gt;<span style="color: #000000;"> {
                        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">.uploadFile(file);
                    }).then(data </span>=&gt;<span style="color: #000000;"> {
                        let goodsImage </span>=<span style="color: #000000;"> data.data.data;
                        </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.goods.goodsImageList.push(goodsImage);
                        console.log(</span>'上传成功'<span style="color: #000000;">);
                        </span><span style="color: #008000;">//</span><span style="color: #008000;"> console.log(this.goods.goodsImageList);</span>
                    }).<span style="color: #0000ff;">catch</span>(error =&gt;<span style="color: #000000;"> {
                        console.log(</span>'上传失败'<span style="color: #000000;">);
                    });
            });
        },</span></pre>
</div>
<h3>最终效果：</h3>
<p><img src="./images/一文了解H5照片上传过程3.png" alt="" /></p>
<p>&nbsp;</p>
</div>
</div>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>