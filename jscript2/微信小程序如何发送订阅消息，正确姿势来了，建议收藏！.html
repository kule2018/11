<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修微信小程序如何发送订阅消息，正确姿势来了，建议收藏！' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>微信小程序如何发送订阅消息，正确姿势来了，建议收藏！</center></div><div class='banquan'>原文出处:本文由博客园博主我是玖柒后提供。<br/>
原文连接:https://www.cnblogs.com/msunh/p/11762573.html</div><br>
    <p>小程序订阅消息公测已经有些日子，今天以世界上最好的语言（PHP）为例，说一下如何发送订阅消息。</p>
<h1>1、<strong>订阅消息</strong></h1>
<p>其实如果用过模板消息的话，改用订阅消息挺简单的，看一下官方文档稍加摸索就能使用。</p>
<p>但是对于那些第一次用的萌新来说，可能会遇到各种各样的坑，所以我会具体的说一下实现的过程，有经验的可以直接翻到文章底部查看 Demo。</p>
<p>虽然如此，但是更详细的参数描述还是需要去看官方文档，传送门：</p>
<p>https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html</p>
<h1>2、<strong>准备工作</strong></h1>
<p>首先是要获取<strong>template_id</strong>，也就是模板 ID。</p>
<p>这个在小程序后台的公共模板库找到适用的模板选用，之后到我的模板中复制系统分配的模板 ID即可。如果没找到合适的，就需要自己申请模板，3 - 7 天审核期。</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="图像" data-cke-widget-id="7">
<p class="cke_widget_element" data-cke-widget-data="{&amp;quot;hasCaption&amp;quot;:false,&amp;quot;src&amp;quot;:&amp;quot;./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！0.png&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;width&amp;quot;:&amp;quot;668&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;202&amp;quot;,&amp;quot;lock&amp;quot;:true,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="image"><span class="cke_image_resizer_wrapper"><img class="has" style="display: block; margin-left: auto; margin-right: auto;" src="./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！0.png" alt="" width="668" height="202" data-cke-saved-src="./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！0.png" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></p>
<span class="cke_reset cke_widget_drag_handler_container"><img class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /></span></div>
<p>然后就是小程序的<strong>&nbsp;AppId 和 AppSecret</strong>，获取方式在小程序后台的开发功能中找到开发设置，保存 ID 和秘钥。</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="图像" data-cke-widget-id="6">
<p class="cke_widget_element" data-cke-widget-data="{&amp;quot;hasCaption&amp;quot;:false,&amp;quot;src&amp;quot;:&amp;quot;./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！2.png&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;width&amp;quot;:&amp;quot;472&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;373&amp;quot;,&amp;quot;lock&amp;quot;:true,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="image"><span class="cke_image_resizer_wrapper"><img class="has" style="display: block; margin-left: auto; margin-right: auto;" src="./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！2.png" alt="" width="472" height="373" data-cke-saved-src="./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！2.png" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></p>
<span class="cke_reset cke_widget_drag_handler_container"><img class="cke_reset cke_widget_drag_handler" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /></span></div>
<p>这里需要注意的是AppSecret只有在第一次生成的时候会显示，之后不再明文显示，这个需要开发者自己保存好，如果泄露或者忘记密匙重置即可。</p>
<p>至于 openid 的获取这里就不做具体说明了。</p>
<h1>3、<strong>授权接收</strong></h1>
<p>发送前需要接受者授权接收该类订阅消息，否则订阅消息是无法下发，代码很简单，调用官方的订阅接口：</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_codeSnippet cke_widget_wrapper_has cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="代码段" data-cke-widget-id="5">
<div class="cnblogs_Highlighter">
<pre><code>wx.requestSubscribeMessage({
  tmplIds: ['template_id'], // 此处可填写多个模板 ID，但低版本微信不兼容只能授权一个
  success (res) {
    console.log('已授权接收订阅消息')
  }
})</pre>
<img class="cke_reset cke_widget_drag_handler" style="background-color: #ffffff; font-family: 'PingFang SC', 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px;" title="点击并拖拽以移动" src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="" width="15" height="15" data-cke-widget-drag-handler="1" /></div>
</div>
<p>拉起的授权框是这样的，但是截止发文之前，开发者工具是无法调用接口，只能在真机上运行，无奈。</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="图像" data-cke-widget-id="4">
<p class="cke_widget_element" data-cke-widget-data="{&amp;quot;hasCaption&amp;quot;:false,&amp;quot;src&amp;quot;:&amp;quot;./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！5.png&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;width&amp;quot;:&amp;quot;343&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;283&amp;quot;,&amp;quot;lock&amp;quot;:true,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="image"><span class="cke_image_resizer_wrapper"><img class="has" style="display: block; margin-left: auto; margin-right: auto;" src="./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！5.png" alt="" width="343" height="283" data-cke-saved-src="./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！5.png" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></p>
</div>
<h1>4、<strong>下发订阅消息</strong></h1>
<p>下发消息调用<strong>subscribeMessage.send</strong>&nbsp;，分为云调用和 https 调用，云调用比较简单，免去了 access_token 的获取：</p>
<div class="cnblogs_Highlighter">
<pre><code>const cloud = require('wx-server-sdk')
cloud.init()
exports.main = async (event, context) =&gt; {
  try {
    const result = await cloud.openapi.subscribeMessage.send({
        touser: 'OPENID',
        page: 'index',
        data: {
          name3: {
            value: '我是玖柒后'
          },
          thing4: {
            value: 'Hello World!'
          },
          phrase1: {
            value: "发送成功！"
          },
          date5: {
            value: "发送成功！"
          },
          thing2: {
            value: "1024 身体健康！"
          }
        },
        templateId: 'TEMPLATE_ID'
      })
    console.log(result)
    return result
  } catch (err) {
    console.log(err)
    return err
  }
}
</pre>
</div>
<p>然后在服务器端发起请求，请求地址：</p>
<p>https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=token</p>
<p>在这之前先获取小程序全局唯一后台接口调用凭据（access_token），这就用到了之前保存的 AppId 和 AppSecret。</p>
<div class="cnblogs_Highlighter">
<pre><code>// 小程序 appID 和 appSecret 获取 token
function getAccessToken($appid, $appsecret)
{
  $url = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=' . $appid . '&amp;secret=' . $appsecret;
  $html = file_get_contents($url);
  $output = json_decode($html, true);
  $access_token = $output['access_token'];
  return $access_token;
}
</pre>
</div>
<p>虽然看起来稍微有点复杂，但其实也只要向服务器发送一个请求就可以了，获取和调用都由服务器处理，收到的消息和模板消息差不多。</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="图像" data-cke-widget-id="1">
<p class="cke_widget_element" data-cke-widget-data="{&amp;quot;hasCaption&amp;quot;:false,&amp;quot;src&amp;quot;:&amp;quot;./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！6.png&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;width&amp;quot;:&amp;quot;212&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;220&amp;quot;,&amp;quot;lock&amp;quot;:true,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="image"><span class="cke_image_resizer_wrapper"><img class="has" style="display: block; margin-left: auto; margin-right: auto;" src="./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！6.png" alt="" width="212" height="220" data-cke-saved-src="./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！6.png" /></span></p>
</div>
<p>PHP 订阅消息完整的 API 模板关注公众号，后台回复「<strong>订阅消息</strong>」获取。</p>
<div class="cke_widget_wrapper cke_widget_block cke_widget_image cke_image_nocaption cke_widget_selected" data-cke-widget-wrapper="1" data-cke-filter="off" data-cke-display-name="图像" data-cke-widget-id="0">
<p class="cke_widget_element" data-cke-widget-data="{&amp;quot;hasCaption&amp;quot;:false,&amp;quot;src&amp;quot;:&amp;quot;./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！7.png&amp;quot;,&amp;quot;alt&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;width&amp;quot;:&amp;quot;408&amp;quot;,&amp;quot;height&amp;quot;:&amp;quot;157&amp;quot;,&amp;quot;lock&amp;quot;:true,&amp;quot;align&amp;quot;:&amp;quot;center&amp;quot;,&amp;quot;classes&amp;quot;:{&amp;quot;has&amp;quot;:1}}" data-cke-widget-upcasted="1" data-cke-widget-keep-attr="0" data-widget="image"><span class="cke_image_resizer_wrapper"><img class="has" style="display: block; margin-left: auto; margin-right: auto;" src="./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！7.png" alt="" width="408" height="157" data-cke-saved-src="./images/微信小程序如何发送订阅消息，正确姿势来了，建议收藏！7.png" /><span class="cke_image_resizer" title="点击并拖拽以改变尺寸">​</span></span></p>
</div>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>